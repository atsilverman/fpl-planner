<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FPL Fixture Difficulty Analyzer 2025/26</title>

    <style>

        /* Safari-specific fixes and browser compatibility */
        @supports (-webkit-appearance: none) {
            /* Safari-specific fixes */
            body {
                -webkit-font-smoothing: antialiased;
                -moz-osx-font-smoothing: grayscale;
            }
            
            /* Fix for Safari backdrop-filter issues */
            .container {
                -webkit-backdrop-filter: blur(10px);
                backdrop-filter: blur(10px);
            }
            
            /* Fix for Safari flexbox issues */
            .view-controls,
            .filter-controls,
            .filter-row,
            .filter-columns {
                -webkit-box-align: center;
                -webkit-box-pack: center;
            }
            
            /* Fix for Safari sticky positioning */
            .sticky-header {
                position: -webkit-sticky;
                position: sticky;
            }
        }

        /* Chrome-specific fixes */
        @supports (-webkit-appearance: none) and (not (-webkit-appearance: none)) {
            /* Chrome-specific styles if needed */
        }

        /* Firefox-specific fixes */
        @supports (-moz-appearance: none) {
            /* Firefox-specific styles if needed */
        }

        /* Progressive enhancement for backdrop-filter */
        @supports (backdrop-filter: blur(10px)) {
            .container {
                backdrop-filter: blur(10px);
            }
        }

        @supports not (backdrop-filter: blur(10px)) {
            .container {
                background: rgba(255, 255, 255, 0.95);
            }
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* Color scheme variables */
        :root {
            --primary-color: #3C6E96;
            --primary-hover: #2D5A7A;
            --secondary-color: #E3E9F1;
            --secondary-hover: #CBD5E1;
            --button-color: #3C6E96;
            --button-hover: #2D5A7A;
            --shadow-color: rgba(60, 110, 150, 0.25);
            --shadow-hover: rgba(60, 110, 150, 0.35);
            --table-header-bg: rgba(226, 232, 240, 0.95);
            --table-header-hover: rgba(243, 244, 246, 0.8);
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #F8FAFC 0%, #F1F5F9 100%);
            min-height: 100vh;
            padding: clamp(8px, 2vw, 24px);
            color: #142634;
            line-height: 1.6;
            font-size: clamp(14px, 2vw, 16px);
            overflow-x: hidden;
        }
        
        /* Global overflow prevention */
        * {
            box-sizing: border-box;
        }
        
        /* Prevent text overflow in all elements */
        .container,
        .header,
        .view-controls,
        .filter-controls,
        .table-container,
        .modal-content {
            overflow-x: hidden;
        }

        .container {
            max-width: clamp(320px, 95vw, 1400px);
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.98);
            border-radius: clamp(12px, 3vw, 24px);
            overflow: hidden;
            box-shadow: 
                0 20px 40px rgba(71, 85, 105, 0.08),
                0 8px 16px rgba(71, 85, 105, 0.04),
                inset 0 1px 0 rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
        }

        .header {
            background: var(--primary-color);
            color: white;
            padding: clamp(20px, 4vw, 40px) clamp(16px, 3vw, 32px);
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .header h1 {
            font-size: clamp(1.5rem, 5vw, 2.5rem);
            font-weight: 700;
            margin-bottom: clamp(8px, 2vw, 12px);
            position: relative;
            z-index: 1;
            letter-spacing: -0.025em;
        }

        .header p {
            font-size: clamp(0.9rem, 2.5vw, 1.1rem);
            opacity: 0.9;
            font-weight: 400;
            position: relative;
            z-index: 1;
        }

        .view-controls {
            padding: clamp(8px, 2vw, 16px) clamp(16px, 3vw, 32px) 8px clamp(16px, 3vw, 32px);
            display: flex;
            flex-direction: column;
            gap: clamp(8px, 2vw, 16px);
        }
        
        .controls-container {
            padding: 8px 30px;
            max-width: 100%;
        }
        
        .controls-top-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: clamp(8px, 2vw, 16px);
        }

        /* Search Bar and Filter Button Styles */
        .search-filter-container {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-left: auto;
        }

        .search-container {
            position: relative;
            display: flex;
            align-items: center;
        }

        .search-input {
            padding: clamp(10px, 2vw, 12px) clamp(30px, 4vw, 40px) clamp(10px, 2vw, 12px) clamp(12px, 2vw, 16px);
            border: 2px solid rgba(203, 213, 225, 0.6);
            border-radius: 12px;
            font-size: clamp(14px, 2.2vw, 16px);
            font-weight: 500;
            background: rgba(255, 255, 255, 0.98);
            color: #334155;
            width: clamp(250px, 30vw, 300px);
            min-height: 44px;
            transition: all 0.3s ease;
            box-shadow: 
                0 2px 8px rgba(0, 0, 0, 0.08),
                0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .search-input:focus {
            outline: none;
            border-color: #3C6E96;
            box-shadow: 
                0 0 0 3px rgba(60, 110, 150, 0.15),
                0 4px 12px rgba(0, 0, 0, 0.12),
                0 2px 6px rgba(0, 0, 0, 0.15);
            transform: translateY(-2px);
        }

        .search-input::placeholder {
            color: #9CA3AF;
            font-weight: 400;
        }

        .search-icon {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            width: 16px;
            height: 16px;
            background-image: url("data:image/svg+xml,%3Csvg width='24' height='24' viewBox='0 0 24 24' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath fill-rule='evenodd' clip-rule='evenodd' d='M12 3.5C7.95763 3.5 4.68066 6.77697 4.68066 10.8193C4.68066 14.8617 7.95763 18.1386 12 18.1386C16.0423 18.1386 19.3193 14.8617 19.3193 10.8193C19.3193 6.77697 16.0423 3.5 12 3.5ZM3.18066 10.8193C3.18066 5.94854 7.1292 2 12 2C16.8707 2 20.8193 5.94854 20.8193 10.8193C20.8193 13.5062 19.6177 15.9125 17.7225 17.5301L20.2719 20.7877C20.5272 21.1139 20.4697 21.5853 20.1435 21.8405C19.8173 22.0958 19.3459 22.0383 19.0907 21.7121L16.5021 18.4045C15.1842 19.1884 13.6447 19.6386 12 19.6386C7.1292 19.6386 3.18066 15.6901 3.18066 10.8193Z' fill='%239CA3AF'/%3E%3C/svg%3E");
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            pointer-events: none;
        }

        @media (max-width: 768px) {
            .view-controls {
                justify-content: center;
                flex-direction: column;
                gap: 12px;
            }
            
            .controls-top-row {
                flex-direction: column;
                align-items: center;
                gap: 12px;
            }
            
            .search-filter-container {
                margin-left: 0;
                width: 100%;
                max-width: 400px;
                justify-content: center;
                flex-wrap: wrap;
                gap: 8px;
            }
            
            .search-container {
                width: 100%;
                max-width: 250px;
            }
            
            .search-input {
                width: 100%;
                font-size: 16px; /* Prevent zoom on iOS */
                min-height: 48px;
            }
            
            .btn-customize,
            .btn-reset-header,
            .btn-compare {
                min-height: 48px;
                font-size: 16px;
                padding: 12px 16px;
            }
            
            .view-toggle {
                min-height: 48px;
            }
            
            .toggle-btn {
                min-height: 48px;
                font-size: 16px;
                padding: 12px 20px;
            }
            
            /* Improve filter layout on mobile */
            .filter-columns {
                flex-direction: column;
                gap: 16px;
            }
            
            .filter-column {
                width: 100%;
            }
            
            .filter-section {
                margin-bottom: 16px;
            }
            
            .display-description {
                font-size: 9px !important;
                color: #1e40af !important;
                font-style: italic !important;
                margin-top: 2px !important;
                margin-left: 8px !important;
                opacity: 0.8 !important;
                font-weight: normal !important;
                line-height: 1.2 !important;
            }
            
            .filter-btn {
                min-height: 44px;
                font-size: 14px;
                padding: 8px 12px;
            }
            
            /* Improve table responsiveness */
            .table-container {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            .player-table,
            .team-table {
                min-width: 600px;
                font-size: 14px;
            }
            
            .player-table th,
            .player-table td,
            .team-table th,
            .team-table td {
                padding: 8px 6px;
                font-size: 14px;
                white-space: nowrap;
            }
            
            .fixture {
                min-height: 32px;
                font-size: 12px;
                padding: 4px 6px;
            }
            
            /* Prevent overlapping on mobile */
            .fixture-cell {
                min-width: 55px;
                max-width: 65px;
                overflow: hidden;
            }
            
            .fixture div {
                font-size: 11px;
                line-height: 1.0;
                max-width: 100%;
                overflow: hidden;
                text-overflow: ellipsis;
            }
            
            .team-badge {
                width: 20px;
                height: 20px;
            }
            
            .badge-cell {
                width: 42px;
                padding: 6px 2px 6px 6px;
            }
            
            /* Improve modal responsiveness */
            .modal-content {
                width: 95%;
                max-width: 500px;
                margin: 10px auto;
                max-height: 90vh;
                overflow-y: auto;
            }
            
            /* Improve pagination */
            .pagination-container {
                flex-direction: column;
                gap: 12px;
                align-items: center;
            }
            
            .pagination-controls {
                flex-wrap: wrap;
                justify-content: center;
                gap: 8px;
            }
            
            .page-number {
                min-height: 44px;
                font-size: 14px;
                padding: 8px 12px;
            }
        }

        .filter-controls {
            padding: clamp(16px, 3vw, 24px) clamp(8px, 2vw, 16px);
            background: rgba(248, 250, 252, 0.7);
            border-bottom: 1px solid rgba(203, 213, 225, 0.3);
            backdrop-filter: blur(8px);
            display: flex;
            justify-content: center;
            align-items: center;
            gap: clamp(8px, 2vw, 16px);
            flex-wrap: wrap;
        }

        .filter-button-container {
            flex-shrink: 0;
        }
        
        #customize-btn {
            padding: 10px 16px !important;
            font-size: 14px !important;
            background: #E2E8F0 !important;
            color: #64748B !important;
            border: 1px solid #CBD5E1 !important;
            border-radius: 8px !important;
            transition: all 0.2s ease !important;
            width: auto !important;
            min-width: 100px !important;
            height: 44px !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            gap: 8px !important;
            flex-shrink: 0 !important;
        }

        .filter-icon {
            width: 20px;
            height: 20px;
            background-image: url("data:image/svg+xml,%3Csvg width='24' height='24' viewBox='0 0 24 24' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath fill-rule='evenodd' clip-rule='evenodd' d='M8.2753 4.07867C7.09317 4.07867 6.13487 5.03698 6.13487 6.2191C6.13487 7.40123 7.09317 8.35953 8.2753 8.35953C9.45742 8.35953 10.4157 7.40123 10.4157 6.2191C10.4157 5.03698 9.45742 4.07867 8.2753 4.07867ZM4.71221 5.4691C5.05793 3.81837 6.52184 2.57867 8.2753 2.57867C10.0288 2.57867 11.4927 3.81837 11.8384 5.4691H21.25C21.6642 5.4691 22 5.80489 22 6.2191C22 6.63332 21.6642 6.9691 21.25 6.9691H11.8384C11.4927 8.61984 10.0288 9.85953 8.2753 9.85953C6.52184 9.85953 5.05793 8.61984 4.71221 6.9691H2.75001C2.3358 6.9691 2.00001 6.63332 2.00001 6.2191C2.00001 5.80489 2.3358 5.4691 2.75001 5.4691L4.71221 5.4691ZM15.7247 9.85954C14.5426 9.85954 13.5843 10.8178 13.5843 12C13.5843 13.1821 14.5426 14.1404 15.7247 14.1404C16.9068 14.1404 17.8651 13.1821 17.8651 12C17.8651 10.8178 16.9068 9.85954 15.7247 9.85954ZM12.1616 11.25C12.5073 9.59923 13.9712 8.35954 15.7247 8.35954C17.4782 8.35954 18.9421 9.59923 19.2878 11.25H21.25C21.6642 11.25 22 11.5858 22 12C22 12.4142 21.6642 12.75 21.25 12.75H19.2878C18.9421 14.4007 17.4782 15.6404 15.7247 15.6404C13.9712 15.6404 12.5073 14.4007 12.1616 12.75H2.75C2.33579 12.75 2 12.4142 2 12C2 11.5858 2.33579 11.25 2.75 11.25H12.1616ZM8.2753 15.6404C7.09317 15.6404 6.13487 16.5987 6.13487 17.7808C6.13487 18.9629 7.09317 19.9213 8.2753 19.9213C9.45742 19.9213 10.4157 18.9629 10.4157 17.7808C10.4157 16.5987 9.45742 15.6404 8.2753 15.6404ZM4.71221 17.0308C5.05793 15.3801 6.52184 14.1404 8.2753 14.1404C10.0288 14.1404 11.4927 15.3801 11.8384 17.0308H21.2499C21.6641 17.0308 21.9999 17.3666 21.9999 17.7808C21.9999 18.195 21.6641 18.5308 21.2499 18.5308H11.8384C11.4927 20.1816 10.0288 21.4213 8.2753 21.4213C6.52184 21.4213 5.05793 20.1816 4.71221 18.5308H2.75001C2.33579 18.5308 2.00001 18.195 2.00001 17.7808C2.00001 17.3666 2.33579 17.0308 2.75001 17.0308H4.71221Z' fill='%2364748B'/%3E%3C/svg%3E");
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
        }

        .filter-icon.close {
            background-image: url("data:image/svg+xml,%3Csvg width='24' height='24' viewBox='0 0 24 24' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath fill-rule='evenodd' clip-rule='evenodd' d='M5.46967 5.46967C5.76256 5.17678 6.23744 5.17678 6.53033 5.46967L12 10.9393L17.4697 5.46967C17.7626 5.17678 18.2374 5.17678 18.5303 5.46967C18.8232 5.76256 18.8232 6.23744 18.5303 6.53033L13.0607 12L18.5303 17.4697C18.8232 17.7626 18.8232 18.2374 18.5303 18.5303C18.2374 18.8232 17.7626 18.8232 17.4697 18.5303L12 13.0607L6.53033 18.5303C6.23744 18.8232 5.76256 18.8232 5.46967 18.5303C5.17678 18.2374 5.17678 17.7626 5.46967 17.4697L10.9393 12L5.46967 6.53033C5.17678 6.23744 5.17678 5.76256 5.46967 5.46967Z' fill='%2364748B'/%3E%3C/svg%3E");
        }
        
        .filter-text {
            font-weight: 500;
            color: #64748B;
            white-space: nowrap;
        }
        
        #customize-btn:hover {
            background: #CBD5E1;
            color: #475569;
            border-color: #94A3B8;
        }
        
        #customize-btn:hover {
            background: #CBD5E1;
            color: #475569;
            border-color: #94A3B8;
        }

        .btn-reset {
            background: #f59e0b;
            color: white;
            border: 1px solid #d97706;
            padding: 12px 24px;
            font-size: 14px;
            font-weight: 600;
            min-width: 100px;
            height: 48px;
        }

        .btn-reset:hover {
            background: #d97706;
            border-color: #b45309;
            transform: translateY(-2px);
            box-shadow: 
                0 8px 20px rgba(245, 158, 11, 0.35),
                inset 0 1px 0 rgba(255, 255, 255, 0.3);
        }

        .btn-close {
            background: #ef4444;
            color: white;
            border: 1px solid #dc2626;
        }

        .btn-close:hover {
            background: #dc2626;
            border-color: #b91c1c;
        }

        /* Add spacing between Reset and Close buttons */
        .btn-reset + .btn-close {
            margin-left: 16px;
        }

        /* Add more space between filters and buttons */
        .btn-reset {
            margin-left: 32px;
        }
        
        .btn-reset-header {
            background: #f59e0b;
            color: white;
            border: 1px solid #d97706;
            padding: 8px 16px;
            font-size: 14px;
            font-weight: 600;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-left: 8px;
            margin-right: 8px;
        }
        
        .btn-reset-header:hover {
            background: #d97706;
            border-color: #b45309;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
        }
        
        .btn-compare {
            background: #8b5cf6;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: background-color 0.2s;
            margin-left: 8px;
        }
        
        .btn-compare:hover {
            background: #7c3aed;
        }
        
        .btn-compare.active {
            background: #5b21b6;
        }

        .view-toggle-container {
            display: flex;
            justify-content: center;
            align-items: center;
        }
        


        .view-toggle {
            position: relative;
            display: flex;
            background: rgba(241, 245, 249, 0.8);
            border: 2px solid rgba(203, 213, 225, 0.6);
            border-radius: 16px;
            padding: 4px;
            gap: 0;
            transition: all 0.3s ease;
            box-shadow: 
                0 2px 8px rgba(0, 0, 0, 0.08),
                0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .toggle-slider {
            position: absolute;
            top: 4px;
            left: 4px;
            width: calc(50% - 4px);
            height: calc(100% - 8px);
            background: var(--primary-color);
            border-radius: 12px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 
                0 2px 8px rgba(60, 110, 150, 0.25),
                0 1px 3px rgba(60, 110, 150, 0.15);
            z-index: 1;
        }

        .toggle-slider.teams {
            transform: translateX(100%);
        }

        .toggle-btn {
            position: relative;
            z-index: 2;
            padding: clamp(8px, 2vw, 12px) clamp(20px, 4vw, 32px);
            font-size: clamp(14px, 2.5vw, 16px);
            font-weight: 600;
            border: none;
            border-radius: 12px;
            background: transparent;
            color: #64748B;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: clamp(80px, 20vw, 120px);
            min-height: 44px;
            text-align: center;
            letter-spacing: 0.025em;
            height: clamp(44px, 6vw, 48px);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .toggle-btn:hover {
            color: #475569;
        }

        .toggle-btn.active {
            color: white;
        }

        .view-toggle:hover {
            border-color: rgba(203, 213, 225, 0.8);
            box-shadow: 
                0 4px 12px rgba(0, 0, 0, 0.12),
                0 2px 6px rgba(0, 0, 0, 0.15);
        }



        .team-stats-filter {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .team-stats-buttons {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .team-stat-btn {
            padding: clamp(6px, 1.5vw, 8px) clamp(12px, 2.5vw, 16px);
            font-size: clamp(12px, 2.2vw, 14px);
            font-weight: 600;
            border: 2px solid #E2E8F0;
            border-radius: 8px;
            background: #F8FAFC;
            color: #64748B;
            cursor: pointer;
            transition: all 0.2s ease;
            min-width: clamp(45px, 12vw, 60px);
            min-height: 44px;
            text-align: center;
        }

        .team-stat-btn:hover {
            background: #E2E8F0;
            color: #475569;
            border-color: #CBD5E1;
        }

        .team-stat-btn.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
            box-shadow: 0 2px 8px var(--shadow-color);
        }

        .team-stat-btn.active:hover {
            background: var(--primary-hover);
            border-color: var(--primary-hover);
        }

        /* Team Badge Styles */
.team-badge {
    width: 28px;
    height: 28px;
    border-radius: 6px;
    vertical-align: middle;
    display: block;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.badge-cell {
    width: 44px;
    text-align: center;
    padding: 8px 4px;
        }

        .filters-container {
            padding: 20px;
            background: rgba(248, 250, 252, 0.9);
            border: 1px solid rgba(203, 213, 225, 0.4);
            border-radius: 12px;
            display: none;
            opacity: 0;
            transition: opacity 0.3s ease;
            margin-top: 16px;
            width: 100%;
        }

        .filters-container.expanded {
            display: block;
            opacity: 1;
        }

        .color-scale {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 32px;
            background: rgba(248, 250, 252, 0.8);
            border-bottom: 1px solid rgba(203, 213, 225, 0.3);
        }

        .difficulty-legend-container {
            position: relative;
            display: flex;
            align-items: center;
        }

        .search-filter-container {
            position: relative;
        }



        .info-button {
            background: none;
            border: none;
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
        }

        .info-button:hover {
            background: rgba(60, 110, 150, 0.1);
        }

        .info-icon {
            font-size: 1.2rem;
            font-weight: bold;
            color: #64748B;
            font-style: italic;
        }

        .info-button-container {
            position: relative;
        }

        .difficulty-legend-container {
            position: absolute;
            z-index: 1000;
        }

        .difficulty-section {
            display: flex;
            flex-direction: column;
            gap: 12px;
            position: absolute;
            background: rgba(255, 255, 255, 0.98);
            border: 1px solid rgba(203, 213, 225, 0.4);
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            z-index: 9999;
            min-width: 700px;
            max-width: 800px;
            top: 100%;
            left: 0;
            margin-top: 8px;
            /* Ensure popup stays within viewport */
            max-width: calc(100vw - 40px);
            max-height: calc(100vh - 40px);
            overflow: auto;
        }

        .difficulty-section::before {
            content: '';
            position: absolute;
            top: var(--arrow-top, -8px);
            bottom: var(--arrow-bottom, auto);
            left: var(--arrow-left, 20px);
            right: var(--arrow-right, auto);
            width: 0;
            height: 0;
            border-left: 8px solid transparent;
            border-right: 8px solid transparent;
            border-bottom: 8px solid rgba(255, 255, 255, 0.98);
            border-top: 8px solid transparent;
            z-index: 1000;
        }

        .difficulty-section::after {
            content: '';
            position: absolute;
            top: var(--arrow-top-after, -9px);
            bottom: var(--arrow-bottom-after, auto);
            left: var(--arrow-left, 20px);
            right: var(--arrow-right, auto);
            width: 0;
            height: 0;
            border-left: 8px solid transparent;
            border-right: 8px solid transparent;
            border-bottom: 8px solid rgba(203, 213, 225, 0.4);
            border-top: 8px solid transparent;
            z-index: 999;
        }
        


        .close-legend-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            background: none;
            border: none;
            font-size: 20px;
            color: #64748B;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: background-color 0.2s;
        }

        .close-legend-btn:hover {
            background: rgba(100, 116, 139, 0.1);
        }

        /* Mobile responsiveness for the legend */
        @media (max-width: 768px) {
            .difficulty-section {
                min-width: 90vw;
                max-width: 90vw;
                left: 50% !important;
                transform: translateX(-50%) !important;
                margin-top: 8px;
                right: auto !important;
            }

            .difficulty-section::before,
            .difficulty-section::after {
                left: 50% !important;
                transform: translateX(-50%);
                right: auto !important;
            }
        }

        /* Static Difficulty Legend Styles */
        .difficulty-legend-static {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
            margin-top: 20px;
            padding: 16px;
            background: rgba(255, 255, 255, 0.98);
            border: 1px solid rgba(203, 213, 225, 0.4);
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .difficulty-legend-static .color-scale-row {
            display: flex;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap;
            gap: 16px;
        }

        .difficulty-legend-static .color-scale-label {
            font-weight: 600;
            color: #374151;
            margin-right: 8px;
        }

        .difficulty-legend-static .color-scale-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .difficulty-legend-static .color-scale-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: 1px solid;
        }

        .difficulty-legend-static .difficulty-note {
            text-align: center;
            color: #6B7280;
            font-size: 0.875rem;
        }

        /* Mobile responsiveness for static legend */
        @media (max-width: 768px) {
            .difficulty-legend-static {
                margin: 16px 8px;
                padding: 12px;
            }

            .difficulty-legend-static .color-scale-row {
                gap: 12px;
                flex-direction: column;
                align-items: center;
            }

            .difficulty-legend-static .color-scale-item {
                font-size: 0.875rem;
            }
        }

        @media (max-width: 480px) {
            .difficulty-legend-static {
                margin: 12px 4px;
                padding: 10px;
            }

            .difficulty-legend-static .color-scale-row {
                gap: 8px;
            }

            .difficulty-legend-static .color-scale-item {
                font-size: 0.8rem;
            }

            .difficulty-legend-static .difficulty-note {
                font-size: 0.8rem;
            }
        }



        .left-controls {
            display: flex;
            align-items: center;
            gap: 32px;
        }

        .gameweek-range-controls {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .gameweek-range-controls label {
            font-size: 1rem;
            font-weight: 600;
            color: #64748B;
            margin-right: 2px;
        }

        .gameweek-range-controls input {
            padding: 8px 12px;
            border: 2px solid rgba(203, 213, 225, 0.8);
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            background: rgba(255, 255, 255, 0.95);
            color: #334155;
            width: 70px;
            text-align: center;
        }

        .gameweek-range-controls input:focus {
            outline: none;
            border-color: #3C6E96;
            box-shadow: 0 0 0 3px rgba(60, 110, 150, 0.1);
        }
        
        .number-input-group {
            display: flex;
            align-items: center;
            border: 2px solid rgba(203, 213, 225, 0.8);
            border-radius: 8px;
            overflow: hidden;
        }
        
        .number-btn {
            background: #f8fafc;
            border: none;
            padding: 8px 12px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            color: #64748b;
            transition: background-color 0.2s;
        }
        
        .number-btn:hover {
            background: #e2e8f0;
        }
        
        .number-btn:active {
            background: #cbd5e1;
        }
        
        .number-input-group input[type="number"] {
            border: none;
            outline: none;
            text-align: center;
            padding: 8px 4px;
            background: white;
            width: 60px;
        }
        
        .number-input-group input[type="number"]::-webkit-inner-spin-button,
        .number-input-group input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        
        .number-input-group input[type="number"] {
            -moz-appearance: textfield;
        }

        .color-scale-label {
            font-size: 0.875rem;
            font-weight: 600;
            color: #64748B;
            margin-right: 8px;
        }

        .color-scale-row {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }

        .color-scale-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.75rem;
            font-weight: 600;
            color: #64748B;
        }

        .color-scale-dot {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 1px solid;
        }

        /* Rank Toggle Styles */
        .rank-toggle-container {
            margin: 0;
        }

        .rank-toggle-label {
            display: flex;
            align-items: center;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            color: #64748B;
        }

        /* History Toggle Styles */
        .history-toggle-container {
            margin: 0;
        }

        .history-toggle-label {
            display: flex;
            align-items: center;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            color: #64748B;
        }

        .rank-toggle-label input {
            display: none;
        }

        .rank-toggle-slider {
            position: relative;
            width: 48px;
            height: 26px;
            background: #E2E8F0;
            border-radius: 13px;
            margin-right: 10px;
            transition: background 0.3s ease;
            border: 2px solid rgba(203, 213, 225, 0.8);
        }

        .rank-toggle-slider:before {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 18px;
            height: 18px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .rank-toggle-label input:checked + .rank-toggle-slider {
            background: var(--primary-color);
        }

        .rank-toggle-label input:checked + .rank-toggle-slider:before {
            transform: translateX(22px);
        }

        .rank-toggle-text {
            font-size: 0.875rem;
            font-weight: 600;
            color: #64748B;
        }

        .history-toggle-label input {
            display: none;
        }

        .history-toggle-slider {
            position: relative;
            width: 48px;
            height: 26px;
            background: #E2E8F0;
            border-radius: 13px;
            margin-right: 10px;
            transition: background 0.3s ease;
            border: 2px solid rgba(203, 213, 225, 0.8);
        }

        .history-toggle-slider:before {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 18px;
            height: 18px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .history-toggle-label input:checked + .history-toggle-slider {
            background: var(--primary-color);
        }

        .history-toggle-label input:checked + .history-toggle-slider:before {
            transform: translateX(22px);
        }

        .history-toggle-text {
            font-size: 0.875rem;
            font-weight: 600;
            color: #64748B;
        }

        /* Conditional Highlight Toggle Styles */
        .conditional-highlight-toggle-container {
            margin: 0;
        }

        .conditional-highlight-toggle-label {
            display: flex;
            align-items: center;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            color: #64748B;
        }

        .conditional-highlight-toggle-label input {
            display: none;
        }

        .conditional-highlight-toggle-slider {
            position: relative;
            width: 48px;
            height: 26px;
            background: #E2E8F0;
            border-radius: 13px;
            margin-right: 10px;
            transition: background 0.3s ease;
            border: 2px solid rgba(203, 213, 225, 0.8);
        }

        .conditional-highlight-toggle-slider:before {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 18px;
            height: 18px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .conditional-highlight-toggle-label input:checked + .conditional-highlight-toggle-slider {
            background: var(--primary-color);
        }

        .conditional-highlight-toggle-label input:checked + .conditional-highlight-toggle-slider:before {
            transform: translateX(22px);
        }

        .conditional-highlight-toggle-text {
            font-size: 0.875rem;
            font-weight: 600;
            color: #64748B;
        }

        /* Per 90 Toggle Styles */
        .per90-toggle-container {
            margin: 0;
        }

        .per90-toggle-label {
            display: flex;
            align-items: center;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            color: #64748B;
        }

        .per90-toggle-label input {
            display: none;
        }

        .per90-toggle-slider {
            position: relative;
            width: 48px;
            height: 26px;
            background: #E2E8F0;
            border-radius: 13px;
            margin-right: 10px;
            transition: background 0.3s ease;
            border: 2px solid rgba(203, 213, 225, 0.8);
        }

        .per90-toggle-slider:before {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 18px;
            height: 18px;
            background: white;
            border-radius: 50%;
            transition: transform 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .per90-toggle-label input:checked + .per90-toggle-slider {
            background: var(--primary-color);
        }

        .per90-toggle-label input:checked + .per90-toggle-slider:before {
            transform: translateX(22px);
        }

        .per90-toggle-text {
            font-size: 0.875rem;
            font-weight: 600;
            color: #64748B;
        }

        /* Toggle Group Styles */
        .toggle-options {
            margin-top: 16px;
        }

        .toggle-group {
            display: flex;
            flex-direction: row;
            gap: 16px;
            margin-top: 8px;
            align-items: center;
        }

        .toggle-group .per90-toggle-container,
        .toggle-group .conditional-highlight-toggle-container {
            margin: 0;
        }

        .toggle-group .per90-toggle-label,
        .toggle-group .conditional-highlight-toggle-label {
            font-size: 0.875rem;
        }

        .toggle-group .per90-toggle-text,
        .toggle-group .conditional-highlight-toggle-text {
            font-size: 0.8rem;
        }

        .rank-filter-container {
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 0;
        }

        .difficulty-note {
            margin-top: 12px;
            padding: 8px 12px;
            border-radius: 8px;
            border-left: 3px solid var(--primary-color);
            font-size: 0.8rem;
            color: #64748B;
            line-height: 1.4;
        }

        .rank {
            font-weight: 600;
            color: var(--primary-color);
            font-size: 0.875rem;
            border-right: none !important;
        }

        /* Player rank highlighting - preserved as reference for team implementation */
        .rank[data-rank="1"],
        .rank[data-rank="2"],
        .rank[data-rank="3"] {
            background: #10B981;
            color: white;
            font-weight: 600;
            border-radius: 4px;
            padding: 2px 6px;
            box-shadow: 0 2px 4px rgba(16, 185, 129, 0.3);
        }

        .rank[data-rank="1"] {
            background: #059669;
            box-shadow: 0 3px 6px rgba(16, 185, 129, 0.4);
        }

        .rank[data-rank="18"],
        .rank[data-rank="19"],
        .rank[data-rank="20"] {
            background: #EF4444;
            color: white;
            font-weight: 600;
            border-radius: 4px;
            padding: 2px 6px;
            box-shadow: 0 2px 4px rgba(239, 68, 68, 0.3);
        }

        .rank[data-rank="20"] {
            background: #DC2626;
            box-shadow: 0 3px 6px rgba(239, 68, 68, 0.4);
        }

        /* Team strength highlighting - mimics player rank highlighting */
        .team-strength[data-strength="1"],
        .team-strength[data-strength="2"],
        .team-strength[data-strength="3"] {
            background: #10B981;
            color: white;
            font-weight: 600;
            border-radius: 4px;
            padding: 2px 6px;
            box-shadow: 0 2px 4px rgba(16, 185, 129, 0.3);
        }

        .team-strength[data-strength="1"] {
            background: #059669;
            box-shadow: 0 3px 6px rgba(16, 185, 129, 0.4);
        }

        .team-strength[data-strength="18"],
        .team-strength[data-strength="19"],
        .team-strength[data-strength="20"] {
            background: #EF4444;
            color: white;
            font-weight: 600;
            border-radius: 4px;
            padding: 2px 6px;
            box-shadow: 0 2px 4px rgba(239, 68, 68, 0.3);
        }

        .team-strength[data-strength="20"] {
            background: #DC2626;
            box-shadow: 0 3px 6px rgba(239, 68, 68, 0.4);
        }



        .btn-secondary {
            background: #64748B;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 16px;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 4px 12px rgba(100, 116, 139, 0.2);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-secondary:hover {
            background: #475569;
            transform: translateY(-1px);
            box-shadow: 0 6px 16px rgba(100, 116, 139, 0.3);
        }

        .btn-icon {
            font-size: 1rem;
        }

        /* New Filter Layout CSS */
        .filter-row {
            display: flex;
            flex-direction: column;
            gap: 0;
            width: 100%;
            padding: 20px;
            background: rgba(248, 250, 252, 0.95);
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .filter-columns {
            display: flex;
            gap: 24px;
            align-items: flex-start;
        }
        
        .filter-column {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }
        
        .filter-divider {
            width: 1px;
            background: rgba(203, 213, 225, 0.4);
            margin: 0 12px;
        }
        
        .reset-section {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid rgba(203, 213, 225, 0.3);
            text-align: center;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .filter-section {
            display: flex;
            align-items: center;
            gap: clamp(8px, 2vw, 16px);
            flex-wrap: wrap;
            justify-content: flex-start;
            padding: 16px 0;
            border-bottom: 1px solid rgba(203, 213, 225, 0.3);
        }

        .filter-section:last-child {
            border-bottom: none;
            padding-bottom: 0;
        }

        .filter-section:first-child {
            padding-top: 0;
        }

        .filter-label {
            font-weight: 600;
            color: #64748B;
            font-size: clamp(0.75rem, 1.5vw, 0.85rem);
            white-space: nowrap;
            margin-right: clamp(6px, 1.5vw, 8px);
            margin-left: clamp(20px, 3vw, 40px);
            flex-shrink: 0;
        }

        .filter-label:first-child {
            margin-left: 0;
        }

        .filter-btn {
            padding: clamp(6px, 1.2vw, 8px) clamp(12px, 2vw, 16px);
            font-size: clamp(0.7rem, 1.4vw, 0.8rem);
            font-weight: 600;
            border: 3px solid #E2E8F0;
            border-radius: 8px;
            background: #F8FAFC;
            color: #64748B;
            cursor: pointer;
            transition: all 0.2s ease;
            min-width: clamp(36px, 8vw, 48px);
            min-height: 44px;
            text-align: center;
            white-space: nowrap;
            flex-shrink: 0;
        }

        .filter-btn:hover {
            background: #E2E8F0;
            color: #475569;
            border-color: #CBD5E1;
        }

        .filter-btn.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
            box-shadow: 0 2px 8px var(--shadow-color);
        }

        .filter-btn.active:hover {
            background: var(--primary-hover);
            border-color: var(--primary-hover);
        }

        .filter-row select {
            padding: clamp(8px, 1.5vw, 12px) clamp(12px, 2vw, 16px);
            border: 2px solid rgba(203, 213, 225, 0.6);
            border-radius: 12px;
            font-size: clamp(0.75rem, 1.4vw, 0.85rem);
            font-weight: 600;
            background: rgba(255, 255, 255, 0.98);
            color: #334155;
            width: clamp(100px, 18vw, 140px);
            text-align: left;
            transition: all 0.3s ease;
            box-shadow: 
                0 2px 8px rgba(0, 0, 0, 0.08),
                0 1px 3px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 12px center;
            background-repeat: no-repeat;
            background-size: 16px;
            padding-right: 36px;
            flex-shrink: 0;
        }

        .filter-row select:hover {
            border-color: rgba(203, 213, 225, 0.8);
            box-shadow: 
                0 4px 12px rgba(0, 0, 0, 0.12),
                0 2px 6px rgba(0, 0, 0, 0.15);
            transform: translateY(-2px);
        }

        .filter-row select:focus {
            outline: none;
            border-color: #3C6E96;
            box-shadow: 
                0 0 0 3px rgba(60, 110, 150, 0.15),
                0 4px 12px rgba(0, 0, 0, 0.12),
                0 2px 6px rgba(0, 0, 0, 0.15);
            transform: translateY(-2px);
        }

        .btn {
            background: var(--button-color);
            color: white;
            border: none;
            padding: clamp(6px, 1.2vw, 8px) clamp(12px, 2vw, 16px);
            border-radius: 12px;
            font-size: clamp(0.7rem, 1.4vw, 0.8rem);
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 12px var(--shadow-color);
            transition: all 0.2s ease;
            letter-spacing: 0.025em;
            flex-shrink: 0;
            min-height: 44px;
        }

        .btn:hover {
            background: var(--button-hover);
            transform: translateY(-2px);
            box-shadow: 0 8px 20px var(--shadow-hover);
        }

        .btn:active {
            background: var(--button-hover);
            transform: translateY(0);
            box-shadow: 0 2px 8px var(--shadow-color);
        }



        .table-container {
            padding: 15px 30px;
            overflow-x: auto;
            max-width: 100%;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: thin;
            scrollbar-color: rgba(203, 213, 225, 0.6) transparent;
        }

        /* Custom scrollbar styling for webkit browsers */
        .table-container::-webkit-scrollbar {
            height: 8px;
        }

        .table-container::-webkit-scrollbar-track {
            background: rgba(248, 250, 252, 0.8);
            border-radius: 4px;
        }

        .table-container::-webkit-scrollbar-thumb {
            background: rgba(203, 213, 225, 0.6);
            border-radius: 4px;
        }

        .table-container::-webkit-scrollbar-thumb:hover {
            background: rgba(203, 213, 225, 0.8);
        }

        .player-table th:nth-child(n+5) {
            min-width: 45px;
            max-width: 55px;
            text-align: center;
        }

        /* Team table specific column widths - fix overlap */
        #team-table th:nth-child(1) {
            min-width: 60px; /* Badge column - reduced from 120px */
            max-width: 80px; /* Badge column - reduced from 150px */
            text-align: center; /* Center the badge column */
        }

        #team-table th:nth-child(2) {
            min-width: 160px; /* Team name column - increased from 80px */
            max-width: 200px; /* Team name column - increased from 100px */
            text-align: left; /* Left align team names */
        }

        #team-table th:nth-child(n+3) {
            min-width: 45px;
            max-width: 55px;
            text-align: center;
        }

        #team-table td:nth-child(1) {
            text-align: right; /* Right align the badge to get closer to team name */
            min-width: 60px; /* Badge column - reduced from 120px */
            max-width: 80px; /* Badge column - reduced from 150px */
            padding: 8px 16px; /* Doubled horizontal padding for badge column */
        }

        #team-table td:nth-child(2) {
            text-align: left; /* Left align team names */
            min-width: 160px; /* Team name column - increased from 80px */
            max-width: 200px; /* Team name column - increased from 100px */
            font-weight: 600;
            padding-left: 12px; /* Reduced from 20px */
            padding-right: 8px; /* Add right padding */
        }

        #team-table td:nth-child(n+3) {
            min-width: 45px;
            max-width: 55px;
            text-align: center;
        }

        .player-table th.sortable {
            cursor: pointer;
        }

        .player-table th.sortable:hover {
            background: #e9ecef;
        }

        .player-table {
            width: 100%;
            min-width: 800px; /* Ensure minimum width for all columns */
            table-layout: fixed;
            border-collapse: collapse;
            background: rgba(255, 255, 255, 0.98);
            font-size: 0.875rem;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 
                0 8px 32px rgba(71, 85, 105, 0.06),
                0 4px 16px rgba(71, 85, 105, 0.04);
        }
        

        
        /* Remove any borders between columns */
        .player-table th,
        .player-table td {
            border-right: none !important;
            border-left: none !important;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            max-width: 200px;
        }

        .player-table th {
            background: var(--table-header-bg);
            padding: 16px 12px;
            text-align: center;
            font-weight: 700;
            color: #475569;
            border-bottom: 1px solid rgba(203, 213, 225, 0.5);
            position: sticky;
            top: 0;
            z-index: 10;
            cursor: pointer;
            user-select: none;
            min-width: 80px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            font-size: 0.75rem;
            border-right: none;
        }

        .player-table th:hover {
            background: var(--table-header-hover);
            transition: background 0.2s ease;
        }

        .player-table th.sortable::after {
            content: ' ';
            opacity: 0.5;
            font-weight: 400;
        }

        .player-table th.sorted-asc::after {
            content: ' ';
            opacity: 1;
            color: #22C55E;
            font-weight: 600;
        }

        .player-table th.sorted-desc::after {
            content: ' ';
            opacity: 1;
            color: #EF4444;
            font-weight: 600;
        }

        .player-table td {
            padding: 14px 12px;
            border-bottom: 1px solid rgba(203, 213, 225, 0.4);
            border-right: none;
            vertical-align: middle;
            text-align: center;
            color: #334155;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .player-table td:first-child {
            text-align: left;
            min-width: 120px;
            font-weight: 600;
            padding-left: 20px;
        }

        /* Player table column widths - make position, price, and points narrower */
        .player-table th:nth-child(2),
        .player-table td:nth-child(2) {
            min-width: 60px;
            max-width: 80px;
            text-align: center;
        }

        .player-table th:nth-child(3),
        .player-table td:nth-child(3) {
            min-width: 70px;
            max-width: 90px;
            text-align: center;
        }

        .player-table th:nth-child(4),
        .player-table td:nth-child(4) {
            min-width: 70px;
            max-width: 90px;
            text-align: center;
        }



        .player-table tr:hover {
            background: rgba(248, 250, 252, 0.7);
            transition: background 0.2s ease;
        }



        .price {
            font-weight: 600;
            color: #64748B;
            font-size: 0.875rem;
        }

        .points {
            font-weight: 600;
            color: #10B981;
            font-size: 0.875rem;
        }

        /* Team stat column styling with color coding */


        /* Team Stat Columns Styling */
        #team-table .attack-rank,
        #team-table .defense-rank,
        #team-table .statistic {
            padding: 8px 12px;
            border-radius: 8px;
            text-align: center;
            font-weight: 600;
            min-width: 80px;
        }

        /* Team Filter Button Styling */
        .stat-buttons {
            display: flex;
            gap: 4px;
            padding: 4px 0;
            flex-shrink: 0;
        }

        .stat-btn {
            padding: 4px 8px;
            font-size: 0.7rem;
            border: 1px solid #E2E8F0;
            background-color: #F8FAFC;
            color: #64748B;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
            min-width: 32px;
        }

        .stat-btn:hover {
            background-color: #E2E8F0;
            color: #475569;
        }

        .stat-btn.active {
            background-color: #3C6E96;
            color: white;
            border-color: #3C6E96;
        }

        /* Team Selection Styling */
        #team-table tbody tr {
            cursor: pointer;
            transition: all 0.2s ease;
        }

        #team-table tbody tr:hover {
            background-color: rgba(60, 110, 150, 0.05);
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        #team-table tbody tr.selected {
            background-color: rgba(60, 110, 150, 0.1);
            border-left: 4px solid #3C6E96;
        }

        #team-table tbody tr.unselected {
            opacity: 0.4;
            color: #64748B;
        }

        #team-table tbody tr.unselected td {
            color: #64748B;
        }

        #team-table tbody tr.unselected .points {
            opacity: 0.6;
        }

        /* Player table selection styles */
        #player-table tbody tr.selected {
            background-color: rgba(60, 110, 150, 0.1);
            border-left: 4px solid #3C6E96;
        }

        #player-table tbody tr.unselected {
            opacity: 0.4;
            color: #64748B;
        }

        #player-table tbody tr.unselected td {
            color: #64748B;
        }

        #player-table tbody tr.unselected .points {
            opacity: 0.6;
        }

        /* Filter layout improvements */
        .filters-container .control-group {
            min-height: 60px;
        }

        .filter-item .btn {
            padding: 8px 16px;
            font-size: 0.75rem;
            border-radius: 8px;
        }

        .filter-item .position-buttons {
            display: flex;
            gap: 6px;
            align-items: center;
            flex-wrap: nowrap;
            padding: 4px 0;
        }





        .fixture-cell {
            padding: 0;
            min-width: 50px;
            max-width: 60px;
            text-align: center;
            border-left: none !important;
            overflow: hidden;
        }

        .fixture {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
            padding: 6px 4px;
            border-radius: 12px;
            font-size: 0.65rem;
            font-weight: 600;
            min-height: 36px;
            justify-content: center;
            text-align: center;
            line-height: 1.1;
            cursor: pointer;
            box-shadow: 
                0 2px 8px rgba(0, 0, 0, 0.08),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
            transition: all 0.2s ease;
            width: 100%;
            height: 100%;
            overflow: hidden;
            word-wrap: break-word;
            hyphens: auto;
        }
        
        /* Prevent text overflow in fixtures */
        .fixture div {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            max-width: 100%;
            width: 100%;
        }
        
        /* Ensure team badges don't overlap */
        .team-badge {
            width: 24px;
            height: 24px;
            border-radius: 4px;
            vertical-align: middle;
            display: block;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            flex-shrink: 0;
        }
        
        .badge-cell {
            width: 48px;
            text-align: center;
            padding: 8px 4px;
            overflow: hidden;
        }
        
        .fixture:hover {
            transform: scale(1.02);
            box-shadow: 
                0 4px 16px rgba(0, 0, 0, 0.12),
                inset 0 1px 0 rgba(255, 255, 255, 0.3);
        }

        .fixture-home {
            background: #10b981;
            color: #ffffff;
        }

        .fixture-away {
            background: #f59e0b;
            color: #ffffff;
        }

        .difficulty-1 { 
            background: #43A15F; 
            color: #FFFFFF; 
        }
        .difficulty-2 { 
            background: #A8E0BB; 
            color: #15803d; 
        }
        .difficulty-3 { 
            background: #D9FAE4; 
            color: #047857; 
        }
        .difficulty-4 { 
            background: #E5E7EB; 
            color: #374151; 
        }
        .difficulty-5 { 
            background: #fef2f2; 
            color: #991b1b; 
        }
        .difficulty-6 { 
            background: #E3B3B3; 
            color: #b91c1c; 
        }
        .difficulty-7 { 
            background: #B55757; 
            color: #FFFFFF; 
        }
        
        .fixture-tbd {
            background-color: #f3f4f6 !important;
            color: #6b7280 !important;
            cursor: default !important;
            border-color: #d1d5db !important;
            box-shadow: none !important;
        }
        
        .fixture-tbd:hover {
            transform: none !important;
            box-shadow: none !important;
        }



        .loading {
            text-align: center;
            padding: 80px 40px;
            color: #64748B;
            font-size: 1rem;
            font-weight: 500;
        }

        .error {
            background: rgba(254, 242, 242, 0.95);
            color: #DC2626;
            padding: 24px;
            border-radius: 16px;
            margin: 24px 0;
            border: 1px solid rgba(252, 165, 165, 0.4);
            box-shadow: 
                0 4px 12px rgba(220, 38, 38, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.9);
        }

        /* Pagination Styles */
        .pagination-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 24px 32px;
            background: rgba(248, 250, 252, 0.9);
            border-top: 1px solid rgba(203, 213, 225, 0.4);
            backdrop-filter: blur(8px);
        }

        .pagination-info {
            color: #64748B;
            font-size: 0.875rem;
            font-weight: 600;
        }

        .pagination-controls {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 0.875rem;
            border-radius: 12px;
        }

        .btn-small:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        .page-numbers {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .page-number {
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            background: rgba(255, 255, 255, 0.9);
            color: #64748B;
            border: 1px solid rgba(203, 213, 225, 0.4);
        }

        .page-number:hover {
            background: rgba(60, 110, 150, 0.1);
            color: #3C6E96;
        }

        .page-number.active {
            background: #3C6E96;
            color: white;
            border-color: #3C6E96;
        }

        .results-per-page {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .results-per-page label {
            color: #64748B;
            font-size: 0.875rem;
            font-weight: 600;
        }

        .results-per-page select {
            padding: 8px 12px;
            border: 2px solid rgba(203, 213, 225, 0.6);
            border-radius: 10px;
            font-size: 0.875rem;
            font-weight: 500;
            background: rgba(255, 255, 255, 0.98);
            color: #334155;
            transition: all 0.2s ease;
            box-shadow: 
                0 2px 4px rgba(0, 0, 0, 0.05),
                0 1px 2px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 8px center;
            background-repeat: no-repeat;
            background-size: 14px;
            padding-right: 32px;
        }

        .results-per-page select:hover {
            border-color: rgba(203, 213, 225, 0.8);
            box-shadow: 
                0 4px 8px rgba(0, 0, 0, 0.08),
                0 2px 4px rgba(0, 0, 0, 0.12);
            transform: translateY(-1px);
        }

        .results-per-page select:focus {
            outline: none;
            border-color: #3C6E96;
            box-shadow: 
                0 0 0 3px rgba(60, 110, 150, 0.1),
                0 4px 8px rgba(0, 0, 0, 0.08),
                0 2px 4px rgba(0, 0, 0, 0.12);
            transform: translateY(-1px);
        }

        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            overflow-y: auto;
            padding: 20px;
            box-sizing: border-box;
        }
        
        .modal-content {
            background: rgba(255, 255, 255, 0.98);
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 32px;
            border-radius: 24px;
            width: 90%;
            max-width: 600px;
            color: #334155;
            box-shadow: 
                0 32px 64px rgba(71, 85, 105, 0.12),
                0 16px 32px rgba(71, 85, 105, 0.08),
                inset 0 1px 0 rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(16px);
            z-index: 1001;
        }
        
        /* Mobile responsive modal adjustments */
        @media (max-width: 768px) {
            .modal {
                padding: 10px;
            }
            
            .modal-content {
                width: calc(100% - 20px);
                max-width: none;
                padding: 20px;
                border-radius: 16px;
            }
            
            .modal-title {
                font-size: 1.2rem;
            }
            
            .modal-subtitle {
                font-size: 0.85rem;
            }
        }
        
        /* Extra small devices - 480px and below */
        @media (max-width: 480px) {
            .modal {
                padding: 8px;
            }
            
            .modal-content {
                width: calc(100% - 16px);
                max-width: none;
                padding: 16px;
                border-radius: 12px;
            }
            
            .modal-title {
                font-size: 1.1rem;
            }
            
            .modal-subtitle {
                font-size: 0.8rem;
            }
            
            .modal-header {
                margin-bottom: 16px;
                padding-bottom: 12px;
            }
            
            .close {
                font-size: 24px;
            }
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e9ecef;
        }
        
        .modal-title-container {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        
        .modal-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: #475569;
        }
        
        .modal-subtitle {
            font-size: 0.9rem;
            font-weight: 500;
            color: #64748B;
            font-style: italic;
        }
        
                .close {
            color: #64748B;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: #475569;
        }
        
        .matchup-details {
            line-height: 1.6;
        }
        
        .matchup-details .highlight {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 6px;
            margin: 15px 0;
            border-left: 4px solid #1976d2;
            color: #1976d2;
        }
        
        .matchup-details .calculation {
            font-family: 'Monaco', 'Menlo', monospace;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            margin: 15px 0;
            border: 1px solid #e9ecef;
            color: #333;
        }

        .team-rankings {
            background: rgba(248, 250, 252, 0.9);
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
            border: 1px solid rgba(203, 213, 225, 0.4);
        }

        .team-rankings h4 {
            color: #64748B;
            margin-bottom: 16px;
            font-size: 1rem;
            font-weight: 600;
        }

        .ranking-row {
            display: flex;
            gap: 24px;
            justify-content: space-between;
        }

        .team-ranking {
            flex: 1;
            padding: 16px;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 8px;
            border: 1px solid rgba(209, 213, 219, 0.3);
        }

        .team-ranking strong {
            color: #1F2937;
            font-size: 0.95rem;
            display: block;
            margin-bottom: 8px;
        }

        .team-ranking small {
            color: #6B7280;
            font-size: 0.75rem;
            display: block;
            margin-top: 8px;
            line-height: 1.4;
        }

        .ranking-badge {
            display: inline-block;
            padding: 2px 8px;
            background: #3B82F6;
            color: white;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 600;
            margin-left: 4px;
        }
        
        .ranking-badge.gold {
            background: #F59E0B;
            color: white;
        }
        
        .ranking-badge.red {
            background: #DC2626;
            color: white;
        }
        
        .fixture-history-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin: 20px 0;
            font-size: 0.9rem;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .fixture-history-table th,
        .fixture-history-table td {
            padding: 12px 8px;
            text-align: center;
            color: #333;
            border: none;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .fixture-history-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #495057;
            border-bottom: 2px solid #e9ecef;
        }
        
        .fixture-history-table tr:last-child td {
            border-bottom: none;
        }
        
        .fixture-history-table .highlight-home {
            background: #f0f9ff;
            color: #0369a1;
            font-weight: 600;
        }
        
        .fixture-history-table .highlight-away {
            background: #fef3c7;
            color: #92400e;
            font-weight: 600;
        }
        
        .fixture-history-table .highlight-home,
        .fixture-history-table .highlight-away {
            position: relative;
        }
        
        .fixture-history-table .highlight-home::before,
        .fixture-history-table .highlight-away::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background: currentColor;
            opacity: 0.3;
        }
        
        @media (max-width: 768px) {
            .header h1 {
                font-size: 2.2rem;
            }
            
            .toggle-btn {
                padding: 14px 24px;
                font-size: 14px;
                min-width: 100px;
            }
            
            .view-toggle {
                border-radius: 14px;
            }
            
            .filter-row {
                flex-direction: column;
                align-items: stretch;
                gap: 16px;
            }
            
            .filter-item {
                justify-content: center;
            }
            
            .filter-item .position-buttons {
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .filter-item .position-btn {
                min-width: 50px;
                padding: 8px 12px;
            }
            
            .location-buttons {
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .location-btn {
                min-width: 60px;
                padding: 10px 12px;
            }
            
            .filters-container {
                padding: 20px 15px 15px 15px;
            }
            
            .table-container {
                padding: 20px;
            }
            
            .player-table {
                font-size: 0.85rem;
            }
            
            /* Team table responsive adjustments */
            #team-table th:nth-child(1),
            #team-table td:nth-child(1) {
                min-width: 50px;
                max-width: 70px;
            }
            
            #team-table th:nth-child(2),
            #team-table td:nth-child(2) {
                min-width: 120px;
                max-width: 150px;
                padding-left: 8px;
                padding-right: 6px;
            }
            
            #team-table th:nth-child(n+3),
            #team-table td:nth-child(n+3) {
                min-width: 35px;
                max-width: 45px;
            }
            
            .modal-content {
                margin: 5% auto;
                width: 95%;
                padding: 20px;
            }
        }

        /* Enhanced Mobile Responsiveness */
        @media (max-width: 768px) {
            /* Body and container adjustments */
            body {
                padding: 12px;
                font-size: 14px;
            }
            
            .container {
                max-width: 100%;
                border-radius: 16px;
                margin: 0;
            }
            
            /* Header adjustments */
            .header {
                padding: 24px 16px;
            }
            
            .header h1 {
                font-size: 1.8rem;
                line-height: 1.2;
                margin-bottom: 8px;
            }
            
            .header p {
                font-size: 1rem;
                line-height: 1.4;
            }
            
            /* View controls adjustments */
            .view-controls {
                padding: 16px;
                flex-direction: column;
                gap: 16px;
            }
            
            .view-toggle {
                width: 100%;
                max-width: 300px;
            }
            
            .toggle-btn {
                padding: 12px 20px;
                font-size: 14px;
                min-width: 80px;
                flex: 1;
            }
            
            /* Filter controls adjustments */
            .filter-controls {
                padding: 16px 12px;
            }
            
            .filter-button-container {
                width: 100%;
                display: flex;
                justify-content: center;
            }
            
            #customize-btn {
                width: 100%;
                max-width: 200px;
                padding: 12px 20px;
                font-size: 16px;
            }
            
            .filters-container {
                padding: 16px 12px;
            }
            
            .filter-row {
                flex-direction: column;
                gap: 12px;
                align-items: stretch;
            }
            
            .filter-label {
                margin: 0 0 8px 0;
                font-size: 14px;
                text-align: center;
            }
            
            .filter-btn {
                padding: 8px 12px;
                font-size: 13px;
                min-width: 50px;
                flex: 1;
            }
            
            .filter-row select {
                width: 100%;
                max-width: 200px;
                margin: 0 auto;
                padding: 10px 12px;
                font-size: 14px;
            }
            
            /* Color scale adjustments */
            .color-scale {
                padding: 16px 12px;
                flex-direction: column;
                gap: 16px;
            }
            
            .left-controls {
                flex-direction: column;
                gap: 12px;
                align-items: center;
            }
            
            .gameweek-range-controls {
                flex-direction: column;
                gap: 8px;
                align-items: center;
            }
            
            .gameweek-range-controls input {
                width: 80px;
                padding: 10px 12px;
                font-size: 14px;
            }
            
            .gameweek-range-controls label {
                font-size: 14px;
            }
            
            /* Toggle adjustments */
            .rank-toggle-container,
            .history-toggle-container {
                margin: 0;
            }
            
            .rank-toggle-label,
            .history-toggle-label {
                font-size: 14px;
                flex-direction: column;
                gap: 8px;
                align-items: center;
            }
            
            /* Table adjustments */
            .table-container {
                padding: 12px;
                overflow-x: auto;
            }
            
            .player-table {
                font-size: 12px;
                min-width: 600px; /* Ensure minimum width for readability */
            }
            
            .player-table th,
            .player-table td {
                padding: 8px 6px;
                font-size: 12px;
            }
            
            .player-table th:first-child,
            .player-table td:first-child {
                min-width: 80px;
                max-width: 100px;
                padding-left: 8px;
            }
            
            /* Fixture cell adjustments */
            .fixture {
                padding: 4px 6px;
                min-height: 32px;
                font-size: 11px;
            }
            
            .fixture div:first-child {
                font-size: 10px;
            }
            
            /* Pagination adjustments */
            .pagination-container {
                padding: 16px 12px;
                flex-direction: column;
                gap: 12px;
            }
            
            .pagination-controls {
                justify-content: center;
            }
            
            .page-numbers {
                gap: 4px;
            }
            
            .page-number {
                padding: 6px 10px;
                font-size: 12px;
            }
            
            .results-per-page {
                justify-content: center;
            }
            
            .results-per-page select {
                padding: 8px 12px;
                font-size: 14px;
            }
            
            /* Modal adjustments */
            .modal-content {
                width: 95%;
                max-width: none;
                padding: 20px;
                max-height: 80vh;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
            }
            
            .modal-title {
                font-size: 1.2rem;
            }
            
            /* Difficulty legend adjustments */
            .difficulty-section {
                min-width: 300px;
                max-width: 100%;
                padding: 12px;
            }
            
            .color-scale-row {
                flex-direction: column;
                gap: 8px;
            }
            
            .color-scale-item {
                justify-content: center;
                gap: 8px;
            }
            

        }
        
        /* Extra small devices */
        @media (max-width: 480px) {
            body {
                padding: 4px;
                font-size: 16px;
            }
            
            .container {
                border-radius: 8px;
            }
            
            .header {
                padding: 12px 8px;
            }
            
            .header h1 {
                font-size: 1.25rem;
                line-height: 1.3;
            }
            
            .header p {
                font-size: 0.875rem;
                line-height: 1.4;
            }
            
            .view-controls {
                padding: 8px;
            }
            
            .controls-top-row {
                gap: 8px;
            }
            
            .search-filter-container {
                flex-direction: column;
                width: 100%;
                gap: 8px;
            }
            
            .search-container {
                width: 100%;
                max-width: none;
            }
            
            .search-input {
                width: 100%;
                font-size: 16px;
                min-height: 48px;
                padding: 12px 16px;
            }
            
            .btn-customize,
            .btn-reset-header {
                min-height: 48px;
                font-size: 16px;
                padding: 12px 16px;
                width: 100%;
                justify-content: center;
            }
            
            .view-toggle {
                min-height: 48px;
                width: 100%;
                max-width: 280px;
            }
            
            .toggle-btn {
                min-height: 48px;
                font-size: 16px;
                padding: 12px 16px;
                min-width: 120px;
            }
            
            .filter-controls {
                padding: 8px 4px;
            }
            
            .filters-container {
                padding: 8px 4px;
            }
            
            .filter-btn {
                padding: 10px 12px;
                font-size: 14px;
                min-width: 44px;
                min-height: 44px;
            }
            
            .filter-section {
                margin-bottom: 12px;
            }
            
            .filter-label {
                font-size: 14px;
                margin-bottom: 8px;
                display: block;
            }
            
            .gameweek-range-controls {
                flex-direction: column;
                gap: 8px;
                align-items: center;
            }
            
            .gameweek-range-controls input {
                width: 80px;
                padding: 10px 12px;
                font-size: 16px;
                min-height: 44px;
            }
            
            .number-input-group {
                gap: 4px;
            }
            
            .number-btn {
                min-height: 44px;
                min-width: 44px;
                font-size: 16px;
            }
            
            .table-container {
                padding: 4px;
                margin: 0 -4px;
            }
            
            .player-table,
            .team-table {
                font-size: 12px;
                min-width: 500px;
            }
            
            .player-table th,
            .player-table td,
            .team-table th,
            .team-table td {
                padding: 6px 4px;
                font-size: 12px;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
                max-width: 150px;
            }
            
            .fixture {
                padding: 4px 6px;
                min-height: 32px;
                font-size: 11px;
            }
            
            .fixture div:first-child {
                font-size: 10px;
            }
            
            .pagination-container {
                padding: 8px 4px;
                flex-direction: column;
                gap: 8px;
            }
            
            .pagination-controls {
                flex-wrap: wrap;
                gap: 4px;
            }
            
            .page-number {
                padding: 8px 12px;
                font-size: 14px;
                min-height: 44px;
            }
            
            .modal-content {
                padding: 12px;
                margin: 10px auto;
                width: 98%;
                max-height: 95vh;
            }
            
            .modal-title {
                font-size: 1.1rem;
            }
            
            /* Improve info button and legend */
            .info-button {
                min-height: 44px;
                min-width: 44px;
                font-size: 16px;
            }
            
            .difficulty-legend-container {
                width: 95vw;
                max-width: 400px;
            }
            
            .color-scale-row {
                flex-direction: column;
                gap: 8px;
            }
            
            .color-scale-item {
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
            }
        }
        
        /* Landscape orientation adjustments */
        @media (max-width: 768px) and (orientation: landscape) {
            .header {
                padding: 16px 20px;
            }
            
            .header h1 {
                font-size: 1.6rem;
            }
            
            .view-controls {
                flex-direction: row;
                gap: 20px;
            }
            
            .color-scale {
                flex-direction: row;
                gap: 20px;
            }
            
            .left-controls {
                flex-direction: row;
                gap: 16px;
            }
            
            .gameweek-range-controls {
                flex-direction: row;
                gap: 8px;
            }
            
            .pagination-container {
                flex-direction: row;
                gap: 16px;
            }
        }
        
        /* Touch-friendly improvements */
        @media (max-width: 768px) {
            /* Increase touch targets */
            .btn,
            .filter-btn,
            .position-btn,
            .location-btn,
            .toggle-btn {
                min-height: 44px; /* Apple's recommended minimum touch target size */
            }
            
            /* Improve button spacing */
            .filter-row {
                gap: 16px;
            }
            
            .position-buttons,
            .location-buttons {
                gap: 8px;
            }
            
            /* Better table scrolling */
            .table-container {
                -webkit-overflow-scrolling: touch;
                scrollbar-width: thin;
            }
            
            /* Improve modal touch interaction */
            .modal-content {
                touch-action: pan-y;
            }
            
            /* Better form controls */
            input[type="number"],
            select {
                min-height: 44px;
                font-size: 16px; /* Prevents zoom on iOS */
            }
            
            /* Improve toggle switches */
            .rank-toggle-slider,
            .history-toggle-slider {
                min-width: 52px;
                min-height: 28px;
            }
            
            .rank-toggle-slider:before,
            .history-toggle-slider:before {
                width: 20px;
                height: 20px;
            }
        }

        .position-buttons {
            display: flex;
            gap: 4px;
            align-items: center;
            flex-shrink: 0;
        }

        .position-btn {
            padding: 4px 8px;
            font-size: 0.7rem;
            font-weight: 600;
            border: 2px solid #E2E8F0;
            border-radius: 4px;
            background: #F8FAFC;
            color: #64748B;
            cursor: pointer;
            transition: all 0.2s ease;
            min-width: 32px;
            text-align: center;
            white-space: nowrap;
        }

        .position-btn:hover {
            background: #E2E8F0;
            color: #475569;
            border-color: #CBD5E1;
        }

        .position-btn.active {
            background: #3C6E96;
            color: white;
            border-color: #3C6E96;
            box-shadow: 0 2px 8px rgba(60, 110, 150, 0.25);
        }

        .position-btn.active:hover {
            background: #2D5A7A;
            border-color: #2D5A7A;
        }

        /* Top 10 Player Pills */
        .top-player-pill {
            padding: 4px 8px;
            font-size: 0.7rem;
            font-weight: 600;
            border: none;
            border-radius: 12px;
            background: #f2c640;
            color: #1F2937;
            cursor: pointer;
            transition: all 0.2s ease;
            min-width: 32px;
            text-align: center;
            white-space: nowrap;
            box-shadow: 0 2px 8px rgba(242, 198, 64, 0.25);
        }

        .top-player-pill:hover {
            background: #e6b93a;
            box-shadow: 0 4px 12px rgba(242, 198, 64, 0.35);
        }

        /* Mobile responsive styles for top-player-pill */
        @media (max-width: 768px) {
            .top-player-pill {
                padding: 2px 6px !important;
                font-size: 0.7rem !important;
                min-width: 28px !important;
                border-radius: 8px !important;
            }
            
            /* Ensure pills in team table match neighboring text */
            #team-table .top-player-pill {
                font-size: 0.7rem !important;
                padding: 2px 6px !important;
                min-width: 28px !important;
            }
        }

        @media (max-width: 480px) {
            .top-player-pill {
                padding: 1px 4px !important;
                font-size: 0.65rem !important;
                min-width: 24px !important;
                border-radius: 6px !important;
                font-weight: 500 !important;
                line-height: 1.1 !important;
            }
            
            /* Ensure pills in team table match neighboring text on very small screens */
            #team-table .top-player-pill {
                font-size: 0.65rem !important;
                padding: 1px 4px !important;
                min-width: 24px !important;
            }
        }

        /* Top 10 ranking opacity classes - only affect background, preserve text color */
        .top-rank-1 { background-color: rgba(242, 198, 64, 1.0) !important; }
        .top-rank-2 { background-color: rgba(242, 198, 64, 0.9) !important; }
        .top-rank-3 { background-color: rgba(242, 198, 64, 0.8) !important; }
        .top-rank-4 { background-color: rgba(242, 198, 64, 0.7) !important; }
        .top-rank-5 { background-color: rgba(242, 198, 64, 0.6) !important; }
        .top-rank-6 { background-color: rgba(242, 198, 64, 0.5) !important; }
        .top-rank-7 { background-color: rgba(242, 198, 64, 0.4) !important; }
        .top-rank-8 { background-color: rgba(242, 198, 64, 0.3) !important; }
        .top-rank-9 { background-color: rgba(242, 198, 64, 0.2) !important; }
        .top-rank-10 { background-color: rgba(242, 198, 64, 0.1) !important; }



        /* Difficulty Scale Visual Indicator */
        .difficulty-scale-container {
            margin: 15px 0;
            padding: 10px;
            background: rgba(248, 250, 252, 0.8);
            border-radius: 8px;
            border: 1px solid rgba(203, 213, 225, 0.4);
        }

        .difficulty-scale {
            position: relative;
            height: 20px;
            background: linear-gradient(to right, 
                #43A15F 0%, #43A15F 14.28%,
                #A8E0BB 14.28%, #A8E0BB 28.56%,
                #D9FAE4 28.56%, #D9FAE4 42.84%,
                #FAFAFA 42.84%, #FAFAFA 57.12%,
                #fef2f2 57.12%, #fef2f2 71.4%,
                #E3B3B3 71.4%, #E3B3B3 85.68%,
                #B55757 85.68%, #B55757 100%);
            border-radius: 10px;
            border: 2px solid rgba(203, 213, 225, 0.6);
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .difficulty-indicator {
            position: absolute;
            top: -8px;
            width: 4px;
            height: 36px;
            background: #1F2937;
            border-radius: 2px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            transform: translateX(-50%);
            z-index: 10;
        }

        .difficulty-indicator::after {
            content: '';
            position: absolute;
            top: -4px;
            left: -3px;
            width: 10px;
            height: 10px;
            background: #1F2937;
            border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .scale-labels {
            display: flex;
            justify-content: space-between;
            margin-top: 8px;
            font-size: 0.75rem;
            font-weight: 600;
            color: #64748B;
        }

        .scale-label {
            text-align: center;
            flex: 1;
        }

        .scale-range {
            font-size: 0.65rem;
            color: #9CA3AF;
            font-weight: 400;
            opacity: 0.7;
        }

        /* Mobile styles for difficulty scale */
        @media (max-width: 768px) {
            .difficulty-scale-container {
                margin: 10px 0;
                padding: 8px;
            }
            
            .difficulty-scale {
                height: 16px;
                border-radius: 8px;
            }
            
            .difficulty-indicator {
                height: 28px;
                top: -6px;
            }
            
            .difficulty-indicator::after {
                width: 8px;
                height: 8px;
                top: -3px;
                left: -2px;
            }
            
            .scale-labels {
                margin-top: 6px;
                font-size: 0.65rem;
            }
            
            .scale-range {
                font-size: 0.55rem;
            }
        }

        @media (max-width: 480px) {
            .difficulty-scale-container {
                margin: 8px 0;
                padding: 6px;
            }
            
            .difficulty-scale {
                height: 14px;
                border-radius: 7px;
            }
            
            .difficulty-indicator {
                height: 24px;
                top: -5px;
            }
            
            .difficulty-indicator::after {
                width: 6px;
                height: 6px;
                top: -2px;
                left: -1px;
            }
            
            .scale-labels {
                margin-top: 4px;
                font-size: 0.6rem;
                flex-wrap: wrap;
                gap: 2px;
            }
            
            .scale-label {
                flex: 0 0 auto;
                min-width: 0;
                padding: 0 2px;
            }
            
            .scale-range {
                font-size: 0.5rem;
            }
        }

        /* Location buttons */
        .location-buttons {
            display: flex;
            gap: 4px;
            align-items: center;
            flex-shrink: 0;
        }

        .location-btn {
            padding: 4px 8px;
            font-size: 0.7rem;
            font-weight: 600;
            border: 2px solid #E2E8F0;
            border-radius: 4px;
            background: #F8FAFC;
            color: #64748B;
            cursor: pointer;
            transition: all 0.2s ease;
            min-width: 32px;
            text-align: center;
        }

        .location-btn:hover {
            background: #E2E8F0;
            color: #475569;
            border-color: #CBD5E1;
        }

        .location-btn.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
            box-shadow: 0 2px 8px var(--shadow-color);
        }

        .location-btn.active:hover {
            background: var(--primary-hover);
            border-color: var(--primary-hover);
        }

        /* Additional mobile-specific improvements */
        @media (max-width: 768px) {
            /* Improve table readability on mobile */
            .player-table {
                border-radius: 12px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
                min-width: 900px; /* Ensure all columns are visible */
            }
            
            /* Make horizontal scrolling more obvious on mobile */
            .table-container {
                padding: 20px 10px;
                border: 2px dashed rgba(203, 213, 225, 0.3);
                border-radius: 12px;
                margin: 10px;
                background: rgba(248, 250, 252, 0.5);
            }
            
            /* Add scroll indicator */
            .table-container::before {
                content: ' Scroll horizontally ';
                position: absolute;
                top: -25px;
                left: 50%;
                transform: translateX(-50%);
                background: rgba(60, 110, 150, 0.9);
                color: white;
                padding: 4px 12px;
                border-radius: 12px;
                font-size: 0.75rem;
                font-weight: 600;
                z-index: 10;
                white-space: nowrap;
                display: var(--show-scroll-indicator, none);
            }
            
            /* Better spacing for mobile tables */
            .player-table th {
                padding: 12px 8px;
                font-size: 11px;
                position: sticky;
                top: 0;
                z-index: 10;
                background: rgba(226, 232, 240, 0.98);
                backdrop-filter: blur(8px);
            }
            
            /* Improve fixture cell touch targets */
            .fixture-cell {
                min-width: 50px;
                max-width: 60px;
            }
            
            .fixture {
                border-radius: 8px;
                cursor: pointer;
                transition: all 0.2s ease;
            }
            
            .fixture:active {
                transform: scale(0.95);
            }
            
            /* Better modal handling on mobile */
            .modal {
                padding: 16px;
            }
            
            .modal-content {
                border-radius: 16px;
                box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            }
            
            /* Improve filter button layout */
            .filter-row {
                background: rgba(248, 250, 252, 0.95);
                border-radius: 12px;
                padding: 16px;
                margin: 8px 0;
            }
            
            /* Better toggle button layout */
            .view-toggle,
            .team-stats-toggle {
                width: 100%;
                max-width: 280px;
                margin: 0 auto;
            }
            
            /* Improve pagination on mobile */
            .pagination-container {
                background: rgba(248, 250, 252, 0.95);
                border-radius: 12px;
                margin: 8px 0;
            }
            
            .page-numbers {
                flex-wrap: wrap;
                justify-content: center;
            }
            
            /* Better form controls */
            .gameweek-range-controls {
                background: rgba(255, 255, 255, 0.9);
                padding: 12px;
                border-radius: 8px;
                border: 1px solid rgba(203, 213, 225, 0.3);
            }
            
            /* Improve difficulty legend on mobile */
            .difficulty-legend-container {
                position: relative;
            }
            
            .difficulty-section {
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                z-index: 1000;
                max-height: 80vh;
                overflow-y: auto;
                box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            }
        }
        
        /* Extra small device optimizations */
        @media (max-width: 480px) {
            /* Stack controls vertically on very small screens */
            .view-controls {
                flex-direction: column;
                gap: 12px;
            }
            
            .color-scale {
                flex-direction: column;
                gap: 12px;
            }
            
            /* Reduce table font size further */
            .player-table {
                font-size: 10px;
                min-width: 450px;
            }
            
            .player-table th,
            .player-table td {
                padding: 6px 4px;
                font-size: 10px;
            }
            
            /* Smaller fixture cells */
            .fixture {
                padding: 2px 4px;
                min-height: 24px;
                font-size: 9px;
            }
            
            .fixture div:first-child {
                font-size: 8px;
            }
            
            /* Compact pagination */
            .pagination-container {
                padding: 8px;
            }
            
            .page-number {
                padding: 4px 6px;
                font-size: 10px;
            }
            
            /* Smaller buttons */
            .filter-btn {
                padding: 6px 8px;
                font-size: 11px;
                min-width: 35px;
            }
            
            .toggle-btn {
                padding: 8px 12px;
                font-size: 12px;
                min-width: 60px;
            }
        }
        
        /* High DPI display optimizations */
        @media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi) {
            .player-table {
                border-width: 0.5px;
            }
            
            .fixture {
                border-width: 0.5px;
            }
            
            .btn,
            .filter-btn {
                border-width: 0.5px;
            }
        }

        /* Comprehensive Mobile Responsive Design */
        
        /* Large tablets and small desktops */
        @media (max-width: 1024px) {
            .container {
                margin: 0 8px;
            }
            
            .header h1 {
                font-size: clamp(1.8rem, 4vw, 2.2rem);
            }
            
            .header p {
                font-size: clamp(0.9rem, 2vw, 1rem);
            }
            
            .view-toggle {
                padding: 3px;
            }
            
            .toggle-btn {
                padding: clamp(12px, 2.5vw, 16px) clamp(20px, 3vw, 32px);
                font-size: clamp(13px, 2vw, 16px);
                min-width: clamp(80px, 15vw, 120px);
            }
            
            .team-toggle-btn {
                padding: clamp(8px, 2vw, 12px) clamp(16px, 2.5vw, 24px);
                font-size: clamp(12px, 1.8vw, 14px);
                min-width: clamp(60px, 12vw, 80px);
            }
        }

        /* Tablets and large phones */
        @media (max-width: 768px) {
            body {
                padding: clamp(4px, 1.5vw, 12px);
            }
            
            .container {
                border-radius: clamp(8px, 2vw, 16px);
            }
            
            .header {
                padding: clamp(16px, 3vw, 24px) clamp(12px, 2.5vw, 20px);
            }
            
            .header h1 {
                font-size: clamp(1.4rem, 4.5vw, 1.8rem);
                margin-bottom: clamp(6px, 1.5vw, 10px);
            }
            
            .header p {
                font-size: clamp(0.8rem, 2.2vw, 1rem);
            }
            
            .view-controls {
                padding: clamp(12px, 2.5vw, 18px) clamp(12px, 2.5vw, 20px);
            }
            
            .filter-controls {
                padding: clamp(12px, 2.5vw, 18px) clamp(8px, 2vw, 12px);
            }
            
            .view-toggle {
                border-radius: 12px;
                padding: 3px;
            }
            
            .toggle-btn {
                padding: clamp(10px, 2.2vw, 14px) clamp(16px, 3vw, 24px);
                font-size: clamp(12px, 2.2vw, 14px);
                min-width: clamp(70px, 18vw, 100px);
                border-radius: 10px;
            }
            
            .team-toggle-btn {
                padding: clamp(8px, 2vw, 10px) clamp(12px, 2.5vw, 18px);
                font-size: clamp(11px, 2vw, 13px);
                min-width: clamp(50px, 15vw, 70px);
                border-radius: 8px;
            }
            
            .toggle-slider,
            .team-toggle-slider {
                border-radius: 8px;
            }
            
            /* Filter buttons */
            .filter-btn {
                padding: clamp(4px, 1vw, 6px) clamp(6px, 1.5vw, 10px);
                font-size: clamp(9px, 1.8vw, 11px);
                min-width: clamp(25px, 6vw, 35px);
                border-radius: 6px;
            }
            
            .btn {
                padding: clamp(6px, 1.5vw, 10px) clamp(10px, 2vw, 16px);
                font-size: clamp(11px, 2vw, 13px);
                border-radius: 8px;
            }
            
            /* Form controls */
            select,
            input[type="number"] {
                padding: clamp(4px, 1vw, 6px) clamp(6px, 1.5vw, 10px);
                font-size: clamp(10px, 1.8vw, 12px);
                border-radius: 6px;
            }
            
            /* Table improvements */
            .player-table,
            .team-table {
                font-size: clamp(11px, 2vw, 13px);
            }
            
            .player-table th,
            .player-table td,
            .team-table th,
            .team-table td {
                padding: clamp(4px, 1vw, 6px) clamp(6px, 1.5vw, 8px);
            }
            
            /* Fixture cells */
            .fixture {
                padding: clamp(2px, 0.8vw, 4px);
                font-size: clamp(9px, 1.8vw, 11px);
                border-radius: 4px;
            }
            
            /* Modal improvements */
            .modal-content {
                padding: clamp(16px, 3vw, 24px);
                border-radius: clamp(12px, 2.5vw, 18px);
                max-width: clamp(280px, 90vw, 500px);
            }
            
            .modal-content h3 {
                font-size: clamp(16px, 3.5vw, 20px);
            }
            
            .modal-content p {
                font-size: clamp(13px, 2.5vw, 15px);
            }
            
            /* Pagination */
            .pagination-container {
                gap: clamp(8px, 2vw, 12px);
            }
            
            .pagination-btn {
                padding: clamp(6px, 1.5vw, 8px) clamp(10px, 2vw, 12px);
                font-size: clamp(11px, 2vw, 13px);
                min-width: clamp(30px, 8vw, 40px);
            }
        }

        /* Small phones */
        @media (max-width: 480px) {
            body {
                padding: 4px;
            }
            
            .container {
                border-radius: 8px;
                margin: 0 2px;
            }
            
            .header {
                padding: 12px 16px;
            }
            
            .header h1 {
                font-size: clamp(1.2rem, 5vw, 1.5rem);
                margin-bottom: 6px;
            }
            
            .header p {
                font-size: clamp(0.7rem, 2.5vw, 0.9rem);
            }
            
            .view-controls {
                padding: 12px 16px;
                flex-direction: column;
                gap: 12px;
            }
            
            .filter-controls {
                padding: 12px 8px;
            }
            
            .view-toggle {
                width: 100%;
                max-width: 300px;
            }
            
            .toggle-btn {
                padding: clamp(8px, 2vw, 12px) clamp(12px, 3vw, 20px);
                font-size: clamp(12px, 2.5vw, 13px);
                min-width: clamp(60px, 15vw, 80px);
                min-height: 44px;
                flex: 1;
            }
            
            .team-toggle-btn {
                padding: clamp(6px, 1.5vw, 10px) clamp(8px, 2vw, 16px);
                font-size: clamp(11px, 2.2vw, 12px);
                min-width: clamp(45px, 12vw, 60px);
                min-height: 44px;
            }
            
            /* Filter layout */
            .filter-row {
                flex-direction: column;
                gap: clamp(8px, 2vw, 12px);
                align-items: stretch;
                padding: clamp(8px, 2vw, 12px) 0;
            }
            
            .filter-label {
                font-size: clamp(11px, 2.2vw, 13px);
                font-weight: 600;
                margin-bottom: clamp(2px, 1vw, 4px);
                margin-left: 0;
                margin-right: 0;
            }
            
            .position-buttons {
                justify-content: center;
                gap: clamp(4px, 1vw, 6px);
                flex-wrap: wrap;
            }
            
            .filter-btn {
                padding: clamp(6px, 1.5vw, 8px) clamp(8px, 2vw, 12px);
                font-size: clamp(10px, 1.8vw, 11px);
                min-width: clamp(30px, 8vw, 35px);
                min-height: 44px;
                flex: 0 1 auto;
            }
            
            .btn {
                padding: clamp(8px, 2vw, 10px) clamp(12px, 2.5vw, 16px);
                font-size: clamp(11px, 2vw, 13px);
                min-height: 44px;
                width: 100%;
                max-width: 200px;
            }
            
            /* Form controls */
            select,
            input[type="number"] {
                padding: clamp(8px, 2vw, 10px) clamp(10px, 2.5vw, 12px);
                font-size: clamp(12px, 2.2vw, 14px);
                width: 100%;
            }
            
            /* Table scrolling */
            .table-container {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            .player-table,
            .team-table {
                min-width: 600px;
                font-size: 11px;
            }
            
            .player-table th,
            .player-table td,
            .team-table th,
            .team-table td {
                padding: 6px 4px;
                white-space: nowrap;
            }
            
            /* Fixture cells */
            .fixture {
                padding: 3px 4px;
                font-size: 9px;
                min-width: 30px;
            }
            
            /* Modal */
            .modal-content {
                padding: 20px;
                border-radius: 12px;
                max-width: 95vw;
                max-height: 90vh;
            }
            
            .modal-content h3 {
                font-size: 18px;
            }
            
            .modal-content p {
                font-size: 14px;
            }
            
            /* Pagination */
            .pagination-container {
                flex-direction: column;
                gap: 8px;
            }
            
            .pagination-btn {
                padding: 8px 12px;
                font-size: 12px;
                min-width: 35px;
            }
            
            /* Prevent all overlapping on very small screens */
            .fixture-cell {
                min-width: 65px;
                max-width: 75px;
                overflow: hidden;
            }
            
            .fixture {
                min-height: 26px;
                font-size: 8px;
                padding: 2px 3px;
                line-height: 0.9;
            }
            
            .fixture div {
                font-size: 7px;
                line-height: 0.8;
                max-width: 100%;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
            }
            
            .team-badge {
                width: 16px;
                height: 16px;
                border-radius: 3px;
            }
            
            .badge-cell {
                width: 36px;
                padding: 4px 2px;
            }
            
            /* Ensure table cells don't overflow */
            .player-table th,
            .player-table td,
            .team-table th,
            .team-table td {
                padding: 4px 2px;
                font-size: 10px;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
            }
        }

        /* Landscape orientation on mobile */
        @media (max-width: 768px) and (orientation: landscape) {
            .header {
                padding: 12px 20px;
            }
            
            .header h1 {
                font-size: clamp(1.3rem, 3.5vw, 1.6rem);
            }
            
            .header p {
                font-size: clamp(0.8rem, 2vw, 0.9rem);
            }
            
            .view-controls {
                padding: 8px 16px;
            }
            
            .filter-controls {
                padding: 8px 12px;
            }
            
            .toggle-btn {
                padding: 8px 16px;
                font-size: 12px;
                min-width: 70px;
            }
            
            .team-toggle-btn {
                padding: 6px 12px;
                font-size: 11px;
                min-width: 50px;
            }
        }

        /* Touch-friendly improvements */
        @media (max-width: 768px) {
            /* Increase touch targets */
            .btn,
            .filter-btn,
            .position-btn,
            .location-btn,
            .toggle-btn {
                min-height: 44px; /* Apple's recommended minimum touch target size */
            }
            
            /* Improve button spacing */
            .filter-row {
                gap: 16px;
            }
            
            .position-buttons,
            .location-buttons {
                gap: 8px;
            }
            
            /* Better table scrolling */
            .table-container {
                -webkit-overflow-scrolling: touch;
                scrollbar-width: thin;
            }
            
            /* Improve modal touch interaction */
            .modal-content {
                touch-action: pan-y;
            }
            
            /* Better form controls */
            input[type="number"],
            select {
                min-height: 44px;
                font-size: 16px; /* Prevents zoom on iOS */
            }
            
            /* Improve toggle switches */
            .rank-toggle-slider,
            .history-toggle-slider {
                min-width: 52px;
                min-height: 28px;
            }
            
            .rank-toggle-slider:before,
            .history-toggle-slider:before {
                width: 20px;
                height: 20px;
            }
        }

        /* Accessibility improvements */
        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        /* High contrast mode support */
        @media (prefers-contrast: high) {
            .btn,
            .filter-btn {
                border-width: 2px;
            }
            
            .fixture {
                border-width: 2px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>FPL Fixture Analyzer</h1>
            <p>Optimize your FPL team with fixture difficulty analysis and advanced stats</p>
        </div>

        <div class="controls-container">
            <div class="view-controls">
            <div class="controls-top-row">
                <div class="view-toggle-container">
                    <div class="view-toggle">
                        <div class="toggle-slider"></div>
                        <button class="toggle-btn active" onclick="switchView('players').catch(console.error)" id="players-view-btn">Players</button>
                        <button class="toggle-btn" onclick="switchView('teams').catch(console.error)" id="teams-view-btn">Teams</button>
                    </div>
                </div>
                
                <!-- Search Bar and Filter Button -->
                <div class="search-filter-container">
                    <button class="btn btn-customize" onclick="toggleFilters()" id="customize-btn">
                        <div class="filter-icon" id="filter-icon"></div>
                        <span class="filter-text">Customize</span>
                    </button>
                    <button class="btn btn-reset-header" onclick="resetFilters()" id="reset-btn" style="display: none;">
                        Reset
                    </button>
                    <button class="btn btn-compare" onclick="toggleCompareMode()" id="compare-btn" style="display: none;">
                        Compare
                    </button>
                    <div class="search-container">
                        <input type="text" id="search-input" placeholder="Search players/teams..." class="search-input" oninput="handleSearch()">
                        <div class="search-icon"></div>
                    </div>
                </div>
                

            </div>
        </div>

        <div class="filters-container" id="filters-container">
                <!-- Players View Filters -->
                <div class="filter-row" id="players-filters" style="display: none;">
                    <div class="filter-columns">
                        <!-- Left Column -->
                        <div class="filter-column">
                            <!-- Gameweek Range -->
                            <div class="filter-section">
                                <span class="filter-label">Gameweek Range:</span>
                                <div class="gameweek-range-controls">
                                    <div class="number-input-group">
                                        <button type="button" class="number-btn minus" onclick="adjustGameweek('start', -1, 'players')">-</button>
                                        <input type="number" id="gameweek-start-players" value="1" min="1" max="38" style="width: 60px;" onchange="validateGameweekRange('players')">
                                        <button type="button" class="number-btn plus" onclick="adjustGameweek('start', 1, 'players')">+</button>
                                    </div>
                                    <label for="gameweek-end-players" class="filter-label">to:</label>
                                    <div class="number-input-group">
                                        <button type="button" class="number-btn minus" onclick="adjustGameweek('end', -1, 'players')">-</button>
                                        <input type="number" id="gameweek-end-players" value="5" min="1" max="38" style="width: 60px;" onchange="validateGameweekRange('players')">
                                        <button type="button" class="number-btn plus" onclick="adjustGameweek('end', 1, 'players')">+</button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Position Filter -->
                            <div class="filter-section">
                                <span class="filter-label">Position:</span>
                                <button class="filter-btn active" data-position="">ALL</button>
                                <button class="filter-btn" data-position="1">GKP</button>
                                <button class="filter-btn" data-position="2">DEF</button>
                                <button class="filter-btn" data-position="3">MID</button>
                                <button class="filter-btn" data-position="4">FWD</button>
                            </div>
                        </div>
                        
                        <!-- Vertical Divider -->
                        <div class="filter-divider"></div>
                        
                        <!-- Right Column -->
                        <div class="filter-column">
                            <!-- Statistic Filter -->
                            <div class="filter-section">
                                <span class="filter-label">Statistic:</span>
                                <select id="stat-filter">
                                    <option value="total_points">Points</option>
                                    <option value="goals_scored">Goals</option>
                                    <option value="assists">Assists</option>
                                    <option value="goals_assists">G+A</option>
                                    <option value="expected_goals">xG</option>
                                    <option value="expected_assists">xA</option>
                                    <option value="clean_sheets">Clean Sheets</option>
                                    <option value="goals_conceded">Goals Conceded</option>
                                    <option value="bonus">Bonus</option>
                                    <option value="saves">Saves</option>
                                </select>
                            </div>
                            
                            <!-- Display Options -->
                            <div class="filter-section rank-filter-container">
                                <span class="filter-label">Display:</span>
                                <button class="filter-btn active" data-rank="none" onclick="handleRankFilter('none')">None</button>
                                <button class="filter-btn" data-rank="rank" onclick="handleRankFilter('rank')">Rank</button>
                                <button class="filter-btn" data-rank="last" onclick="handleRankFilter('last')">Last</button>
                                <button class="filter-btn" data-rank="per90" onclick="handleRankFilter('per90')">Per 90</button>
                                <div id="display-description" class="display-description" style="display: none;"></div>
                            </div>
                            

                        </div>
                    </div>
                </div>
                
                <!-- Teams View Filters -->
                <div class="filter-row" id="teams-filters" style="display: none;">
                    <div class="filter-columns">
                        <!-- Left Column -->
                        <div class="filter-column">
                            <!-- Gameweek Range -->
                            <div class="filter-section">
                                <span class="filter-label">Gameweek Range:</span>
                                <div class="gameweek-range-controls">
                                    <div class="number-input-group">
                                        <button type="button" class="number-btn minus" onclick="adjustGameweek('start', -1, 'teams')">-</button>
                                        <input type="number" id="gameweek-start-teams" value="1" min="1" max="38" style="width: 60px;" onchange="validateGameweekRange('teams')">
                                        <button type="button" class="number-btn plus" onclick="adjustGameweek('start', 1, 'teams')">+</button>
                                    </div>
                                    <label for="gameweek-end-teams" class="filter-label">to:</label>
                                    <div class="number-input-group">
                                        <button type="button" class="number-btn minus" onclick="adjustGameweek('end', -1, 'teams')">-</button>
                                        <input type="number" id="gameweek-end-teams" value="5" min="1" max="38" style="width: 60px;" onchange="validateGameweekRange('teams')">
                                        <button type="button" class="number-btn plus" onclick="adjustGameweek('end', 1, 'teams')">+</button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Location Filter -->
                            <div class="filter-section">
                                <span class="filter-label">Location:</span>
                                <button class="filter-btn active" data-location="overall">All</button>
                                <button class="filter-btn" data-location="home">Home</button>
                                <button class="filter-btn" data-location="away">Away</button>
                            </div>
                        </div>
                        
                        <!-- Vertical Divider -->
                        <div class="filter-divider"></div>
                        
                        <!-- Right Column -->
                        <div class="filter-column">
                            <!-- Type Filter -->
                            <div class="filter-section">
                                <span class="filter-label">Type:</span>
                                <button class="filter-btn active" data-type="attack">ATK</button>
                                <button class="filter-btn" data-type="defense">DEF</button>
                                <button class="filter-btn" data-type="goalie">GPK</button>
                            </div>
                            

                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="color-scale">
            <div class="left-controls">
            </div>
        </div>



        <div class="table-container">
            <div id="loading" class="loading">Loading players and fixtures...</div>
            <div id="error" class="error" style="display: none;"></div>
            <table id="player-table" class="player-table" style="display: none;">
                <thead>
                    <tr id="table-header">
                        <th></th>
                        <th class="sortable" data-sort="web_name">Player</th>
                        <th>Position</th>
                        <th class="sortable" data-sort="now_cost">Price</th>
                        <th class="sortable" data-sort="total_points" id="stat-header">Points</th>
                    </tr>
                </thead>
                <tbody id="player-tbody">
                </tbody>
            </table>
            
            <table id="team-table" class="player-table" style="display: none;">
                <thead>
                    <tr id="team-table-header">
                        <th class="sortable" data-sort="name">Team</th>
                        <!-- Dynamic headers will be inserted here -->
                    </tr>
                </thead>
                <tbody id="team-tbody">
                </tbody>
            </table>
            
            <!-- Pagination Controls -->
            <div class="pagination-container">
                <div class="pagination-info">
                    <span id="pagination-info">Showing 1-25 of 0 players</span>
                </div>
                <div class="pagination-controls">
                    <button class="btn btn-small" onclick="changePage(-1)" id="prev-btn" disabled>Previous</button>
                    <span class="page-numbers" id="page-numbers"></span>
                    <button class="btn btn-small" onclick="changePage(1)" id="next-btn" disabled>Next</button>
                </div>
                <div class="results-per-page">
                    <label for="results-per-page">Show:</label>
                    <select id="results-per-page" onchange="changeResultsPerPage()">
                        <option value="10">10</option>
                        <option value="25" selected>25</option>
                        <option value="50">50</option>
                        <option value="100">100</option>
                        <option value="all">All</option>
                    </select>
                </div>
            </div>
        </div>
        
        <!-- Difficulty Legend -->
        <div class="difficulty-legend-static" style="text-align: center; margin-top: 20px;">
            <div class="color-scale-row">
                <span class="color-scale-label">Difficulty:</span>
                <div class="color-scale-item">
                    <div class="color-scale-dot" style="background: #43A15F; border-color: #2D7A4A;"></div>
                    <span>Very Easy</span>
                </div>
                <div class="color-scale-item">
                    <div class="color-scale-dot" style="background: #A8E0BB; border-color: #15803d;"></div>
                    <span>Easy</span>
                </div>
                <div class="color-scale-item">
                    <div class="color-scale-dot" style="background: #D9FAE4; border-color: #047857;"></div>
                    <span>Easy+</span>
                </div>
                <div class="color-scale-item">
                    <div class="color-scale-dot" style="background: #E5E7EB; border-color: #D1D5DB;"></div>
                    <span>Neutral</span>
                </div>
                <div class="color-scale-item">
                    <div class="color-scale-dot" style="background: #fef2f2; border-color: #991b1b;"></div>
                    <span>Hard+</span>
                </div>
                <div class="color-scale-item">
                    <div class="color-scale-dot" style="background: #E3B3B3; border-color: #b91c1c;"></div>
                    <span>Hard</span>
                </div>
                <div class="color-scale-item">
                    <div class="color-scale-dot" style="background: #B55757; border-color: #991B1B;"></div>
                    <span>Very Hard</span>
                </div>
            </div>
            <div class="difficulty-note">
                <em>Note: Difficulty based on team rankings, home/away, and player position.</em>
            </div>
        </div>
        
        <!-- Matchup Details Modal -->
        <div id="matchupModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <div class="modal-title-container">
                        <span class="modal-title" id="modalTitle">Matchup Details</span>
                        <span class="modal-subtitle" id="modalSubtitle"></span>
                    </div>
                    <span class="close" onclick="closeMatchupModal()">&times;</span>
                </div>
                <div class="matchup-details" id="modalContent">
                </div>
            </div>
        </div>
    </div>

    <script>
        // Browser compatibility and feature detection
        const browserSupport = {
            backdropFilter: CSS.supports('backdrop-filter', 'blur(10px)'),
            flexbox: CSS.supports('display', 'flex'),
            grid: CSS.supports('display', 'grid'),
            sticky: CSS.supports('position', 'sticky'),
            clamp: CSS.supports('font-size', 'clamp(1rem, 2vw, 2rem)'),
            isSafari: /^((?!chrome|android).)*safari/i.test(navigator.userAgent),
            isChrome: /chrome/i.test(navigator.userAgent),
            isFirefox: /firefox/i.test(navigator.userAgent)
        };

        // Apply browser-specific fixes
        function applyBrowserFixes() {
            // Safari-specific fixes
            if (browserSupport.isSafari) {
                // Fix for Safari viewport height issues on mobile
                const setVH = () => {
                    const vh = window.innerHeight * 0.01;
                    document.documentElement.style.setProperty('--vh', `${vh}px`);
                };
                setVH();
                window.addEventListener('resize', setVH);
                
                // Fix for Safari flexbox alignment
                document.querySelectorAll('.filter-row, .filter-columns').forEach(el => {
                    el.style.webkitBoxAlign = 'center';
                    el.style.webkitBoxPack = 'center';
                });
            }

            // Fallback for backdrop-filter
            if (!browserSupport.backdropFilter) {
                document.querySelectorAll('.container').forEach(el => {
                    el.style.background = 'rgba(255, 255, 255, 0.95)';
                });
            }

            // Fallback for clamp
            if (!browserSupport.clamp) {
                // Apply fallback font sizes
                document.body.style.fontSize = '16px';
            }
        }

                        // Initialize browser fixes
                document.addEventListener('DOMContentLoaded', applyBrowserFixes);

        let playersData = [];
        let teamsData = [];
        let fixturesData = [];
        let currentSort = { field: 'total_points', direction: 'desc' };
        
        // Pagination variables
        let currentPage = 1;
        let resultsPerPage = 25;
        let filteredPlayers = [];
        
        // View state
        let currentView = 'players'; // 'players' or 'teams'
        let selectedTeams = []; // Array to track selected teams in order
        let selectedPlayers = []; // Array to track selected players in order
        let teamStatsData = {}; // Object to store team statistics by location
        let currentTeamLocation = 'overall'; // Current location filter for teams
        let currentTeamType = 'attack'; // Current type filter for teams (attack/defense)
        let currentTeamStat = 'goals_scored'; // Current statistic for teams
        let currentSeason = '2024'; // Current season filter (2024 = 2024/25, 2025 = 2025/26)

        // Position mapping
        const positions = {
            1: 'GKP',
            2: 'DEF', 
            3: 'MID',
            4: 'FWD',
            5: 'MGR' // Managers - should be filtered out
        };

        // Difficulty colors (7-bucket system)
        const difficultyColors = {
            1: 'difficulty-1',  // Easiest: Dark Green
            2: 'difficulty-2',  // Light Green
            3: 'difficulty-3',  // Very Light Green
            4: 'difficulty-4',  // Neutral: White/Gray
            5: 'difficulty-5',  // Very Light Red
            6: 'difficulty-6',  // Light Red
            7: 'difficulty-7'   // Hardest: Dark Red
        };

        // Environment-based API configuration
        const API_BASE_URL = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
            ? 'http://localhost:5001'
            : window.location.origin; // Use same origin for production

        async function initializeApp() {
            try {
                // Load teams data
                const teamsResponse = await fetch(`${API_BASE_URL}/api/teams`);
                teamsData = await teamsResponse.json();
                


                // Add sorting event listeners
                document.querySelectorAll('.sortable').forEach(th => {
                    th.addEventListener('click', () => handleSort(th.dataset.sort));
                });

                // Add filter change event listeners for live updates
                document.getElementById('gameweek-start-players').addEventListener('change', () => {
                    updateGameweeks();
                    checkFiltersModified();
                });
                document.getElementById('gameweek-end-players').addEventListener('change', () => {
                    updateGameweeks();
                    checkFiltersModified();
                });
                document.getElementById('gameweek-start-teams').addEventListener('change', () => {
                    updateGameweeks();
                    checkFiltersModified();
                });
                document.getElementById('gameweek-end-teams').addEventListener('change', () => {
                    updateGameweeks();
                    checkFiltersModified();
                });


                document.getElementById('stat-filter').addEventListener('change', () => {
                    updateStatColumn();
                    checkFiltersModified();
                });

                
                // Add event listeners for position filter buttons
                document.querySelectorAll('.filter-btn[data-position]').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const position = btn.dataset.position;
                        console.log('Position filter button clicked:', { position, currentSelectedPositions: [...selectedPositions] });
                        
                        if (position === '') {
                            // ALL button clicked - clear all selections
                            document.querySelectorAll('.filter-btn[data-position]:not([data-position=""])').forEach(b => b.classList.remove('active'));
                            btn.classList.add('active');
                            selectedPositions = [];
                        } else {
                            // Specific position button clicked
                            const allButton = document.querySelector('.filter-btn[data-position=""]');
                            allButton.classList.remove('active');
                            
                            if (btn.classList.contains('active')) {
                                // Remove this position from selection
                                btn.classList.remove('active');
                                selectedPositions = selectedPositions.filter(p => p !== position);
                            } else {
                                // Add this position to selection
                                btn.classList.add('active');
                                selectedPositions.push(position);
                            }
                            
                            // If no positions selected, activate ALL button
                            if (selectedPositions.length === 0) {
                                allButton.classList.add('active');
                            }
                        }
                        console.log('After position filter update:', { selectedPositions: [...selectedPositions] });
                        loadData();
                        checkFiltersModified();
                    });
                });
                
                // Add event listeners for team filter buttons
                document.querySelectorAll('.filter-btn[data-location]').forEach(btn => {
                    btn.addEventListener('click', async () => {
                        console.log('Location button clicked:', btn.dataset.location);
                        
                        // Ensure mutual exclusivity - remove active from all location buttons first
                        document.querySelectorAll('.filter-btn[data-location]').forEach(b => {
                            b.classList.remove('active');
                            console.log('Removed active from location:', b.dataset.location);
                        });
                        
                        // Add active class to clicked button only
                        btn.classList.add('active');
                        console.log('Added active to location:', btn.dataset.location);
                        
                        // Verify only one button is active
                        const activeLocationButtons = document.querySelectorAll('.filter-btn[data-location].active');
                        console.log('Active location buttons after click:', activeLocationButtons.length);
                        if (activeLocationButtons.length > 1) {
                            console.error('Multiple location buttons active! Fixing...');
                            // Emergency fix - ensure only clicked button is active
                        document.querySelectorAll('.filter-btn[data-location]').forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');
                        }
                        
                        // Update location filter
                        currentTeamLocation = btn.dataset.location;
                        console.log('Current team location updated to:', currentTeamLocation);
                        
                        // Load overall rankings if "All" location is selected
                        if (currentTeamLocation === 'overall') {
                            await loadOverallRankings();
                        }
                        
                        updateTeamStats();
                        checkFiltersModified();
                    });
                });

                // Add event listeners for team type filter buttons
                document.querySelectorAll('.filter-btn[data-type]').forEach(btn => {
                    btn.addEventListener('click', async () => {
                        console.log('Type button clicked:', btn.dataset.type);
                        
                        // Ensure mutual exclusivity - remove active from all type buttons first
                        document.querySelectorAll('.filter-btn[data-type]').forEach(b => {
                            b.classList.remove('active');
                            console.log('Removed active from:', b.dataset.type);
                        });
                        
                        // Add active class to clicked button only
                        btn.classList.add('active');
                        console.log('Added active to:', btn.dataset.type);
                        
                        // Verify only one button is active
                        const activeButtons = document.querySelectorAll('.filter-btn[data-type].active');
                        console.log('Active type buttons after click:', activeButtons.length);
                        if (activeButtons.length > 1) {
                            console.error('Multiple type buttons active! Fixing...');
                            // Emergency fix - ensure only clicked button is active
                        document.querySelectorAll('.filter-btn[data-type]').forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');
                        }
                        
                        // Update type filter
                        currentTeamType = btn.dataset.type;
                        console.log('Current team type updated to:', currentTeamType);
                        
                        // Automatically change statistic based on team type
                        if (currentTeamType === 'defense') {
                            // Change to Goals Conceded for defense
                            currentTeamStat = 'goals_conceded';
                            // Update the active stat button
                            document.querySelectorAll('.filter-btn[data-stat]').forEach(b => b.classList.remove('active'));
                            const gcButton = document.querySelector('.filter-btn[data-stat="goals_conceded"]');
                            if (gcButton) {
                                gcButton.classList.add('active');
                            }
                        } else if (currentTeamType === 'goalie') {
                            // Change to Saves for goalie
                            currentTeamStat = 'saves';
                            // Update the active stat button
                            document.querySelectorAll('.filter-btn[data-stat]').forEach(b => b.classList.remove('active'));
                            const savesButton = document.querySelector('.filter-btn[data-stat="saves"]');
                            if (savesButton) {
                                savesButton.classList.add('active');
                            }
                        } else {
                            // Change to Goals Scored for attack
                            currentTeamStat = 'goals_scored';
                            // Update the active stat button
                            document.querySelectorAll('.filter-btn[data-stat]').forEach(b => b.classList.remove('active'));
                            const gsButton = document.querySelector('.filter-btn[data-stat="goals_scored"]');
                            if (gsButton) {
                                gsButton.classList.add('active');
                            }
                        }
                        
                        // Load overall rankings if "All" location is selected
                        if (currentTeamLocation === 'overall') {
                            await loadOverallRankings();
                        }
                        
                        // Update rank header text
                        const rankHeader = document.getElementById('rank-header');
                        if (rankHeader) {
                            if (currentTeamType === 'attack') {
                                rankHeader.textContent = 'ATK Rank';
                            } else if (currentTeamType === 'defense') {
                                rankHeader.textContent = 'DEF Rank';
                            } else if (currentTeamType === 'goalie') {
                                rankHeader.textContent = 'GK Rank';
                            }
                        }
                        
                        await renderTeamsTable();
                        checkFiltersModified();
                    });
                });

                document.querySelectorAll('.filter-btn[data-stat]').forEach(btn => {
                    btn.addEventListener('click', () => {
                        // Remove active class from all stat buttons
                        document.querySelectorAll('.filter-btn[data-stat]').forEach(b => b.classList.remove('active'));
                        // Add active class to clicked button
                        btn.classList.add('active');
                        // Update statistic filter
                        currentTeamStat = btn.dataset.stat;
                        updateTeamStats();
                    });
                });

                await loadData();
                
                            // Ensure type filter is mutually exclusive on page load
            const activeTypeButtons = document.querySelectorAll('.filter-btn[data-type].active');
            console.log('Page load: Active type buttons found:', activeTypeButtons.length);
            if (activeTypeButtons.length > 1) {
                console.error('Page load: Multiple type buttons active! Fixing...');
                // Remove all active classes
                document.querySelectorAll('.filter-btn[data-type]').forEach(btn => btn.classList.remove('active'));
                // Set only attack as active
                const attackTypeBtn = document.querySelector('.filter-btn[data-type="attack"]');
                if (attackTypeBtn) {
                    attackTypeBtn.classList.add('active');
                    console.log('Page load: Set attack as active');
                }
            } else if (activeTypeButtons.length === 0) {
                console.log('Page load: No type buttons active, setting attack as default');
                const attackTypeBtn = document.querySelector('.filter-btn[data-type="attack"]');
                if (attackTypeBtn) {
                    attackTypeBtn.classList.add('active');
                }
            }
            
            // Ensure location filter is mutually exclusive on page load
            const activeLocationButtons = document.querySelectorAll('.filter-btn[data-location].active');
            console.log('Page load: Active location buttons found:', activeLocationButtons.length);
            if (activeLocationButtons.length > 1) {
                console.error('Page load: Multiple location buttons active! Fixing...');
                // Remove all active classes
                document.querySelectorAll('.filter-btn[data-location]').forEach(btn => btn.classList.remove('active'));
                // Set only overall as active
                const overallLocationBtn = document.querySelector('.filter-btn[data-location="overall"]');
                if (overallLocationBtn) {
                    overallLocationBtn.classList.add('active');
                    console.log('Page load: Set overall as active');
                }
            } else if (activeLocationButtons.length === 0) {
                console.log('Page load: No location buttons active, setting overall as default');
                const overallLocationBtn = document.querySelector('.filter-btn[data-location="overall"]');
                if (overallLocationBtn) {
                    overallLocationBtn.classList.add('active');
                }
            }
                
                // Load initial team stats
                await loadTeamStats();
                
                // Load overall rankings if "All" location is selected
                if (currentTeamLocation === 'overall') {
                    console.log('Loading overall rankings on initialization...');
                    await loadOverallRankings();
                    console.log('Overall rankings loaded:', teamStatsData.overall);
                }
                

                
                // Set initial pagination visibility (hidden for teams view)
                const paginationContainer = document.querySelector('.pagination-container');
                if (paginationContainer) {
                    paginationContainer.style.display = 'flex'; // Show by default for players view
                }
            } catch (error) {
                showError('Failed to load data: ' + error.message);
            }
        }

        async function switchView(view) {
            currentView = view;
            
            // Update button states and slider position
            const playersBtn = document.getElementById('players-view-btn');
            const teamsBtn = document.getElementById('teams-view-btn');
            const slider = document.querySelector('.toggle-slider');
            
            if (view === 'players') {
                playersBtn.classList.add('active');
                teamsBtn.classList.remove('active');
                slider.classList.remove('teams');
            } else {
                playersBtn.classList.remove('active');
                teamsBtn.classList.add('active');
                slider.classList.add('teams');
            }
            
            // Show/hide tables
            document.getElementById('player-table').style.display = view === 'players' ? 'table' : 'none';
            document.getElementById('team-table').style.display = view === 'teams' ? 'table' : 'none';
            
            console.log('Switching to view:', view);
            console.log('Player table display:', document.getElementById('player-table').style.display);
            console.log('Team table display:', document.getElementById('team-table').style.display);
            
            // Close filters panel when switching views to prevent conflicts
            const filtersContainer = document.getElementById('filters-container');
            filtersContainer.classList.remove('expanded');
            document.getElementById('customize-btn').style.display = 'block';
            const filterIcon = document.getElementById('filter-icon');
            if (filterIcon) {
                filterIcon.classList.remove('close');
            }
            
            // Reset filter button text and state
            const customizeBtn = document.getElementById('customize-btn');
            if (customizeBtn) {
                const filterText = customizeBtn.querySelector('.filter-text');
                if (filterText) {
                    filterText.textContent = 'Customize';
                }
            }
            

            
            // Show/hide per 90 toggle (only for players view)
            const per90ToggleContainer = document.querySelector('#players-filters .per90-toggle-container');
            if (per90ToggleContainer) {
                per90ToggleContainer.style.display = view === 'players' ? 'block' : 'none';
            }
            
            // Update filters visibility based on view
            const playersFilters = document.getElementById('players-filters');
            const teamsFilters = document.getElementById('teams-filters');
            
            if (view === 'teams') {
                playersFilters.style.display = 'none';
                teamsFilters.style.display = 'block';
            } else {
                playersFilters.style.display = 'block';
                teamsFilters.style.display = 'none';
            }
            
            // Reset all filters and toggles when switching views
            resetFiltersOnViewSwitch();
            
            // Reset display filter to "None" when switching views
            const rankFilterButtons = document.querySelectorAll('.rank-filter-container .filter-btn');
            rankFilterButtons.forEach(btn => btn.classList.remove('active'));
            const noneBtn = document.querySelector('.rank-filter-container .filter-btn[data-rank="none"]');
            if (noneBtn) {
                noneBtn.classList.add('active');
            }
            showRanks = false;
            showHistory = false;
            showRankMode = false;
            showPer90 = false;
            
            // Reset stat header to default when switching views
            const statHeader = document.getElementById('stat-header');
            if (statHeader) {
                statHeader.textContent = 'Points';
                statHeader.dataset.sort = 'total_points';
            }
            
            // Clear search when switching views
            const searchInput = document.getElementById('search-input');
            if (searchInput) {
                searchInput.value = '';
                searchTerm = '';
            }
            
            // Reset pagination
            currentPage = 1;
            
            // Show/hide pagination based on view (teams view doesn't need pagination)
            const paginationContainer = document.querySelector('.pagination-container');
            if (paginationContainer) {
                paginationContainer.style.display = view === 'players' ? 'flex' : 'none';
            }
            
            // Load appropriate data
            await loadData();
        }



        async function loadData() {
            const loading = document.getElementById('loading');
            const playerTable = document.getElementById('player-table');
            const teamTable = document.getElementById('team-table');
            const error = document.getElementById('error');
            
            loading.style.display = 'block';
            playerTable.style.display = 'none';
            teamTable.style.display = 'none';
            error.style.display = 'none';

            try {
                // Get the correct input IDs based on current view
                const suffix = currentView === 'teams' ? '-teams' : '-players';
                const gameweekStart = parseInt(document.getElementById(`gameweek-start${suffix}`).value);
                const gameweekEnd = parseInt(document.getElementById(`gameweek-end${suffix}`).value);
                const gameweeks = gameweekEnd - gameweekStart + 1; // Calculate number of gameweeks
                const positionFilter = getSelectedPositions();
                const locationFilter = currentView === 'players' ? getSelectedLocation() : '';

                // Always load teams data (needed for both players and teams views)
                if (!teamsData || teamsData.length === 0) {
                    console.log('Loading teams data...');
                    const teamsResponse = await fetch('http://localhost:5001/api/teams');
                    teamsData = await teamsResponse.json();
                    console.log('Teams data loaded:', teamsData.length, 'teams');
                } else {
                    console.log('Using existing teams data:', teamsData.length, 'teams');
                }
                
                if (currentView === 'players') {
                    // Load players with filters
                    console.log('Loading players with filters:', { positionFilter, locationFilter });
                    const playersResponse = await fetch(`${API_BASE_URL}/api/players?position=${positionFilter}&location=${locationFilter}`);
                    playersData = await playersResponse.json();
                    console.log('Players API response:', { 
                        totalPlayers: playersData.length, 
                        positionFilter, 
                        locationFilter,
                        samplePlayer: playersData[0],
                        selectedPositions: selectedPositions
                    });
                } else {
                    // For teams view, load team statistics data
                    console.log('Loading team stats for teams view...');
                    await loadTeamStats();
                    console.log('Team stats loaded for teams view');
                }

                // Load fixtures for the specified gameweek range
                const fixturesResponse = await fetch(`${API_BASE_URL}/api/fixtures?gameweeks=${gameweekStart}-${gameweekEnd}`);
                fixturesData = await fixturesResponse.json();

                // Debug logging
                console.log('Current view:', currentView);
                console.log('Teams data loaded:', teamsData.length, 'teams');
                if (teamsData.length > 0) {
                    console.log('Sample team data:', teamsData[0]);
                }
                if (currentView === 'players') {
                    console.log('Players data loaded:', playersData.length, 'players');
                    if (playersData.length > 0) {
                        console.log('Sample player data:', playersData[0]);
                    }
                }
                console.log('Fixtures data loaded:', fixturesData.length, 'fixtures');
                if (fixturesData.length > 0) {
                    console.log('Sample fixture data:', fixturesData[0]);
                }

                await renderTable();
                
                loading.style.display = 'none';
                if (currentView === 'players') {
                    playerTable.style.display = 'table';
                    console.log('Showing player table');
                } else {
                    teamTable.style.display = 'table';
                    console.log('Showing team table');
                }
            } catch (error) {
                loading.style.display = 'none';
                showError('Failed to load data: ' + error.message);
            }
        }

        async function loadPlayers() {
            // Legacy function - redirect to loadData
            await loadData();
        }

        // Function to get color for top 10 ranking
        function getRankColor(ranking) {
            return '#f2c640'; // Always use the same base color, opacity will be handled by CSS classes
        }

        // Function to convert number to ordinal format
        function getOrdinalSuffix(num) {
            if (num === 'N/A' || num === null || num === undefined) return '';
            
            const j = num % 10;
            const k = num % 100;
            
            if (j === 1 && k !== 11) {
                return 'st';
            }
            if (j === 2 && k !== 12) {
                return 'nd';
            }
            if (j === 3 && k !== 13) {
                return 'rd';
            }
            return 'th';
        }

        // Function to calculate difficulty indicator position
        function calculateIndicatorPosition(rankDifference) {
            // Map rank difference to percentage position on scale
            // Scale from -19 to +19 (38 total range)
            // Convert to 0-100% scale
            const minDiff = -19;
            const maxDiff = 19;
            const range = maxDiff - minDiff;
            
            // Clamp the value to the range
            const clampedDiff = Math.max(minDiff, Math.min(maxDiff, rankDifference));
            
            // Convert to percentage (0-100)
            const percentage = ((clampedDiff - minDiff) / range) * 100;
            
            return percentage;
        }

        function validateGameweekRange(view = 'players') {
            const suffix = view === 'teams' ? '-teams' : '-players';
            const gameweekStart = parseInt(document.getElementById(`gameweek-start${suffix}`).value);
            const gameweekEnd = parseInt(document.getElementById(`gameweek-end${suffix}`).value);
            
            // Validate gameweek range
            if (gameweekEnd < gameweekStart) {
                document.getElementById(`gameweek-end${suffix}`).value = gameweekStart;
            }
            
            // Ensure values are within valid range
            if (gameweekStart < 1) document.getElementById(`gameweek-start${suffix}`).value = 1;
            if (gameweekEnd > 38) document.getElementById(`gameweek-end${suffix}`).value = 38;
            if (gameweekStart > 38) document.getElementById(`gameweek-start${suffix}`).value = 38;
            
            // Check if filters are modified to show/hide reset button
            checkFiltersModified();
        }
        
        function adjustGameweek(type, change, view = 'players') {
            const suffix = view === 'teams' ? '-teams' : '-players';
            const input = document.getElementById(`gameweek-${type}${suffix}`);
            let value = parseInt(input.value) + change;
            
            // Clamp values between 1 and 38
            value = Math.max(1, Math.min(38, value));
            
            input.value = value;
            validateGameweekRange(view);
            updateGameweeks();
        }

        async function updateGameweeks() {
            // Optimized function for gameweek changes - no loading spinner
            try {
                // Get the correct input IDs based on current view
                const suffix = currentView === 'teams' ? '-teams' : '-players';
                const gameweekStart = parseInt(document.getElementById(`gameweek-start${suffix}`).value);
                const gameweekEnd = parseInt(document.getElementById(`gameweek-end${suffix}`).value);
                
                // Validate gameweek range
                if (gameweekEnd < gameweekStart) {
                    showError('End gameweek must be greater than or equal to start gameweek');
                    return;
                }
                
                // Only reload fixtures data (players/teams data stays the same)
                const fixturesResponse = await fetch(`${API_BASE_URL}/api/fixtures?gameweeks=${gameweekStart}-${gameweekEnd}`);
                fixturesData = await fixturesResponse.json();
                
                // Reset pagination to first page
                currentPage = 1;
                
                // Clear only the dynamic gameweek headers, not the static ones
                const playerTableHeader = document.getElementById('table-header');
                const teamTableHeader = document.getElementById('team-table-header');
                
                if (playerTableHeader) {
                    // Remove only the dynamic gameweek headers
                    const existingFixtureHeaders = playerTableHeader.querySelectorAll('th[data-sort^="gw"]');
                    existingFixtureHeaders.forEach(th => th.remove());
                }
                
                if (teamTableHeader) {
                    // Remove only the dynamic gameweek headers
                    const existingFixtureHeaders = teamTableHeader.querySelectorAll('th[data-sort^="gw"]');
                    existingFixtureHeaders.forEach(th => th.remove());
                }
                
                // Re-render table without showing loading spinner
                await renderTable();
                
            } catch (error) {
                console.error('Failed to update gameweeks:', error);
                showError('Failed to update gameweeks: ' + error.message);
            }
        }

        async function renderTable() {
            console.log('renderTable called with currentView:', currentView);
            if (currentView === 'players') {
                console.log('Rendering players table...');
                await renderPlayersTable();
            } else {
                console.log('Rendering teams table...');
                await renderTeamsTable();
            }
        }

        async function renderPlayersTable() {
            const tbody = document.getElementById('player-tbody');
            const tableHeader = document.getElementById('table-header');
            const gameweekStart = parseInt(document.getElementById('gameweek-start-players').value);
            const gameweekEnd = parseInt(document.getElementById('gameweek-end-players').value);
            const gameweeks = gameweekEnd - gameweekStart + 1;
            
            tbody.innerHTML = '';
            
            // Remove existing fixture headers
            const existingFixtureHeaders = tableHeader.querySelectorAll('th:not([data-sort])');
            existingFixtureHeaders.forEach(th => {
                if (th.textContent.startsWith('GW')) {
                    th.remove();
                }
            });
            
            // Create fixture column headers or comparison stat headers
            if (compareMode && selectedPlayers.length >= 2) {
                // Get the first selected player to determine position for stat selection
                const firstSelectedPlayer = playersData.find(p => p.id === selectedPlayers[0]);
                const position = firstSelectedPlayer ? positions[firstSelectedPlayer.element_type] || 'UNK' : 'UNK';
                const availableColumns = gameweekEnd - gameweekStart + 1;
                const comparisonStats = getPositionSpecificStats(position, availableColumns);
                
                comparisonStats.forEach(stat => {
                    const th = document.createElement('th');
                    const statLabels = {
                        'goals_scored': 'Goals',
                        'assists': 'Assists',
                        'expected_goals': 'xG ',
                        'expected_assists': 'xA',
                        'clean_sheets': 'CS',
                        'goals_conceded': 'GC',
                        'bonus': 'Bonus',
                        'saves': 'Saves'
                    };
                    th.textContent = statLabels[stat] || stat;
                    tableHeader.appendChild(th);
                });
            } else {
                // Create fixture column headers (no sorting)
                for (let gw = gameweekStart; gw <= gameweekEnd; gw++) {
                    const th = document.createElement('th');
                    th.textContent = `GW${gw}`;
                    tableHeader.appendChild(th);
                }
            }
            
            // Re-add sorting event listeners for all headers (remove existing first)
            document.querySelectorAll('.sortable').forEach(th => {
                th.removeEventListener('click', th._sortHandler);
                th._sortHandler = () => handleSort(th.dataset.sort);
                th.addEventListener('click', th._sortHandler);
            });
            
            // Apply search filter first
            let searchFilteredPlayers = filterBySearch(playersData);
            
            // Calculate rankings for display only (no sorting)
            let playerRanking = {};
            if (showRankMode) {
                // Get the selected stat for ranking
                const statFilter = document.getElementById('stat-filter');
                const selectedStat = statFilter.value;
                
                // Calculate stat values for ranking
                const statValues = [];
                searchFilteredPlayers.forEach(player => {
                    let statValue = 0;
                    const minutes = player.minutes || 0;
                    
                    if (selectedStat === 'total_points') {
                        statValue = player.total_points || 0;
                    } else if (selectedStat === 'goals_scored') {
                        statValue = player.goals_scored || 0;
                    } else if (selectedStat === 'assists') {
                        statValue = player.assists || 0;
                    } else if (selectedStat === 'goals_assists') {
                        statValue = (player.goals_scored || 0) + (player.assists || 0);
                    } else if (selectedStat === 'expected_goals') {
                        statValue = parseFloat(player.expected_goals || 0);
                    } else if (selectedStat === 'expected_assists') {
                        statValue = parseFloat(player.expected_assists || 0);
                    } else if (selectedStat === 'clean_sheets') {
                        statValue = player.clean_sheets || 0;
                    } else if (selectedStat === 'goals_conceded') {
                        statValue = player.goals_conceded || 0;
                    } else if (selectedStat === 'bonus') {
                        statValue = player.bonus || 0;
                    } else if (selectedStat === 'saves') {
                        statValue = player.saves || 0;
                    }
                    
                    if (statValue > 0) {
                        statValues.push({ player, statValue });
                    }
                });
                
                // Sort by stat value for ranking
                const lowerIsBetter = ['goals_conceded'];
                statValues.sort((a, b) => {
                    if (lowerIsBetter.includes(selectedStat)) {
                        return a.statValue - b.statValue; // Lower is better
                    } else {
                        return b.statValue - a.statValue; // Higher is better
                    }
                });
                
                // Create ranking map
                statValues.forEach((item, index) => {
                    playerRanking[item.player.id] = index + 1;
                });
            }
            
            // Sort players data
            const sortedPlayers = [...searchFilteredPlayers].sort((a, b) => {
                let aVal = a[currentSort.field];
                let bVal = b[currentSort.field];
                
                // Apply per 90 calculations if enabled
                if (showPer90 && ['total_points', 'goals_scored', 'assists', 'expected_goals', 'expected_assists', 'clean_sheets', 'goals_conceded', 'bonus', 'saves'].includes(currentSort.field)) {
                    const aMinutes = a.minutes || 0;
                    const bMinutes = b.minutes || 0;
                    
                    if (currentSort.field === 'goals_assists') {
                        const aGoalsAssists = (a.goals_scored || 0) + (a.assists || 0);
                        const bGoalsAssists = (b.goals_scored || 0) + (b.assists || 0);
                        aVal = aMinutes > 0 ? parseFloat((aGoalsAssists * 90 / aMinutes).toFixed(2)) : 0;
                        bVal = bMinutes > 0 ? parseFloat((bGoalsAssists * 90 / bMinutes).toFixed(2)) : 0;
                    } else if (currentSort.field === 'expected_goals' || currentSort.field === 'expected_assists') {
                        aVal = aMinutes > 0 ? parseFloat((parseFloat(a[currentSort.field] || 0) * 90 / aMinutes).toFixed(2)) : 0;
                        bVal = bMinutes > 0 ? parseFloat((parseFloat(b[currentSort.field] || 0) * 90 / bMinutes).toFixed(2)) : 0;
                    } else {
                        aVal = aMinutes > 0 ? parseFloat(((a[currentSort.field] || 0) * 90 / aMinutes).toFixed(2)) : 0;
                        bVal = bMinutes > 0 ? parseFloat(((b[currentSort.field] || 0) * 90 / bMinutes).toFixed(2)) : 0;
                    }

                } else if (currentSort.field === 'goals_assists') {
                    // Sort by goals + assists
                    aVal = (a.goals_scored || 0) + (a.assists || 0);
                    bVal = (b.goals_scored || 0) + (b.assists || 0);
                } else if (['total_points', 'goals_scored', 'assists', 'expected_goals', 'expected_assists', 'clean_sheets', 'goals_conceded', 'bonus', 'saves', 'now_cost'].includes(currentSort.field)) {
                    // Handle stat fields
                    aVal = parseFloat(a[currentSort.field] || 0);
                    bVal = parseFloat(b[currentSort.field] || 0);
                }
                
                if (aVal < bVal) return currentSort.direction === 'asc' ? -1 : 1;
                if (aVal > bVal) return currentSort.direction === 'asc' ? 1 : -1;
                return 0;
            });

            // Filter out players with less than 900 minutes when per 90 is enabled
            let playersForStats = sortedPlayers;
            if (showPer90) {
                playersForStats = sortedPlayers.filter(player => {
                    const minutes = player.minutes || 0;
                    return minutes >= 900;
                });
                console.log(`Per 90 enabled: Filtered out players with < 900 minutes. Showing ${playersForStats.length} of ${sortedPlayers.length} players`);
            }

            // Get the selected stat for top 10 ranking
            const statFilter = document.getElementById('stat-filter');
            const selectedStat = statFilter.value;
            
            // Calculate stat values for display and top 10 highlighting
            const statValues = [];
            playersForStats.forEach(player => {
                let statValue = 0;
                const minutes = player.minutes || 0;
                
                if (selectedStat === 'total_points') {
                    statValue = showPer90 ? (minutes > 0 ? parseFloat(((player.total_points || 0) * 90 / minutes).toFixed(2)) : 0) : (player.total_points || 0);
                } else if (selectedStat === 'goals_scored') {
                    statValue = showPer90 ? (minutes > 0 ? parseFloat(((player.goals_scored || 0) * 90 / minutes).toFixed(2)) : 0) : (player.goals_scored || 0);
                } else if (selectedStat === 'assists') {
                    statValue = showPer90 ? (minutes > 0 ? parseFloat(((player.assists || 0) * 90 / minutes).toFixed(2)) : 0) : (player.assists || 0);
                } else if (selectedStat === 'goals_assists') {
                    const goalsAssists = (player.goals_scored || 0) + (player.assists || 0);
                    statValue = showPer90 ? (minutes > 0 ? parseFloat((goalsAssists * 90 / minutes).toFixed(2)) : 0) : goalsAssists;
                } else if (selectedStat === 'expected_goals') {
                    statValue = showPer90 ? (minutes > 0 ? parseFloat((parseFloat(player.expected_goals || 0) * 90 / minutes).toFixed(2)) : 0) : parseFloat(player.expected_goals || 0);
                } else if (selectedStat === 'expected_assists') {
                    statValue = showPer90 ? (minutes > 0 ? parseFloat((parseFloat(player.expected_assists || 0) * 90 / minutes).toFixed(2)) : 0) : parseFloat(player.expected_assists || 0);
                } else if (selectedStat === 'clean_sheets') {
                    statValue = showPer90 ? (minutes > 0 ? parseFloat(((player.clean_sheets || 0) * 90 / minutes).toFixed(2)) : 0) : (player.clean_sheets || 0);
                } else if (selectedStat === 'goals_conceded') {
                    statValue = showPer90 ? (minutes > 0 ? parseFloat(((player.goals_conceded || 0) * 90 / minutes).toFixed(2)) : 0) : (player.goals_conceded || 0);
                } else if (selectedStat === 'bonus') {
                    statValue = showPer90 ? (minutes > 0 ? parseFloat(((player.bonus || 0) * 90 / minutes).toFixed(2)) : 0) : (player.bonus || 0);
                } else if (selectedStat === 'saves') {
                    statValue = showPer90 ? (minutes > 0 ? parseFloat(((player.saves || 0) * 90 / minutes).toFixed(2)) : 0) : (player.saves || 0);
                }
                
                // Only include players with valid stat values (exclude 0 values for promoted teams)
                if (statValue > 0) {
                    statValues.push({ player, statValue });
                }
            });
            
            // Sort by stat value (accounting for lower-is-better stats like goals_conceded)
            const lowerIsBetter = ['goals_conceded'];
            statValues.sort((a, b) => {
                if (lowerIsBetter.includes(selectedStat)) {
                    return a.statValue - b.statValue; // Lower is better
                } else {
                    return b.statValue - a.statValue; // Higher is better
                }
            });
            
            // Get top 10 players for highlighting
            const top10 = statValues.slice(0, 10);
            const top10PlayerIds = top10.map(item => item.player.id);
            
            // Update playerRanking for display purposes
            statValues.forEach((item, index) => {
                playerRanking[item.player.id] = index + 1;
            });

            // Apply per 90 calculations to all players (no filtering)
            filteredPlayers = sortedPlayers;
            if (showPer90) {
                // Use the minutes-filtered players for pagination when per 90 is enabled
                filteredPlayers = playersForStats;
                console.log(`Per 90 enabled: Applying per 90 calculations to ${filteredPlayers.length} players (filtered by minutes)`);
            }
            
            // Apply pagination
            const startIndex = resultsPerPage === 'all' ? 0 : (currentPage - 1) * resultsPerPage;
            const endIndex = resultsPerPage === 'all' ? filteredPlayers.length : startIndex + resultsPerPage;
            const paginatedPlayers = resultsPerPage === 'all' ? filteredPlayers : filteredPlayers.slice(startIndex, endIndex);
            
            // Separate selected and unselected players
            const selectedPlayerObjects = [];
            const unselectedPlayerObjects = [];
            
            // Get selected players from the sorted data
            selectedPlayers.forEach(selectedPlayerId => {
                const player = sortedPlayers.find(p => p.id === selectedPlayerId);
                if (player) {
                    selectedPlayerObjects.push(player);
                }
            });
            
            // Get unselected players from the paginated data
            paginatedPlayers.forEach(player => {
                if (!selectedPlayers.includes(player.id)) {
                    unselectedPlayerObjects.push(player);
                }
            });
            
            // Sort selected players by the same criteria
            selectedPlayerObjects.sort((a, b) => {
                let aVal = a[currentSort.field];
                let bVal = b[currentSort.field];
                
                // Apply per 90 calculations if enabled
                if (showPer90 && ['total_points', 'goals_scored', 'assists', 'expected_goals', 'expected_assists', 'clean_sheets', 'goals_conceded', 'bonus', 'saves'].includes(currentSort.field)) {
                    const aMinutes = a.minutes || 0;
                    const bMinutes = b.minutes || 0;
                    
                    if (currentSort.field === 'goals_assists') {
                        const aGoalsAssists = (a.goals_scored || 0) + (a.assists || 0);
                        const bGoalsAssists = (b.goals_scored || 0) + (b.assists || 0);
                        aVal = aMinutes > 0 ? parseFloat((aGoalsAssists * 90 / aMinutes).toFixed(2)) : 0;
                        bVal = bMinutes > 0 ? parseFloat((bGoalsAssists * 90 / bMinutes).toFixed(2)) : 0;
                    } else if (currentSort.field === 'expected_goals' || currentSort.field === 'expected_assists') {
                        aVal = aMinutes > 0 ? parseFloat((parseFloat(a[currentSort.field] || 0) * 90 / aMinutes).toFixed(2)) : 0;
                        bVal = bMinutes > 0 ? parseFloat((parseFloat(b[currentSort.field] || 0) * 90 / bMinutes).toFixed(2)) : 0;
                    } else {
                        aVal = aMinutes > 0 ? parseFloat(((a[currentSort.field] || 0) * 90 / aMinutes).toFixed(2)) : 0;
                        bVal = bMinutes > 0 ? parseFloat(((b[currentSort.field] || 0) * 90 / bMinutes).toFixed(2)) : 0;
                    }
                } else if (currentSort.field === 'goals_assists') {
                    aVal = (a.goals_scored || 0) + (a.assists || 0);
                    bVal = (b.goals_scored || 0) + (b.assists || 0);
                } else if (['total_points', 'goals_scored', 'assists', 'expected_goals', 'expected_assists', 'clean_sheets', 'goals_conceded', 'bonus', 'saves', 'now_cost'].includes(currentSort.field)) {
                    aVal = parseFloat(a[currentSort.field] || 0);
                    bVal = parseFloat(b[currentSort.field] || 0);
                }
                
                if (aVal < bVal) return currentSort.direction === 'asc' ? -1 : 1;
                if (aVal > bVal) return currentSort.direction === 'asc' ? 1 : -1;
                return 0;
            });
            
            // Combine: selected players first (sorted), then unselected players (already sorted from pagination)
            const reorderedPlayers = [...selectedPlayerObjects, ...unselectedPlayerObjects];
            
            // Render reordered players
            console.log('Rendering players:', reorderedPlayers.length, 'players');
            console.log('Selected players:', selectedPlayers);
            
            reorderedPlayers.forEach(player => {
                const row = document.createElement('tr');
                
                // Add click handler for player selection
                row.addEventListener('click', () => togglePlayerSelection(player.id));
                
                // Add selection styling
                const isSelected = selectedPlayers.includes(player.id);
                if (isSelected) {
                    row.classList.add('selected');
                } else if (selectedPlayers.length > 0) {
                    row.classList.add('unselected');
                }
                
                const position = positions[player.element_type] || 'UNK';
                
                // Get player's upcoming fixtures
                const playerFixtures = getPlayerFixtures(player.team_id, gameweeks, position);
                
                // Create fixture cells or comparison stat cells
                const fixtureCells = [];
                
                if (compareMode && selectedPlayers.length >= 2) {
                    // Comparison mode: show stat columns instead of fixtures
                    const availableColumns = gameweekEnd - gameweekStart + 1;
                    const comparisonStats = getPositionSpecificStats(position, availableColumns);
                    
                    // Get selected players for leader comparison
                    const selectedPlayerObjects = selectedPlayers.map(id => 
                        playersData.find(p => p.id === id)
                    ).filter(p => p);
                    
                    comparisonStats.forEach(stat => {
                        const statData = getStatValue(player, stat);
                        const isLeader = findStatLeader(selectedPlayerObjects, stat)?.id === player.id;
                        
                        // Create stat label
                        const statLabels = {
                            'goals_scored': 'Goals',
                            'assists': 'Assists',
                            'expected_goals': 'xG ',
                            'expected_assists': 'xA',
                            'clean_sheets': 'CS',
                            'goals_conceded': 'GC',
                            'bonus': 'Bonus',
                            'saves': 'Saves'
                        };
                        
                        const statLabel = statLabels[stat] || stat;
                        const leaderStyle = isLeader ? 'class="top-player-pill" style="display: inline-block; padding: 6px 12px; font-size: 0.875rem; font-weight: 500; border: none; border-radius: 12px; color: #1F2937; min-width: 40px; text-align: center; white-space: nowrap; box-shadow: 0 2px 8px rgba(242, 198, 64, 0.25);"' : '';
                        
                        fixtureCells.push(`
                            <td class="fixture-cell">
                                <div class="fixture" style="background-color: #f8fafc; border: 1px solid #e2e8f0; cursor: default;">
                                    <div style="font-weight: bold; font-size: 0.8rem; color: ${statData.color};">${isLeader ? `<span ${leaderStyle}>${statData.value}</span>` : statData.value}</div>
                                    <div style="font-size: 0.7rem; opacity: 0.8;">${statLabel}</div>
                                </div>
                            </td>
                        `);
                    });
                } else {
                    // Normal mode: show fixture columns
                    for (let gw = gameweekStart; gw <= gameweekEnd; gw++) {
                        const fixture = playerFixtures.find(f => f.gameweek === gw);
                        if (fixture) {
                            // Escape any single quotes in player names to prevent JS errors
                            const escapedPlayerName = player.web_name.replace(/'/g, "\\'");
                            const escapedOpponent = fixture.opponent.replace(/'/g, "\\'");
                            const escapedDebug = (fixture.debug || '').replace(/'/g, "\\'");
                            
                            // Always show opponent abbreviation on top
                            const displayText = fixture.isHome ? fixture.opponent.toUpperCase() : fixture.opponent.toLowerCase();
                            
                            // Check if we're in 2025/26 season (TBD mode)
                            if (currentSeason === '2025') {
                                fixtureCells.push(`
                                    <td class="fixture-cell" data-fixture="${fixture.gameweek}">
                                        <div class="fixture fixture-tbd" style="background-color: #f3f4f6; color: #6b7280; cursor: default;">
                                            <div style="font-weight: bold; font-size: 0.8rem;">TBD</div>
                                            <div style="font-size: 0.7rem; opacity: 0.8;">2025/26</div>
                                        </div>
                                    </td>
                                `);
                            } else {
                                fixtureCells.push(`
                                    <td class="fixture-cell" data-fixture="${fixture.gameweek}">
                                        <div class="fixture ${fixture.isHome ? 'fixture-home' : 'fixture-away'} ${difficultyColors[fixture.difficulty]}" 
                                             onclick="event.stopPropagation(); showMatchupDetails('${escapedPlayerName}', '${escapedOpponent}', ${fixture.isHome}, '${position}', ${fixture.difficulty}, '${escapedDebug}', ${player.team_id}, event)">
                                            <div style="font-weight: bold; font-size: 0.8rem;">${displayText}</div>
                                            ${showHistory ? '<div style="font-size: 0.7rem; opacity: 0.8;">...</div>' : ''}
                                            ${showRanks && fixture.debug ? '<div style="font-size: 0.7rem; opacity: 0.8;">...</div>' : ''}
                                        </div>
                                    </td>
                                `);
                            }
                        } else {
                            fixtureCells.push('<td></td>');
                        }
                    }
                }
                
                // Get the selected stat
                const statFilter = document.getElementById('stat-filter');
                const selectedStat = statFilter.value;
                
                // Calculate the stat value
                let statValue = 0;
                const minutes = player.minutes || 0;
                

                
                if (selectedStat === 'total_points') {
                    statValue = showPer90 ? (minutes > 0 ? parseFloat(((player.total_points || 0) * 90 / minutes).toFixed(2)) : 0) : (player.total_points || 0);
                } else if (selectedStat === 'goals_scored') {
                    statValue = showPer90 ? (minutes > 0 ? parseFloat(((player.goals_scored || 0) * 90 / minutes).toFixed(2)) : 0) : (player.goals_scored || 0);
                } else if (selectedStat === 'assists') {
                    statValue = showPer90 ? (minutes > 0 ? parseFloat(((player.assists || 0) * 90 / minutes).toFixed(2)) : 0) : (player.assists || 0);
                } else if (selectedStat === 'goals_assists') {
                    const goalsAssists = (player.goals_scored || 0) + (player.assists || 0);
                    statValue = showPer90 ? (minutes > 0 ? parseFloat((goalsAssists * 90 / minutes).toFixed(2)) : 0) : goalsAssists;
                } else if (selectedStat === 'expected_goals') {
                    statValue = showPer90 ? (minutes > 0 ? parseFloat((parseFloat(player.expected_goals || 0) * 90 / minutes).toFixed(2)) : 0) : parseFloat(player.expected_goals || 0).toFixed(1);
                } else if (selectedStat === 'expected_assists') {
                    statValue = showPer90 ? (minutes > 0 ? parseFloat((parseFloat(player.expected_assists || 0) * 90 / minutes).toFixed(2)) : 0) : parseFloat(player.expected_assists || 0).toFixed(1);
                } else if (selectedStat === 'clean_sheets') {
                    statValue = showPer90 ? (minutes > 0 ? parseFloat(((player.clean_sheets || 0) * 90 / minutes).toFixed(2)) : 0) : (player.clean_sheets || 0);
                } else if (selectedStat === 'goals_conceded') {
                    statValue = showPer90 ? (minutes > 0 ? parseFloat(((player.goals_conceded || 0) * 90 / minutes).toFixed(2)) : 0) : (player.goals_conceded || 0);
                } else if (selectedStat === 'bonus') {
                    statValue = showPer90 ? (minutes > 0 ? parseFloat(((player.bonus || 0) * 90 / minutes).toFixed(2)) : 0) : (player.bonus || 0);
                } else if (selectedStat === 'saves') {
                    statValue = showPer90 ? (minutes > 0 ? parseFloat(((player.saves || 0) * 90 / minutes).toFixed(2)) : 0) : (player.saves || 0);
                }
                
                // Convert to rank if rank mode is enabled
                if (showRankMode) {
                    // Find the player's rank for this stat
                    const playerRank = playerRanking[player.id];
                    if (playerRank !== undefined) {
                        statValue = playerRank;
                    }
                }
                
                // Calculate player's team rank based on position
                let teamRank = '';
                const playerTeam = teamsData.find(t => t.id === player.team_id);
                if (playerTeam) {
                    if (position === 'GKP' || position === 'DEF') {
                        // For defenders and goalkeepers: use defense rank
                        teamRank = playerTeam.def_h_rank || playerTeam.def_a_rank || 'N/A';
                    } else {
                        // For midfielders and forwards: use attack rank
                        teamRank = playerTeam.atk_h_rank || playerTeam.atk_a_rank || 'N/A';
                    }
                }
                
                // Check if player is in top 10 and apply pill styling (only if conditional highlight is enabled)
                const isTop10 = top10PlayerIds.includes(player.id);
                const ranking = playerRanking[player.id];
                const top10Class = (isTop10 && showConditionalHighlight) ? `top-player-pill top-rank-${ranking}` : '';
                const top10Style = (isTop10 && showConditionalHighlight) ? `class="top-player-pill top-rank-${ranking}" style="display: inline-block; padding: 6px 12px; font-size: 0.875rem; font-weight: 500; border: none; border-radius: 12px; color: #1F2937; min-width: 40px; text-align: center; white-space: nowrap; box-shadow: 0 2px 8px rgba(242, 198, 64, 0.25);"` : '';
                
                // Get team badge URL
                const badgeUrl = getTeamBadgeUrl(playerTeam?.name || '');
                const badgeHtml = badgeUrl ? `<img src="${badgeUrl}" alt="${playerTeam?.name || ''}" class="team-badge" onerror="this.style.display='none'">` : '';
                
                // Add white background styling for Points and Price when in compare mode
                const compareModeStyle = compareMode && selectedPlayers.length >= 2 ? 'style="background-color: #f8fafc; border: 1px solid #e2e8f0; padding: 8px; border-radius: 4px;"' : '';
                
                row.innerHTML = `
                    <td class="badge-cell">
                        ${badgeHtml}
                    </td>
                    <td ${compareModeStyle}><strong>${player.web_name}</strong> <span style="color: #6b7280; font-weight: normal; font-size: 0.85em;"> ${playerTeam?.short_name || ''}</span></td>
                    <td><span style="display: inline-block; padding: 2px 8px; background-color: #f3f4f6; color: #374151; border-radius: 12px; font-size: 0.75rem; font-weight: 600; box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);">${position}</span></td>
                    <td class="price" ${compareModeStyle}>${(parseFloat(player.now_cost) / 10).toFixed(1)}</td>
                    <td class="points" ${compareModeStyle}>${isTop10 && showConditionalHighlight ? `<span ${top10Style}>${statValue}</span>` : statValue}</td>
                    ${fixtureCells.join('')}
                `;
                
                tbody.appendChild(row);
            });
            
            // Update pagination controls
            console.log('Updating pagination with filteredPlayers length:', filteredPlayers.length);
            updatePagination();
            
            // Load historical points if toggle is enabled
            if (showHistory) {
                console.log('Loading historical points for players view');
                // Load historical points for all visible fixtures
                for (let gw = gameweekStart; gw <= gameweekEnd; gw++) {
                    paginatedPlayers.forEach(player => {
                        const position = positions[player.element_type] || 'UNK';
                        const playerFixtures = getPlayerFixtures(player.team_id, gameweeks, position);
                        const fixture = playerFixtures.find(f => f.gameweek === gw);
                        if (fixture) {
                            console.log(`Loading historical points for ${player.web_name} vs ${fixture.opponent} (GW${gw})`);
                            loadPlayerHistoricalPoints(player.web_name, fixture.opponent, fixture.isHome, gw);
                        }
                    });
                }
            }
            
            // Load rank data if toggle is enabled
            if (showRanks) {
                console.log('Loading rank data for players view');
                // Load rank data for all visible fixtures
                for (let gw = gameweekStart; gw <= gameweekEnd; gw++) {
                    paginatedPlayers.forEach(player => {
                        const position = positions[player.element_type] || 'UNK';
                        const playerFixtures = getPlayerFixtures(player.team_id, gameweeks, position);
                        const fixture = playerFixtures.find(f => f.gameweek === gw);
                        if (fixture && fixture.debug) {
                            console.log(`Loading rank data for ${player.web_name} vs ${fixture.opponent} (GW${gw})`);
                            loadPlayerRankData(player.web_name, fixture, gw);
                        }
                    });
                }
            }
        }

        async function renderTeamsTable() {
            console.log('renderTeamsTable called');
            console.log('teamsData:', teamsData);
            console.log('teamsData length:', teamsData ? teamsData.length : 'undefined');
            console.log('teamStatsData:', teamStatsData);
            console.log('currentTeamLocation:', currentTeamLocation);
            console.log('teamStatsData[currentTeamLocation]:', teamStatsData[currentTeamLocation]);
            
            const tbody = document.getElementById('team-tbody');
            const tableHeader = document.getElementById('team-table-header');
            const gameweekStart = parseInt(document.getElementById('gameweek-start-teams').value);
            const gameweekEnd = parseInt(document.getElementById('gameweek-end-teams').value);
            const gameweeks = gameweekEnd - gameweekStart + 1;
            
            tbody.innerHTML = '';
            
            // Update team table headers based on current type
            updateTeamTableHeaders();
            
            // Remove existing fixture headers and comparison headers
            const existingFixtureHeaders = tableHeader.querySelectorAll('th:not([data-sort])');
            existingFixtureHeaders.forEach(th => {
                if (th.textContent.startsWith('GW') || th.textContent === 'Goals' || th.textContent === 'Assists' || th.textContent === 'xG ' || th.textContent === 'xA' || th.textContent === 'CS' || th.textContent === 'GC' || th.textContent === 'Bonus' || th.textContent === 'Saves') {
                    th.remove();
                }
            });
            
            // Create fixture column headers or comparison stat headers
            if (compareMode && selectedTeams.length >= 2) {
                // For teams, use all available stats
                const availableColumns = gameweekEnd - gameweekStart + 1;
                const comparisonStats = getPositionSpecificStats('team', availableColumns);
                
                comparisonStats.forEach(stat => {
                    const th = document.createElement('th');
                    const statLabels = {
                        'goals_scored': 'Goals',
                        'assists': 'Assists',
                        'expected_goals': 'xG',
                        'expected_assists': 'xA',
                        'clean_sheets': 'CS',
                        'goals_conceded': 'GC',
                        'bonus': 'Bonus',
                        'saves': 'Saves'
                    };
                    th.textContent = statLabels[stat] || stat;
                    tableHeader.appendChild(th);
                });
            } else {
                // Create fixture column headers (no sorting)
                for (let gw = gameweekStart; gw <= gameweekEnd; gw++) {
                    const th = document.createElement('th');
                    th.textContent = `GW${gw}`;
                    tableHeader.appendChild(th);
                }
            }
            
            // Re-add sorting event listeners for all headers
            document.querySelectorAll('.sortable').forEach(th => {
                th.removeEventListener('click', th._sortHandler);
                th._sortHandler = () => handleSort(th.dataset.sort);
                th.addEventListener('click', th._sortHandler);
            });
            
            // Sort function for teams
            const sortTeam = (a, b) => {
                let aVal, bVal;
                
                if (currentSort.field === 'rank') {
                    // Sort by the relevant rank based on current type and location
                    const currentTeamType = getSelectedTeamType();
                    if (currentTeamType === 'attack') {
                        // Sort by attack rank based on current location
                        if (currentTeamLocation === 'home') {
                            aVal = a.atk_h_rank || 20;
                            bVal = b.atk_h_rank || 20;
                        } else if (currentTeamLocation === 'away') {
                            aVal = a.atk_a_rank || 20;
                            bVal = b.atk_a_rank || 20;
                        } else {
                            // For overall, use the better (lower) rank between home and away
                            aVal = Math.min(a.atk_h_rank || 20, a.atk_a_rank || 20);
                            bVal = Math.min(b.atk_h_rank || 20, b.atk_a_rank || 20);
                        }
                    } else if (currentTeamType === 'defense') {
                        // Sort by defense rank based on current location
                        if (currentTeamLocation === 'home') {
                            aVal = a.def_h_rank || 20;
                            bVal = b.def_h_rank || 20;
                        } else if (currentTeamLocation === 'away') {
                            aVal = a.def_a_rank || 20;
                            bVal = b.def_a_rank || 20;
                        } else {
                            // For overall, use the better (lower) rank between home and away
                            aVal = Math.min(a.def_h_rank || 20, a.def_a_rank || 20);
                            bVal = Math.min(b.def_h_rank || 20, b.def_a_rank || 20);
                        }
                    } else if (currentTeamType === 'goalie') {
                        // Sort by defense rank for goalie (since saves are related to defense)
                        if (currentTeamLocation === 'home') {
                            aVal = a.def_h_rank || 20;
                            bVal = b.def_h_rank || 20;
                        } else if (currentTeamLocation === 'away') {
                            aVal = a.def_a_rank || 20;
                            bVal = b.def_a_rank || 20;
                        } else {
                            // For overall, use the better (lower) rank between home and away
                            aVal = Math.min(a.def_h_rank || 20, a.def_a_rank || 20);
                            bVal = Math.min(b.def_h_rank || 20, b.def_a_rank || 20);
                        }
                    }
                } else if (currentSort.field === 'statistic') {
                    // Sort by statistic value from team stats
                    const aStats = teamStatsData[currentTeamLocation]?.[a.id];
                    const bStats = teamStatsData[currentTeamLocation]?.[b.id];
                    aVal = aStats ? (aStats[currentTeamStat] || 0) : 0;
                    bVal = bStats ? (bStats[currentTeamStat] || 0) : 0;
                } else if (currentSort.field === 'xg_diff' || currentSort.field === 'xgc_diff') {
                    // Sort by difference values from team stats
                    const aStats = teamStatsData[currentTeamLocation]?.[a.id];
                    const bStats = teamStatsData[currentTeamLocation]?.[b.id];
                    
                    if (currentSort.field === 'xg_diff') {
                        const aGoals = aStats ? (aStats.goals_scored || 0) : 0;
                        const aXg = aStats ? (aStats.expected_goals || 0) : 0;
                        const bGoals = bStats ? (bStats.goals_scored || 0) : 0;
                        const bXg = bStats ? (bStats.expected_goals || 0) : 0;
                        aVal = aGoals - aXg;
                        bVal = bGoals - bXg;
                    } else { // xgc_diff
                        const aGc = aStats ? (aStats.goals_conceded || 0) : 0;
                        const aXgc = aStats ? (aStats.expected_goals_conceded || 0) : 0;
                        const bGc = bStats ? (bStats.goals_conceded || 0) : 0;
                        const bXgc = bStats ? (bStats.expected_goals_conceded || 0) : 0;
                        aVal = aXgc - aGc; // Positive means conceding more than expected (bad)
                        bVal = bXgc - bGc;
                    }
                } else {
                    // Handle type column stats (goals_scored, saves, clean_sheets, etc.)
                    const aStats = teamStatsData[currentTeamLocation]?.[a.id];
                    const bStats = teamStatsData[currentTeamLocation]?.[b.id];
                    
                    if (['goals_scored', 'saves', 'clean_sheets', 'goals_conceded', 'expected_goals', 'expected_goals_conceded'].includes(currentSort.field)) {
                        // These stats come from teamStatsData
                        aVal = aStats ? parseFloat(aStats[currentSort.field] || 0) : 0;
                        bVal = bStats ? parseFloat(bStats[currentSort.field] || 0) : 0;
                    } else {
                        // Default sorting for other fields (from team object)
                    aVal = a[currentSort.field];
                    bVal = b[currentSort.field];
                    
                        if (['total_points', 'atk_h_rank', 'atk_a_rank', 'def_h_rank', 'def_a_rank', 'assists', 'bonus'].includes(currentSort.field)) {
                        aVal = parseFloat(a[currentSort.field] || 0);
                        bVal = parseFloat(b[currentSort.field] || 0);
                        }
                    }
                }
                
                if (aVal < bVal) return currentSort.direction === 'asc' ? -1 : 1;
                if (aVal > bVal) return currentSort.direction === 'asc' ? 1 : -1;
                return 0;
            };

            // Apply search filter first
            let searchFilteredTeams = filterBySearch(teamsData);
            
            // Sort all teams first
            const sortedTeams = [...searchFilteredTeams].sort(sortTeam);
            
            // No pagination needed for teams view - all teams fit in one table
            const allTeams = sortedTeams;
            
            // Separate selected and unselected teams
            const selectedTeamObjects = [];
            const unselectedTeamObjects = [];
            
            // Get selected teams from the sorted data
            selectedTeams.forEach(selectedTeamId => {
                const team = sortedTeams.find(t => t.id === selectedTeamId);
                if (team) {
                    selectedTeamObjects.push(team);
                }
            });
            
            // Get unselected teams from all teams
            allTeams.forEach(team => {
                if (!selectedTeams.includes(team.id)) {
                    unselectedTeamObjects.push(team);
                }
            });
            
            // Sort selected teams by the same criteria
            selectedTeamObjects.sort(sortTeam);
            
            // Combine: selected teams first (sorted), then unselected teams (already sorted from pagination)
            const reorderedTeams = [...selectedTeamObjects, ...unselectedTeamObjects];
            
            // Render reordered teams
            console.log('Rendering teams:', reorderedTeams.length, 'teams');
            console.log('Selected teams:', selectedTeams);
            
            reorderedTeams.forEach(team => {
                console.log('Rendering team:', team.name);
                const row = document.createElement('tr');
                
                // Add click handler for team selection
                row.addEventListener('click', () => toggleTeamSelection(team.id));
                
                // Add selection styling
                const isSelected = selectedTeams.includes(team.id);
                if (isSelected) {
                    row.classList.add('selected');
                } else if (selectedTeams.length > 0) {
                    row.classList.add('unselected');
                }
                
                // Get team's upcoming fixtures
                const teamFixtures = getTeamFixtures(team.id, gameweeks);
                
                // Create fixture cells or comparison stat cells
                const fixtureCells = [];
                
                if (compareMode && selectedTeams.length >= 2) {
                    // Comparison mode: show stat columns instead of fixtures
                    const availableColumns = gameweekEnd - gameweekStart + 1;
                    const comparisonStats = getPositionSpecificStats('team', availableColumns); // 'team' for team view
                    
                    // Get selected teams for leader comparison
                    const selectedTeamObjects = selectedTeams.map(id => 
                        teamsData.find(t => t.id === id)
                    ).filter(t => t);
                    
                    comparisonStats.forEach(stat => {
                        const teamStats = teamStatsData[currentTeamLocation]?.[team.id];
                        const statValue = teamStats ? (teamStats[stat] || 0) : 0;
                        const isLeader = findStatLeader(selectedTeamObjects, stat)?.id === team.id;
                        
                        // Create stat label
                        const statLabels = {
                            'goals_scored': 'Goals',
                            'assists': 'Assists',
                            'expected_goals': 'xG',
                            'expected_assists': 'xA',
                            'clean_sheets': 'CS',
                            'goals_conceded': 'GC',
                            'bonus': 'Bonus',
                            'saves': 'Saves'
                        };
                        
                        const statLabel = statLabels[stat] || stat;
                        const leaderStyle = isLeader ? 'class="top-player-pill" style="display: inline-block; padding: 6px 12px; font-size: 0.875rem; font-weight: 500; border: none; border-radius: 12px; color: #1F2937; min-width: 40px; text-align: center; white-space: nowrap; box-shadow: 0 2px 8px rgba(242, 198, 64, 0.25);"' : '';
                        
                        fixtureCells.push(`
                            <td class="fixture-cell">
                                <div class="fixture" style="background-color: #f8fafc; border: 1px solid #e2e8f0; cursor: default;">
                                    <div style="font-weight: bold; font-size: 0.8rem;">${isLeader ? `<span ${leaderStyle}>${statValue}</span>` : statValue}</div>
                                    <div style="font-size: 0.7rem; opacity: 0.8;">${statLabel}</div>
                                </div>
                            </td>
                        `);
                    });
                } else {
                    // Normal mode: show fixture columns
                    for (let gw = gameweekStart; gw <= gameweekEnd; gw++) {
                        const fixture = teamFixtures.find(f => f.gameweek === gw);
                        if (fixture) {
                            const escapedTeamName = team.name.replace(/'/g, "\\'");
                            const escapedOpponent = fixture.opponent.replace(/'/g, "\\'");
                            const escapedDebug = (fixture.debug || '').replace(/'/g, "\\'");
                            
                            // Determine what to display and color based on toggle state
                            let displayText = '';
                            let colorClass = '';
                            
                            if (showHistory) {
                                // Show opponent abbreviation (will be updated with historical result underneath)
                                displayText = fixture.isHome ? fixture.opponent.toUpperCase() : fixture.opponent.toLowerCase();
                                colorClass = difficultyColors[fixture.difficulty];
                            } else if (showRanks) {
                                // For teams, always show opponent abbreviation on top, rank will be loaded underneath
                                displayText = fixture.isHome ? fixture.opponent.toUpperCase() : fixture.opponent.toLowerCase();
                                colorClass = difficultyColors[fixture.difficulty];
                            } else {
                                displayText = fixture.isHome ? fixture.opponent.toUpperCase() : fixture.opponent.toLowerCase();
                                colorClass = difficultyColors[fixture.difficulty];
                            }
                            
                            // Check if we're in 2025/26 season (TBD mode)
                            if (currentSeason === '2025') {
                                fixtureCells.push(`
                                    <td class="fixture-cell" data-fixture="${fixture.gameweek}">
                                        <div class="fixture fixture-tbd" style="background-color: #f3f4f6; color: #6b7280; cursor: default;">
                                            <div style="font-weight: bold; font-size: 0.8rem;">TBD</div>
                                            <div style="font-size: 0.7rem; opacity: 0.8;">2025/26</div>
                                        </div>
                                    </td>
                                `);
                            } else {
                                fixtureCells.push(`
                                    <td class="fixture-cell" data-fixture="${fixture.gameweek}">
                                        <div class="fixture ${colorClass}" 
                                             onclick="event.stopPropagation(); showTeamMatchupDetails('${escapedTeamName}', '${escapedOpponent}', ${fixture.isHome}, ${fixture.difficulty}, '${escapedDebug}', ${team.id}, event)">
                                            <div style="font-weight: bold; font-size: 0.8rem;">${displayText}</div>
                                            ${showHistory ? '<div style="font-size: 0.7rem; opacity: 0.8;">...</div>' : ''}
                                            ${showRanks ? '<div style="font-size: 0.7rem; opacity: 0.8;">...</div>' : ''}
                                        </div>
                                    </td>
                                `);
                            }
                        } else {
                            fixtureCells.push('<td></td>');
                        }
                    }
                }
                

                
                // Get team statistics for current location
                const teamStats = teamStatsData[currentTeamLocation]?.[team.id];
                
                // Get attack and defense ranks based on location
                let attackRank = 'N/A';
                let defenseRank = 'N/A';
                let statisticValue = 'N/A';
                
                // Get attack rank based on location
                if (currentTeamLocation === 'home') {
                    attackRank = team.atk_h_rank || 20; // Default to 20 for newly promoted teams
                    defenseRank = team.def_h_rank || 20; // Default to 20 for newly promoted teams
                    console.log(`${team.name} - Home ranks: ATK=${attackRank}, DEF=${defenseRank}`);
                } else if (currentTeamLocation === 'away') {
                    attackRank = team.atk_a_rank || 20; // Default to 20 for newly promoted teams
                    defenseRank = team.def_a_rank || 20; // Default to 20 for newly promoted teams
                    console.log(`${team.name} - Away ranks: ATK=${attackRank}, DEF=${defenseRank}`);
                } else {
                    // For overall, use calculated overall rankings
                    const overallStats = teamStatsData.overall?.[team.id];
                    console.log(`${team.name} - Overall stats available:`, overallStats);
                    if (overallStats && overallStats.attack_rank !== undefined) {
                        attackRank = overallStats.attack_rank;
                        defenseRank = overallStats.defense_rank || 20;
                        console.log(`${team.name} - Overall ranks (calculated): ATK=${attackRank}, DEF=${defenseRank}`);
                    } else {
                        // If overall rankings not loaded yet, use fallback
                        console.log(`${team.name} - Overall rankings not loaded, using fallback`);
                        attackRank = team.atk_h_rank || 20;
                        defenseRank = team.def_h_rank || 20;
                        console.log(`${team.name} - Overall ranks (fallback): ATK=${attackRank}, DEF=${defenseRank}`);
                    }
                }
                
                // Get statistic value (only if team stats exist)
                if (teamStats) {
                    statisticValue = teamStats[currentTeamStat] !== undefined ? teamStats[currentTeamStat] : 'N/A';
                }
                
                // Calculate top 10 teams for conditional highlighting (only if enabled)
                const topTeams = calculateTopTeams(currentTeamStat, currentTeamLocation);
                const teamRank = topTeams.findIndex(t => t.id === team.id) + 1; // 1-based ranking
                const isTop10 = teamRank >= 1 && teamRank <= 10;
                
                // Apply conditional highlighting only if enabled
                let backgroundColor = '';
                let top10Style = '';
                if (isTop10 && showConditionalHighlight && statisticValue !== 'N/A') {
                    top10Style = `class="top-player-pill top-rank-${teamRank}" style="display: inline-block; padding: 6px 12px; font-size: 0.875rem; font-weight: 500; border: none; border-radius: 12px; color: #1F2937; min-width: 40px; text-align: center; white-space: nowrap; box-shadow: 0 2px 8px rgba(242, 198, 64, 0.25);"`;
                }
                
                // Get the current team type to determine which columns to show
                const currentTeamType = getSelectedTeamType();
                
                // Create dynamic columns based on team type
                let dynamicColumns = '';
                if (currentTeamType === 'attack') {
                    // Show Goals and xG difference
                    const goals = teamStats ? (teamStats.goals_scored || 0) : 0;
                    const xg = teamStats ? (teamStats.expected_goals || 0) : 0;
                    const xgDiff = goals - xg;
                    
                    const goalsStyle = isTop10 && showConditionalHighlight && goals > 0 ? `class="top-player-pill top-rank-${teamRank}" style="display: inline-block; padding: 6px 12px; font-size: 0.875rem; font-weight: 500; border: none; border-radius: 12px; color: #1F2937; min-width: 40px; text-align: center; white-space: nowrap; box-shadow: 0 2px 8px rgba(242, 198, 64, 0.25);"` : '';
                    
                    // Format xG difference with color
                    let xgDiffDisplay = '';
                    if (xgDiff > 0) {
                        xgDiffDisplay = `<span style="color: #43A15F; font-weight: 600;">+${xgDiff.toFixed(1)}</span>`;
                    } else if (xgDiff < 0) {
                        xgDiffDisplay = `<span style="color: #B55757; font-weight: 600;">${xgDiff.toFixed(1)}</span>`;
                    } else {
                        xgDiffDisplay = `<span style="color: #9CA3AF; opacity: 0.5;">0.0</span>`;
                    }
                    
                    dynamicColumns = `
                        <td class="goals" data-sort-value="${goals}">${goals > 0 && isTop10 && showConditionalHighlight ? `<span ${goalsStyle}>${goals}</span>` : goals > 0 ? goals : `<span style="color: #9CA3AF; opacity: 0.5;">${goals}</span>`}</td>
                        <td class="xg-diff" data-sort-value="${xgDiff}">${xgDiffDisplay}</td>
                    `;
                } else if (currentTeamType === 'defense') {
                    // Show Goals Conceded, xGC difference, and Clean Sheets
                    const gc = teamStats ? (teamStats.goals_conceded || 0) : 0;
                    const xgc = teamStats ? (teamStats.expected_goals_conceded || 0) : 0;
                    const cs = teamStats ? (teamStats.clean_sheets || 0) : 0;
                    const xgcDiff = xgc - gc; // Positive means conceding more than expected (bad)
                    
                    // Calculate individual rankings for each column
                    const topGcTeams = calculateTopTeams('goals_conceded', currentTeamLocation);
                    const topCsTeams = calculateTopTeams('clean_sheets', currentTeamLocation);
                    
                    const gcRank = topGcTeams.findIndex(t => t.id === team.id) + 1;
                    const csRank = topCsTeams.findIndex(t => t.id === team.id) + 1;
                    
                    const isTop10Gc = gcRank >= 1 && gcRank <= 10;
                    const isTop10Cs = csRank >= 1 && csRank <= 10;
                    
                    const gcStyle = isTop10Gc && showConditionalHighlight && gc > 0 ? `class="top-player-pill top-rank-${gcRank}" style="display: inline-block; padding: 6px 12px; font-size: 0.875rem; font-weight: 500; border: none; border-radius: 12px; color: #1F2937; min-width: 40px; text-align: center; white-space: nowrap; box-shadow: 0 2px 8px rgba(242, 198, 64, 0.25);"` : '';
                    const csStyle = isTop10Cs && showConditionalHighlight && cs > 0 ? `class="top-player-pill top-rank-${csRank}" style="display: inline-block; padding: 6px 12px; font-size: 0.875rem; font-weight: 500; border: none; border-radius: 12px; color: #1F2937; min-width: 40px; text-align: center; white-space: nowrap; box-shadow: 0 2px 8px rgba(242, 198, 64, 0.25);"` : '';
                    
                    // Format xGC difference with color (negative is good for defense)
                    let xgcDiffDisplay = '';
                    if (xgcDiff < 0) {
                        xgcDiffDisplay = `<span style="color: #43A15F; font-weight: 600;">${xgcDiff.toFixed(1)}</span>`;
                    } else if (xgcDiff > 0) {
                        xgcDiffDisplay = `<span style="color: #B55757; font-weight: 600;">+${xgcDiff.toFixed(1)}</span>`;
                    } else {
                        xgcDiffDisplay = `<span style="color: #9CA3AF; opacity: 0.5;">0.0</span>`;
                    }
                    
                    dynamicColumns = `
                        <td class="gc" data-sort-value="${gc}">${gc > 0 && isTop10Gc && showConditionalHighlight ? `<span ${gcStyle}>${gc}</span>` : gc > 0 ? gc : `<span style="color: #9CA3AF; opacity: 0.5;">${gc}</span>`}</td>
                        <td class="xgc-diff" data-sort-value="${xgcDiff}">${xgcDiffDisplay}</td>
                        <td class="cs" data-sort-value="${cs}">${cs > 0 && isTop10Cs && showConditionalHighlight ? `<span ${csStyle}>${cs}</span>` : cs > 0 ? cs : `<span style="color: #9CA3AF; opacity: 0.5;">${cs}</span>`}</td>
                    `;
                } else if (currentTeamType === 'goalie') {
                    // Show Saves and Clean Sheets for goalie type
                    const saves = teamStats ? (teamStats.saves || 0) : 0;
                    const cs = teamStats ? (teamStats.clean_sheets || 0) : 0;
                    
                    // Calculate individual rankings for each column
                    const topSavesTeams = calculateTopTeams('saves', currentTeamLocation);
                    const topCsTeams = calculateTopTeams('clean_sheets', currentTeamLocation);
                    
                    const savesRank = topSavesTeams.findIndex(t => t.id === team.id) + 1;
                    const csRank = topCsTeams.findIndex(t => t.id === team.id) + 1;
                    
                    const isTop10Saves = savesRank >= 1 && savesRank <= 10;
                    const isTop10Cs = csRank >= 1 && csRank <= 10;
                    
                    const savesStyle = isTop10Saves && showConditionalHighlight && saves > 0 ? `class="top-player-pill top-rank-${savesRank}" style="display: inline-block; padding: 6px 12px; font-size: 0.875rem; font-weight: 500; border: none; border-radius: 12px; color: #1F2937; min-width: 40px; text-align: center; white-space: nowrap; box-shadow: 0 2px 8px rgba(242, 198, 64, 0.25);"` : '';
                    const csStyle = isTop10Cs && showConditionalHighlight && cs > 0 ? `class="top-player-pill top-rank-${csRank}" style="display: inline-block; padding: 6px 12px; font-size: 0.875rem; font-weight: 500; border: none; border-radius: 12px; color: #1F2937; min-width: 40px; text-align: center; white-space: nowrap; box-shadow: 0 2px 8px rgba(242, 198, 64, 0.25);"` : '';
                    
                    dynamicColumns = `
                        <td class="saves" data-sort-value="${saves}">${saves > 0 && isTop10Saves && showConditionalHighlight ? `<span ${savesStyle}>${saves}</span>` : saves > 0 ? saves : `<span style="color: #9CA3AF; opacity: 0.5;">${saves}</span>`}</td>
                        <td class="cs" data-sort-value="${cs}">${cs > 0 && isTop10Cs && showConditionalHighlight ? `<span ${csStyle}>${cs}</span>` : cs > 0 ? cs : `<span style="color: #9CA3AF; opacity: 0.5;">${cs}</span>`}</td>
                    `;
                }
                
                row.setAttribute('data-team-id', team.id);
                
                // Get team badge URL
                const badgeUrl = getTeamBadgeUrl(team.name);
                const badgeHtml = badgeUrl ? `<img src="${badgeUrl}" alt="${team.name}" class="team-badge" onerror="this.style.display='none'">` : '';
                
                // Add white background styling for team name when in compare mode
                const compareModeStyle = compareMode && selectedTeams.length >= 2 ? 'style="background-color: #f8fafc; border: 1px solid #e2e8f0; padding: 8px; border-radius: 4px;"' : '';
                
                row.innerHTML = `
                    <td class="badge-cell">
                        ${badgeHtml}
                    </td>
                    <td ${compareModeStyle}><strong>${team.name}</strong></td>
                    ${dynamicColumns}
                    ${fixtureCells.join('')}
                `;
                
                tbody.appendChild(row);
            });
            
            // No pagination needed for teams view - all teams fit in one table
            
            // Load historical results if toggle is enabled
            if (showHistory) {
                console.log('Loading historical results for teams view');
                // Load historical results for all visible fixtures
                for (let gw = gameweekStart; gw <= gameweekEnd; gw++) {
                    allTeams.forEach(team => {
                        const teamFixtures = getTeamFixtures(team.id, gameweeks);
                        const fixture = teamFixtures.find(f => f.gameweek === gw);
                        if (fixture) {
                            console.log(`Loading historical results for ${team.name} vs ${fixture.opponent} (GW${gw})`);
                            loadTeamHistoricalResults(team.id, fixture.opponent, fixture.isHome, gw);
                        }
                    });
                }
            }
            
            // Load rank data if toggle is enabled
            if (showRanks) {
                console.log('Loading rank data for teams view');
                // Load rank data for all visible fixtures
                for (let gw = gameweekStart; gw <= gameweekEnd; gw++) {
                    allTeams.forEach(team => {
                        const teamFixtures = getTeamFixtures(team.id, gameweeks);
                        const fixture = teamFixtures.find(f => f.gameweek === gw);
                        if (fixture) {
                            console.log(`Loading rank data for ${team.name} vs ${fixture.opponent} (GW${gw})`);
                            loadTeamRankData(team.id, fixture, gw);
                        }
                    });
                }
            }

        }

        async function loadTeamStats() {
            try {
                const activeLocationBtn = document.querySelector('.filter-btn[data-location].active');
                const location = activeLocationBtn.dataset.location;
                console.log('Loading team stats for location:', location);
                
                const response = await fetch(`${API_BASE_URL}/api/team-stats?location=${location}`);
                const stats = await response.json();
                
                // Store stats by team_id for easy lookup
                teamStatsData[location] = {};
                stats.forEach(stat => {
                    teamStatsData[location][stat.team_id] = stat;
                });
                
                console.log(`Loaded team stats for ${location}:`, stats.length, 'teams');
                console.log('Sample team stat:', stats[0]);
            } catch (error) {
                console.error('Failed to load team stats:', error);
            }
        }

        async function loadOverallRankings() {
            try {
                const currentTeamType = getSelectedTeamType();
                const response = await fetch(`${API_BASE_URL}/api/team-rankings-overall?type=${currentTeamType}`);
                const rankings = await response.json();
                
                // Store overall rankings by team_id for easy lookup
                if (!teamStatsData.overall) {
                    teamStatsData.overall = {};
                }
                
                rankings.forEach(ranking => {
                    if (!teamStatsData.overall[ranking.team_id]) {
                        teamStatsData.overall[ranking.team_id] = {};
                    }
                    if (currentTeamType === 'attack') {
                        teamStatsData.overall[ranking.team_id].attack_rank = ranking.rank;
                    } else {
                        teamStatsData.overall[ranking.team_id].defense_rank = ranking.rank;
                    }
                });
                
                console.log(`Loaded overall ${currentTeamType} rankings:`, rankings.length, 'teams');
            } catch (error) {
                console.error('Failed to load overall rankings:', error);
            }
        }

        function updateTeamStats() {
            console.log('updateTeamStats called with currentTeamLocation:', currentTeamLocation);

            
            // Load new stats if not already loaded
            if (!teamStatsData[currentTeamLocation]) {
                console.log('Loading new team stats for location:', currentTeamLocation);
                loadTeamStats().then(() => {
                    renderTeamsTable();
                });
            } else {
                console.log('Using cached team stats for location:', currentTeamLocation);
                renderTeamsTable();
            }
        }

        async function toggleTeamSelection(teamId) {
            const index = selectedTeams.indexOf(teamId);
            
            if (index === -1) {
                // Add team to selection (at the end)
                selectedTeams.push(teamId);
                console.log(`Team ${teamId} added to selection. Selected teams:`, selectedTeams);
            } else {
                // Remove team from selection
                selectedTeams.splice(index, 1);
                console.log(`Team ${teamId} removed from selection. Selected teams:`, selectedTeams);
            }
            
            // Show/hide compare button based on selection count
            const compareBtn = document.getElementById('compare-btn');
            if (compareBtn) {
                compareBtn.style.display = selectedTeams.length >= 2 ? 'inline-block' : 'none';
            }
            
            // Re-render the table to update the order and styling
            await renderTeamsTable();
        }

        async function togglePlayerSelection(playerId) {
            const index = selectedPlayers.indexOf(playerId);
            
            if (index === -1) {
                // Add player to selection (at the end)
                selectedPlayers.push(playerId);
                console.log(`Player ${playerId} added to selection. Selected players:`, selectedPlayers);
            } else {
                // Remove player from selection
                selectedPlayers.splice(index, 1);
                console.log(`Player ${playerId} removed from selection. Selected players:`, selectedPlayers);
            }
            
            // Show/hide compare button based on selection count
            const compareBtn = document.getElementById('compare-btn');
            if (compareBtn) {
                compareBtn.style.display = selectedPlayers.length >= 2 ? 'inline-block' : 'none';
            }
            
            // Re-render the table to update the order and styling
            await renderPlayersTable();
        }

        function getRankingBadgeClass(rank) {
            if (rank === 'N/A' || rank === null || rank === undefined) {
                return '';
            }
            const rankNum = parseInt(rank);
            if (rankNum >= 1 && rankNum <= 6) {
                return 'gold';
            } else if (rankNum >= 15 && rankNum <= 20) {
                return 'red';
            }
            return ''; // Default blue
        }

        function calculateTopTeams(statistic, location) {
            // Get all teams with their statistics for the current location
            const teamsWithStats = teamsData.map(team => {
                const teamStats = teamStatsData[location]?.[team.id];
                const value = teamStats?.[statistic];
                return {
                    id: team.id,
                    name: team.name,
                    value: value !== undefined ? value : null
                };
            }).filter(team => team.value !== null && team.value !== 'N/A' && team.value > 0);
            
            // Sort teams based on the statistic
            // For goals_conceded, lower is better; for others, higher is better
            const isLowerBetter = statistic === 'goals_conceded';
            teamsWithStats.sort((a, b) => {
                if (isLowerBetter) {
                    return a.value - b.value; // Ascending for goals conceded
                } else {
                    return b.value - a.value; // Descending for goals scored, etc.
                }
            });
            
            // Return top 10 teams
            return teamsWithStats.slice(0, 10);
        }

        function getTeamFixtures(teamId, gameweeks) {
            const fixtures = [];
            // Get the correct input IDs based on current view
            const suffix = currentView === 'teams' ? '-teams' : '-players';
            const gameweekStart = parseInt(document.getElementById(`gameweek-start${suffix}`).value);
            const gameweekEnd = parseInt(document.getElementById(`gameweek-end${suffix}`).value);
            
            for (let gw = gameweekStart; gw <= gameweekEnd; gw++) {
                const fixture = fixturesData.find(f => 
                    f.event === gw && (f.team_h === teamId || f.team_a === teamId)
                );
                
                if (fixture) {
                    const isHome = fixture.team_h === teamId;
                    const opponentId = isHome ? fixture.team_a : fixture.team_h;
                    const opponent = teamsData.find(t => t.id === opponentId);
                    
                    // Calculate relative difficulty based on team vs opponent using ranking differences
                    let difficulty;
                    let debug = '';
                    if (opponent) {
                        const ourTeam = teamsData.find(t => t.id === teamId);
                        const currentTeamType = getSelectedTeamType();
                        
                        let rankDifference;
                        if (currentTeamType === 'attack') {
                            // Attack mode: Compare our attack rank vs their defense rank
                            const ourAttackRank = isHome ? (ourTeam.atk_h_rank || 10) : (ourTeam.atk_a_rank || 10);
                            const theirDefenseRank = isHome ? (opponent.def_a_rank || 10) : (opponent.def_h_rank || 10);
                            
                            // Calculate ranking difference: negative = easier (better attack vs weaker defense)
                            rankDifference = ourAttackRank - theirDefenseRank;
                            debug = `ATK${ourAttackRank}vsDEF${theirDefenseRank}(${rankDifference})`;
                        } else {
                            // Defense mode: Compare our defense rank vs their attack rank
                            const ourDefenseRank = isHome ? (ourTeam.def_h_rank || 10) : (ourTeam.def_a_rank || 10);
                            const theirAttackRank = isHome ? (opponent.atk_a_rank || 10) : (opponent.atk_h_rank || 10);
                            
                            // Calculate ranking difference: negative = easier (better defense vs weaker attack)
                            rankDifference = ourDefenseRank - theirAttackRank;
                            debug = `DEF${ourDefenseRank}vsATK${theirAttackRank}(${rankDifference})`;
                        }
                        
                        // 7-bucket system: -19 to +19 range
                        if (rankDifference <= -13) difficulty = 1;      // Easiest: -19 to -13
                        else if (rankDifference <= -7) difficulty = 2;   // -12 to -7
                        else if (rankDifference <= -2) difficulty = 3;   // -6 to -2
                        else if (rankDifference <= 1) difficulty = 4;    // Neutral: -1 to +1
                        else if (rankDifference <= 6) difficulty = 5;    // +2 to +6
                        else if (rankDifference <= 12) difficulty = 6;   // +7 to +12
                        else difficulty = 7;                             // Hardest: +13 to +19
                    } else {
                        // Fallback to original difficulty if opponent not found
                        difficulty = isHome ? fixture.team_h_difficulty : fixture.team_a_difficulty;
                        debug = `FALLBACK: ${difficulty}`;
                    }
                    
                    fixtures.push({
                        gameweek: gw,
                        isHome,
                        opponent: opponent?.short_name || 'Unknown',
                        difficulty,
                        debug
                    });
                }
            }
            
            return fixtures;
        }

        function getPlayerFixtures(teamId, gameweeks, playerPosition) {
            const fixtures = [];
            // Get the correct input IDs based on current view
            const suffix = currentView === 'teams' ? '-teams' : '-players';
            const gameweekStart = parseInt(document.getElementById(`gameweek-start${suffix}`).value);
            const gameweekEnd = parseInt(document.getElementById(`gameweek-end${suffix}`).value);
            
            for (let gw = gameweekStart; gw <= gameweekEnd; gw++) {
                const fixture = fixturesData.find(f => 
                    f.event === gw && (f.team_h === teamId || f.team_a === teamId)
                );
                
                if (fixture) {
                    const isHome = fixture.team_h === teamId;
                    const opponentId = isHome ? fixture.team_a : fixture.team_h;
                    const opponent = teamsData.find(t => t.id === opponentId);
                    
                    // Calculate relative difficulty based on player's team vs opponent using ranking differences
                    let difficulty;
                    let debug = '';
                    if (opponent) {
                        const playerTeam = teamsData.find(t => t.id === teamId);
                        
                        if (playerPosition === 'GKP' || playerPosition === 'DEF') {
                            // For defenders and goalkeepers: compare our defense rank vs their attack rank
                            const ourDefenseRank = isHome ? (playerTeam.def_h_rank || 10) : (playerTeam.def_a_rank || 10);
                            const theirAttackRank = isHome ? (opponent.atk_a_rank || 10) : (opponent.atk_h_rank || 10);
                            
                            // Calculate ranking difference: negative = easier (better defense vs weaker attack)
                            const rankDifference = ourDefenseRank - theirAttackRank;
                            
                            // 7-bucket system: -19 to +19 range
                            if (rankDifference <= -13) difficulty = 1;      // Easiest: -19 to -13
                            else if (rankDifference <= -7) difficulty = 2;   // -12 to -7
                            else if (rankDifference <= -2) difficulty = 3;   // -6 to -2
                            else if (rankDifference <= 1) difficulty = 4;    // Neutral: -1 to +1
                            else if (rankDifference <= 6) difficulty = 5;    // +2 to +6
                            else if (rankDifference <= 12) difficulty = 6;   // +7 to +12
                            else difficulty = 7;                             // Hardest: +13 to +19
                            
                            debug = `DEF${ourDefenseRank}vsATK${theirAttackRank}(${rankDifference})`;
                            
                        } else {
                            // For midfielders and forwards: compare our attack rank vs their defense rank
                            const ourAttackRank = isHome ? (playerTeam.atk_h_rank || 10) : (playerTeam.atk_a_rank || 10);
                            const theirDefenseRank = isHome ? (opponent.def_a_rank || 10) : (opponent.def_h_rank || 10);
                            
                            // Calculate ranking difference: negative = easier (better attack vs weaker defense)
                            const rankDifference = ourAttackRank - theirDefenseRank;
                            
                            // 7-bucket system: -19 to +19 range
                            if (rankDifference <= -13) difficulty = 1;      // Easiest: -19 to -13
                            else if (rankDifference <= -7) difficulty = 2;   // -12 to -7
                            else if (rankDifference <= -2) difficulty = 3;   // -6 to -2
                            else if (rankDifference <= 1) difficulty = 4;    // Neutral: -1 to +1
                            else if (rankDifference <= 6) difficulty = 5;    // +2 to +6
                            else if (rankDifference <= 12) difficulty = 6;   // +7 to +12
                            else difficulty = 7;                             // Hardest: +13 to +19
                            
                            debug = `ATK${ourAttackRank}vsDEF${theirDefenseRank}(${rankDifference})`;
                        }
                    } else {
                        // Fallback to original difficulty if opponent not found
                        difficulty = isHome ? fixture.team_h_difficulty : fixture.team_a_difficulty;
                        debug = `FALLBACK: ${difficulty}`;
                    }
                    
                    fixtures.push({
                        gameweek: gw,
                        isHome,
                        opponent: opponent?.short_name || 'Unknown',
                        difficulty,
                        debug
                    });
                }
            }
            
            return fixtures;
        }

        async function handleSort(field) {
            // Update sort direction
            if (currentSort.field === field) {
                currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.field = field;
                currentSort.direction = 'asc';
            }
            
            // Update sort indicators
            document.querySelectorAll('.sortable').forEach(th => {
                th.classList.remove('sorted-asc', 'sorted-desc');
                if (th.dataset.sort === field) {
                    th.classList.add(`sorted-${currentSort.direction}`);
                }
            });
            
            // Re-render table
            await renderTable();
        }

        function showError(message) {
            const error = document.getElementById('error');
            error.textContent = message;
            error.style.display = 'block';
        }

        async function showMatchupDetails(playerName, opponent, isHome, position, difficulty, debug, playerTeamId, event) {
            console.log('showMatchupDetails called with:', { playerName, opponent, isHome, position, difficulty, debug, playerTeamId });
            
            const modal = document.getElementById('matchupModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalContent = document.getElementById('modalContent');
            
            if (!modal) {
                console.error('Modal element not found!');
                return;
            }
            
            // Find player's team and opponent team data
            const playerTeam = teamsData.find(t => t.id === playerTeamId);
            const opponentTeam = teamsData.find(t => t.short_name === opponent);
            
            // Parse debug info to extract the calculation details
            console.log('Debug info:', debug);
            console.log('Player team data:', playerTeam);
            console.log('Opponent team data:', opponentTeam);
            const debugMatch = debug.match(/(STR|ATK|DEF)(\d+)vs(STR|ATK|DEF)(\d+)\((-?\d+)\)/);
            console.log('Debug match:', debugMatch);
            
            let details = '';
            if (debugMatch && playerTeam && opponentTeam) {
                const [_, playerMetric, playerValue, opponentMetric, opponentValue, advantage] = debugMatch;
                
                const positionText = {
                    'GKP': 'Goalkeeper',
                    'DEF': 'Defender', 
                    'MID': 'Midfielder',
                    'FWD': 'Forward'
                };
                
                const locationText = isHome ? 'Home' : 'Away';
                
                details = `
                    <div class="team-rankings">
                        <h4>Team Performance Rankings</h4>
                        <div class="ranking-row">
                            <div class="team-ranking">
                                <strong>${playerTeam.name} (${locationText})</strong><br>
                                ${position === 'GKP' || position === 'DEF' ? 
                                                                    `Defense Rank: <span class="ranking-badge ${getRankingBadgeClass(isHome ? playerTeam.def_h_rank : playerTeam.def_a_rank)}">${isHome ? (playerTeam.def_h_rank || 'N/A') : (playerTeam.def_a_rank || 'N/A')}</span>` :
                                `Attack Rank: <span class="ranking-badge ${getRankingBadgeClass(isHome ? playerTeam.atk_h_rank : playerTeam.atk_a_rank)}">${isHome ? (playerTeam.atk_h_rank || 'N/A') : (playerTeam.atk_a_rank || 'N/A')}</span>`
                                }
                            </div>
                            <div class="team-ranking">
                                <strong>${opponentTeam.name} (${isHome ? 'Away' : 'Home'})</strong><br>
                                ${position === 'GKP' || position === 'DEF' ? 
                                                                    `Attack Rank: <span class="ranking-badge ${getRankingBadgeClass(isHome ? opponentTeam.atk_a_rank : opponentTeam.atk_h_rank)}">${isHome ? (opponentTeam.atk_a_rank || 'N/A') : (opponentTeam.atk_h_rank || 'N/A')}</span>` :
                                `Defense Rank: <span class="ranking-badge ${getRankingBadgeClass(isHome ? opponentTeam.def_a_rank : opponentTeam.def_h_rank)}">${isHome ? (opponentTeam.def_a_rank || 'N/A') : (opponentTeam.def_h_rank || 'N/A')}</span>`
                                }
                            </div>
                        </div>
                    </div>
                    
                    <div class="team-rankings">
                        <h4>Difficulty Analysis</h4>
                        ${(() => {
                            // Calculate the actual rank difference based on the formula
                            let rankDifference;
                            if (position === 'GKP' || position === 'DEF') {
                                // For defenders and goalkeepers: use defense rank
                                const ourDefenseRank = isHome ? (playerTeam.def_h_rank || 10) : (playerTeam.def_a_rank || 10);
                                const theirAttackRank = isHome ? (opponentTeam.atk_a_rank || 10) : (opponentTeam.atk_h_rank || 10);
                                rankDifference = ourDefenseRank - theirAttackRank;
                            } else {
                                // For midfielders and forwards: use attack rank
                                const ourAttackRank = isHome ? (playerTeam.atk_h_rank || 10) : (playerTeam.atk_a_rank || 10);
                                const theirDefenseRank = isHome ? (opponentTeam.def_a_rank || 10) : (opponentTeam.def_h_rank || 10);
                                rankDifference = ourAttackRank - theirDefenseRank;
                            }
                            
                            // Calculate difficulty based on rank difference (7-bucket system)
                            let calculatedDifficulty;
                            if (rankDifference <= -13) calculatedDifficulty = 1;      // Easiest: -19 to -13
                            else if (rankDifference <= -7) calculatedDifficulty = 2;   // -12 to -7
                            else if (rankDifference <= -2) calculatedDifficulty = 3;   // -6 to -2
                            else if (rankDifference <= 1) calculatedDifficulty = 4;    // Neutral: -1 to +1
                            else if (rankDifference <= 6) calculatedDifficulty = 5;    // +2 to +6
                            else if (rankDifference <= 12) calculatedDifficulty = 6;   // +7 to +12
                            else calculatedDifficulty = 7;                             // Hardest: +13 to +19
                            
                            return `
                                <p><strong>Difficulty Rating:</strong> ${calculatedDifficulty} <span style="display: inline-block; width: 16px; height: 16px; border-radius: 50%; background-color: ${calculatedDifficulty <= 2 ? '#43A15F' : calculatedDifficulty <= 3 ? '#A8E0BB' : calculatedDifficulty <= 4 ? '#FAFAFA' : calculatedDifficulty <= 5 ? '#fef2f2' : calculatedDifficulty <= 6 ? '#E3B3B3' : calculatedDifficulty <= 7 ? '#B55757' : '#B55757'}; border: 1px solid ${calculatedDifficulty <= 2 ? '#15803d' : calculatedDifficulty <= 3 ? '#15803d' : calculatedDifficulty <= 4 ? '#d1d5db' : calculatedDifficulty <= 5 ? '#991b1b' : calculatedDifficulty <= 6 ? '#b91c1c' : calculatedDifficulty <= 7 ? '#991b1b' : '#991b1b'}; margin-left: 6px; vertical-align: middle;"></span></p>
                                <p style="font-size: 0.85rem; color: #6b7280; margin-top: 8px;">
                                    <em>${position === 'GKP' || position === 'DEF' ? 
                                        `${playerTeam.short_name} Defense ${isHome ? (playerTeam.def_h_rank || 'N/A') : (playerTeam.def_a_rank || 'N/A')}${getOrdinalSuffix(isHome ? playerTeam.def_h_rank : playerTeam.def_a_rank)}${isHome ? ' (H)' : ' (A)'} - ${opponentTeam.short_name} Attack ${isHome ? (opponentTeam.atk_a_rank || 'N/A') : (opponentTeam.atk_h_rank || 'N/A')}${getOrdinalSuffix(isHome ? opponentTeam.atk_a_rank : opponentTeam.atk_h_rank)}${isHome ? ' (A)' : ' (H)'} = ${rankDifference}` :
                                        `${playerTeam.short_name} Attack ${isHome ? (playerTeam.atk_h_rank || 'N/A') : (playerTeam.atk_a_rank || 'N/A')}${getOrdinalSuffix(isHome ? playerTeam.atk_h_rank : playerTeam.atk_a_rank)}${isHome ? ' (H)' : ' (A)'} - ${opponentTeam.short_name} Defense ${isHome ? (opponentTeam.def_a_rank || 'N/A') : (opponentTeam.def_h_rank || 'N/A')}${getOrdinalSuffix(isHome ? opponentTeam.def_a_rank : opponentTeam.def_h_rank)}${isHome ? ' (A)' : ' (H)'} = ${rankDifference}`
                                    }</em>
                                </p>
                                
                                <div class="difficulty-scale-container">
                                    <div class="difficulty-scale">
                                        <div class="difficulty-indicator" style="left: ${calculateIndicatorPosition(rankDifference)}%;"></div>
                                    </div>
                                    <div class="scale-labels">
                                        <div class="scale-label">Very Easy<br><span class="scale-range">-19 to -13</span></div>
                                        <div class="scale-label">Easy<br><span class="scale-range">-12 to -7</span></div>
                                        <div class="scale-label">Easy+<br><span class="scale-range">-6 to -2</span></div>
                                        <div class="scale-label">Neutral<br><span class="scale-range">-1 to +1</span></div>
                                        <div class="scale-label">Hard+<br><span class="scale-range">+2 to +6</span></div>
                                        <div class="scale-label">Hard<br><span class="scale-range">+7 to +12</span></div>
                                        <div class="scale-label">Very Hard<br><span class="scale-range">+13 to +19</span></div>
                                    </div>
                                </div>
                            `;
                        })()}
                    </div>
                    
                    <div class="team-rankings" id="fixture-history-container">
                        <h4>Last Season vs ${opponentTeam.name}</h4>
                        <div class="loading">Loading fixture history...</div>
                    </div>
                `;
            } else {
                details = `
                    <p>Unable to parse matchup details. Debug info: ${debug}</p>
                `;
            }
            
            const locationText = isHome ? 'Home' : 'Away';
            modalTitle.textContent = `${playerName} (${locationText}) vs ${opponent}`;
            modalContent.innerHTML = details;
            modal.style.display = 'block';
            
            // Position modal near click location
            setTimeout(() => {
                const modalContent = modal.querySelector('.modal-content');
                if (modalContent && event) {
                    positionModalNearClick(modalContent, event);
                } else {
                    // Fallback to center positioning if no event data
                    const modalContent = modal.querySelector('.modal-content');
                    if (modalContent) {
                        modalContent.style.top = '50%';
                        modalContent.style.left = '50%';
                        modalContent.style.transform = 'translate(-50%, -50%)';
                    }
                }
            }, 10);
            
            // Check if opponent is newly promoted (no meaningful historical data)
            const newlyPromotedTeams = ['BUR', 'LEE', 'SUN'];
            const isNewlyPromoted = newlyPromotedTeams.includes(opponentTeam.short_name);
            
            // Load fixture history only for non-newly promoted teams
            if (opponentTeam && !isNewlyPromoted) {
                try {
                    const response = await fetch(`${API_BASE_URL}/api/player-fixture-history?player_name=${encodeURIComponent(playerName)}&opponent_team_id=${opponentTeam.id}`);
                    const data = await response.json();
                    
                    const historyContainer = document.getElementById('fixture-history-container');
                    if (data.is_new_player) {
                        historyContainer.innerHTML = `
                            <h4>Last Season vs ${opponentTeam.name}</h4>
                            <p><em>New player - no 2024 data available</em></p>
                        `;
                    } else if (data.fixtures && data.fixtures.length > 0) {
                        const homeFixture = data.fixtures.find(f => f.was_home);
                        const awayFixture = data.fixtures.find(f => !f.was_home);
                        const currentLocation = isHome ? 'Home' : 'Away';
                        const highlightClass = isHome ? 'highlight-home' : 'highlight-away';

                        // Determine stat rows by position
                        let statRows = [];
                        if (position === 'GKP') {
                            statRows = [
                                { label: 'Gameweek', key: 'gameweek' },
                                { label: 'Total Points', key: 'total_points' },
                                { label: 'Minutes', key: 'minutes' },
                                { label: 'Clean Sheets', key: 'clean_sheets' },
                                { label: 'Saves', key: 'saves' },
                                { label: 'Goals Conceded', key: 'goals_conceded' },
                                { label: 'Bonus', key: 'bonus' },
                                { label: 'xGC', key: 'expected_goals_conceded' }
                            ];
                        } else if (position === 'DEF') {
                            statRows = [
                                { label: 'Gameweek', key: 'gameweek' },
                                { label: 'Total Points', key: 'total_points' },
                                { label: 'Minutes', key: 'minutes' },
                                { label: 'Clean Sheets', key: 'clean_sheets' },
                                { label: 'Goals', key: 'goals_scored' },
                                { label: 'Assists', key: 'assists' },
                                { label: 'Bonus', key: 'bonus' },
                                { label: 'xG', key: 'expected_goals' },
                                { label: 'xA', key: 'expected_assists' }
                            ];
                        } else {
                            // MID, FWD
                            statRows = [
                                { label: 'Gameweek', key: 'gameweek' },
                                { label: 'Total Points', key: 'total_points' },
                                { label: 'Minutes', key: 'minutes' },
                                { label: 'Goals', key: 'goals_scored' },
                                { label: 'Assists', key: 'assists' },
                                { label: 'Bonus', key: 'bonus' },
                                { label: 'xG', key: 'expected_goals' },
                                { label: 'xA', key: 'expected_assists' }
                            ];
                        }

                        // Only show stat if at least one fixture has a value for it (but always show key stats)
                        statRows = statRows.filter(row => {
                            // Always show key stats even if they're 0 or undefined
                            if (['gameweek', 'total_points', 'minutes', 'clean_sheets', 'saves', 'goals_conceded', 'bonus', 'expected_goals_conceded'].includes(row.key)) {
                                return true;
                            }
                            return (homeFixture && homeFixture[row.key] !== undefined) || (awayFixture && awayFixture[row.key] !== undefined);
                        });

                        let statRowsHtml = statRows.map(row => `
                            <tr>
                                <td>${row.label}</td>
                                <td class="${isHome ? highlightClass : ''}">${isHome ? (homeFixture && homeFixture[row.key] !== undefined ? homeFixture[row.key] : '0') : (awayFixture && awayFixture[row.key] !== undefined ? awayFixture[row.key] : '0')}</td>
                                <td class="${!isHome ? highlightClass : ''}">${isHome ? (awayFixture && awayFixture[row.key] !== undefined ? awayFixture[row.key] : '0') : (homeFixture && homeFixture[row.key] !== undefined ? homeFixture[row.key] : '0')}</td>
                            </tr>
                        `).join('');

                        historyContainer.innerHTML = `
                            <h4>Last Season vs ${opponentTeam.name} (${isHome ? 'Home' : 'Away'})</h4>
                            <table class="fixture-history-table">
                                <thead>
                                    <tr>
                                        <th>Statistic</th>
                                        <th class="${isHome ? highlightClass : ''}">Home</th>
                                        <th class="${!isHome ? highlightClass : ''}">Away</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${statRowsHtml}
                                </tbody>
                            </table>
                        `;
                    } else {
                        historyContainer.innerHTML = `
                            <h4>Last Season vs ${opponentTeam.name} (${isHome ? 'Home' : 'Away'})</h4>
                            <p><em>No fixture data available</em></p>
                        `;
                    }
                } catch (error) {
                    const historyContainer = document.getElementById('fixture-history-container');
                    historyContainer.innerHTML = `
                        <h4>Last Season vs ${opponentTeam.name} (${isHome ? 'Home' : 'Away'})</h4>
                        <p><em>Error loading fixture history</em></p>
                    `;
                }
            } else if (isNewlyPromoted) {
                // Hide fixture history for newly promoted teams
                const historyContainer = document.getElementById('fixture-history-container');
                historyContainer.style.display = 'none';
            }
        }

        async function showTeamMatchupDetails(teamName, opponent, isHome, difficulty, debug, teamId, event) {
            console.log('showTeamMatchupDetails called with:', { teamName, opponent, isHome, difficulty, debug, teamId });
            
            const modal = document.getElementById('matchupModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalContent = document.getElementById('modalContent');
            
            if (!modal) {
                console.error('Modal element not found!');
                return;
            }
            
            // Find team and opponent team data
            const team = teamsData.find(t => t.id === teamId);
            const opponentTeam = teamsData.find(t => t.short_name === opponent);
            
            // Check if opponent is newly promoted (no meaningful historical data)
            const newlyPromotedTeams = ['BUR', 'LEE', 'SUN'];
            const isNewlyPromoted = newlyPromotedTeams.includes(opponentTeam.short_name);
            
            // Parse debug info to extract the calculation details
            console.log('Debug info:', debug);
            const debugMatch = debug.match(/OPP_STR:(\d+)/);
            console.log('Debug match:', debugMatch);
            
            let details = '';
            if (team && opponentTeam) {
                
                const locationText = isHome ? 'Home' : 'Away';
                
                details = `
                    <div class="team-rankings">
                        <h4>Team Rankings Comparison</h4>
                        <div class="ranking-row">
                            <div class="team-ranking">
                                <strong>${team.name} (${locationText})</strong><br>
                                ${currentTeamType === 'attack' ? 
                                    `Attack Rank: <span class="ranking-badge ${getRankingBadgeClass(isHome ? team.atk_h_rank : team.atk_a_rank)}">${isHome ? (team.atk_h_rank || 'N/A') : (team.atk_a_rank || 'N/A')}</span>` :
                                    `Defense Rank: <span class="ranking-badge ${getRankingBadgeClass(isHome ? team.def_h_rank : team.def_a_rank)}">${isHome ? (team.def_h_rank || 'N/A') : (team.def_a_rank || 'N/A')}</span>`
                                }
                            </div>
                            <div class="team-ranking">
                                <strong>${opponentTeam.name} (${isHome ? 'Away' : 'Home'})</strong><br>
                                ${currentTeamType === 'attack' ? 
                                    `Defense Rank: <span class="ranking-badge ${getRankingBadgeClass(isHome ? opponentTeam.def_a_rank : opponentTeam.def_h_rank)}">${isHome ? (opponentTeam.def_a_rank || 'N/A') : (opponentTeam.def_h_rank || 'N/A')}</span>` :
                                    `Attack Rank: <span class="ranking-badge ${getRankingBadgeClass(isHome ? opponentTeam.atk_a_rank : opponentTeam.atk_h_rank)}">${isHome ? (opponentTeam.atk_a_rank || 'N/A') : (opponentTeam.atk_h_rank || 'N/A')}</span>`
                                }
                            </div>
                        </div>
                    </div>
                    
                    <div class="team-rankings">
                        <h4>Difficulty Analysis</h4>
                        ${(() => {
                            // Calculate the actual rank difference based on the team type
                            let rankDifference;
                            if (currentTeamType === 'attack') {
                                // For attacking teams: use our attack rank vs their defense rank
                                const ourAttackRank = isHome ? (team.atk_h_rank || 10) : (team.atk_a_rank || 10);
                                const theirDefenseRank = isHome ? (opponentTeam.def_a_rank || 10) : (opponentTeam.def_h_rank || 10);
                                rankDifference = ourAttackRank - theirDefenseRank;
                            } else {
                                // For defending teams: use our defense rank vs their attack rank
                                const ourDefenseRank = isHome ? (team.def_h_rank || 10) : (team.def_a_rank || 10);
                                const theirAttackRank = isHome ? (opponentTeam.atk_a_rank || 10) : (opponentTeam.atk_h_rank || 10);
                                rankDifference = ourDefenseRank - theirAttackRank;
                            }
                            
                            // Calculate difficulty based on rank difference (7-bucket system)
                            let calculatedDifficulty;
                            if (rankDifference <= -13) calculatedDifficulty = 1;      // Easiest: -19 to -13
                            else if (rankDifference <= -7) calculatedDifficulty = 2;   // -12 to -7
                            else if (rankDifference <= -2) calculatedDifficulty = 3;   // -6 to -2
                            else if (rankDifference <= 1) calculatedDifficulty = 4;    // Neutral: -1 to +1
                            else if (rankDifference <= 6) calculatedDifficulty = 5;    // +2 to +6
                            else if (rankDifference <= 12) calculatedDifficulty = 6;   // +7 to +12
                            else calculatedDifficulty = 7;                             // Hardest: +13 to +19
                            
                            return `
                                <p><strong>Difficulty Rating:</strong> ${calculatedDifficulty} <span style="display: inline-block; width: 16px; height: 16px; border-radius: 50%; background-color: ${calculatedDifficulty <= 2 ? '#43A15F' : calculatedDifficulty <= 3 ? '#A8E0BB' : calculatedDifficulty <= 4 ? '#FAFAFA' : calculatedDifficulty <= 5 ? '#fef2f2' : calculatedDifficulty <= 6 ? '#E3B3B3' : calculatedDifficulty <= 7 ? '#B55757' : '#B55757'}; border: 1px solid ${calculatedDifficulty <= 2 ? '#15803d' : calculatedDifficulty <= 3 ? '#15803d' : calculatedDifficulty <= 4 ? '#d1d5db' : calculatedDifficulty <= 5 ? '#991b1b' : calculatedDifficulty <= 6 ? '#b91c1c' : calculatedDifficulty <= 7 ? '#991b1b' : '#991b1b'}; margin-left: 6px; vertical-align: middle;"></span></p>
                                <p style="font-size: 0.85rem; color: #6b7280; margin-top: 8px;">
                                    <em>${currentTeamType === 'attack' ? 
                                        `${team.short_name} Attack ${isHome ? (team.atk_h_rank || 'N/A') : (team.atk_a_rank || 'N/A')}${getOrdinalSuffix(isHome ? team.atk_h_rank : team.atk_a_rank)}${isHome ? ' (H)' : ' (A)'} - ${opponentTeam.short_name} Defense ${isHome ? (opponentTeam.def_a_rank || 'N/A') : (opponentTeam.def_h_rank || 'N/A')}${getOrdinalSuffix(isHome ? opponentTeam.def_a_rank : opponentTeam.def_h_rank)}${isHome ? ' (A)' : ' (H)'} = ${rankDifference}` :
                                        `${team.short_name} Defense ${isHome ? (team.def_h_rank || 'N/A') : (team.def_a_rank || 'N/A')}${getOrdinalSuffix(isHome ? team.def_h_rank : team.def_a_rank)}${isHome ? ' (H)' : ' (A)'} - ${opponentTeam.short_name} Attack ${isHome ? (opponentTeam.atk_a_rank || 'N/A') : (opponentTeam.atk_h_rank || 'N/A')}${getOrdinalSuffix(isHome ? opponentTeam.atk_a_rank : opponentTeam.atk_h_rank)}${isHome ? ' (A)' : ' (H)'} = ${rankDifference}`
                                    }</em>
                                </p>
                                
                                <div class="difficulty-scale-container">
                                    <div class="difficulty-scale">
                                        <div class="difficulty-indicator" style="left: ${calculateIndicatorPosition(rankDifference)}%;"></div>
                                    </div>
                                    <div class="scale-labels">
                                        <div class="scale-label">Very Easy<br><span class="scale-range">-19 to -13</span></div>
                                        <div class="scale-label">Easy<br><span class="scale-range">-12 to -7</span></div>
                                        <div class="scale-label">Easy+<br><span class="scale-range">-6 to -2</span></div>
                                        <div class="scale-label">Neutral<br><span class="scale-range">-1 to +1</span></div>
                                        <div class="scale-label">Hard+<br><span class="scale-range">+2 to +6</span></div>
                                        <div class="scale-label">Hard<br><span class="scale-range">+7 to +12</span></div>
                                        <div class="scale-label">Very Hard<br><span class="scale-range">+13 to +19</span></div>
                                    </div>
                                </div>
                            `;
                        })()}
                    </div>
                `;
            } else {
                details = `
                    <p>Unable to parse matchup details. Debug info: ${debug}</p>
                `;
            }
            
            const locationText = isHome ? 'Home' : 'Away';
            modalTitle.textContent = `${teamName} (${locationText}) vs ${opponent}`;
            
            // Set subtitle based on current team filter settings
            const modalSubtitle = document.getElementById('modalSubtitle');
            const teamTypeText = currentTeamType === 'attack' ? 'Attacking' : 'Defending';
            modalSubtitle.textContent = teamTypeText;
            
            modalContent.innerHTML = details;
            modal.style.display = 'block';
            
            // Position modal near click location
            setTimeout(() => {
                const modalContent = modal.querySelector('.modal-content');
                if (modalContent && event) {
                    const rect = modalContent.getBoundingClientRect();
                    const viewportWidth = window.innerWidth;
                    const viewportHeight = window.innerHeight;
                    
                    // Get click coordinates
                    const clickX = event.clientX;
                    const clickY = event.clientY;
                    
                    positionModalNearClick(modalContent, event);
                } else {
                    // Fallback to center positioning if no event data
                    const modalContent = modal.querySelector('.modal-content');
                    if (modalContent) {
                        modalContent.style.top = '50%';
                        modalContent.style.left = '50%';
                        modalContent.style.transform = 'translate(-50%, -50%)';
                    }
                }
            }, 10);
        }
        

        
        function resetFiltersOnViewSwitch() {
            // Reset all filters and toggles when switching between views
            // This is a lighter version of resetFilters() that doesn't reload data
            
            // Reset gameweek range
            const gameweekStart = document.getElementById('gameweek-start');
            const gameweekEnd = document.getElementById('gameweek-end');
            if (gameweekStart) gameweekStart.value = '1';
            if (gameweekEnd) gameweekEnd.value = '5';
            
            // Reset position buttons to ALL (only if they exist)
            selectedPositions = [];
            const positionButtons = document.querySelectorAll('.filter-btn[data-position]');
            if (positionButtons.length > 0) {
                positionButtons.forEach(btn => btn.classList.remove('active'));
                const allPositionBtn = document.querySelector('.filter-btn[data-position=""]');
                if (allPositionBtn) allPositionBtn.classList.add('active');
            }
            
            // Reset stat filter (only if it exists)
            const statFilter = document.getElementById('stat-filter');
            if (statFilter) statFilter.value = 'total_points';
            
            // Reset team view filters (only if they exist)
            const locationButtons = document.querySelectorAll('.filter-btn[data-location]');
            if (locationButtons.length > 0) {
                locationButtons.forEach(btn => {
                    btn.classList.remove('active');
                    console.log('Reset: Removed active from location button:', btn.dataset.location);
                });
                const overallLocationBtn = document.querySelector('.filter-btn[data-location="overall"]');
                if (overallLocationBtn) {
                    overallLocationBtn.classList.add('active');
                    console.log('Reset: Added active to overall location button');
                }
                
                // Verify only one location button is active after reset
                const activeLocationButtons = document.querySelectorAll('.filter-btn[data-location].active');
                console.log('Reset: Active location buttons after reset:', activeLocationButtons.length);
                if (activeLocationButtons.length > 1) {
                    console.error('Reset: Multiple location buttons active! Fixing...');
            document.querySelectorAll('.filter-btn[data-location]').forEach(btn => btn.classList.remove('active'));
                    if (overallLocationBtn) overallLocationBtn.classList.add('active');
                }
            }
            
            const typeButtons = document.querySelectorAll('.filter-btn[data-type]');
            if (typeButtons.length > 0) {
                typeButtons.forEach(btn => btn.classList.remove('active'));
                const attackTypeBtn = document.querySelector('.filter-btn[data-type="attack"]');
                if (attackTypeBtn) attackTypeBtn.classList.add('active');
            }
            
            const statButtons = document.querySelectorAll('.filter-btn[data-stat]');
            if (statButtons.length > 0) {
                statButtons.forEach(btn => btn.classList.remove('active'));
                const goalsScoredBtn = document.querySelector('.filter-btn[data-stat="goals_scored"]');
                if (goalsScoredBtn) goalsScoredBtn.classList.add('active');
            }
            
            // Reset team selection
            selectedTeams = [];
            selectedPlayers = [];
            currentTeamLocation = 'overall';
            currentTeamType = 'attack';
            currentTeamStat = 'goals_scored';
            
            // Reset pagination (only for players view)
            if (currentView === 'players') {
            currentPage = 1;
            resultsPerPage = 25;
                const resultsPerPageSelect = document.getElementById('results-per-page');
                if (resultsPerPageSelect) resultsPerPageSelect.value = '25';
            }
            
            // Reset toggles (only if they exist)
            const conditionalHighlightToggle = document.getElementById('conditional-highlight-toggle');
            const conditionalHighlightToggleTeams = document.getElementById('conditional-highlight-toggle-teams');
            if (conditionalHighlightToggle) conditionalHighlightToggle.checked = true;
            if (conditionalHighlightToggleTeams) conditionalHighlightToggleTeams.checked = true;
            
            const per90Toggle = document.getElementById('per90-toggle');
            if (per90Toggle) per90Toggle.checked = false;
            
            showConditionalHighlight = true;
            showPer90 = false;
            
            // Reset rank/history filter to "None" (only if it exists)
            const rankFilterContainer = document.querySelector('.rank-filter-container');
            if (rankFilterContainer) {
                document.querySelectorAll('.rank-filter-container .filter-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                const noneBtn = document.querySelector('.rank-filter-container .filter-btn[data-rank="none"]');
                if (noneBtn) {
                    noneBtn.classList.add('active');
                }
            } else {
                console.log('No rank filter container found (this is normal for teams view)');
            }
            showRanks = false;
            showHistory = false;
            
            console.log('Filters reset for view switch');
        }

        function checkFiltersModified() {
            // Check if any filters have been modified from defaults
            const gameweekStartPlayers = document.getElementById('gameweek-start-players').value;
            const gameweekEndPlayers = document.getElementById('gameweek-end-players').value;
            const gameweekStartTeams = document.getElementById('gameweek-start-teams').value;
            const gameweekEndTeams = document.getElementById('gameweek-end-teams').value;
            const searchInput = document.getElementById('search-input').value;
            const statFilter = document.getElementById('stat-filter');
            
            // Check if position filters are modified (not ALL selected)
            const allPositionBtn = document.querySelector('.filter-btn[data-position=""]');
            const isPositionModified = !allPositionBtn || !allPositionBtn.classList.contains('active');
            
            // Check if location filters are modified (not overall selected)
            const overallLocationBtn = document.querySelector('.filter-btn[data-location="overall"]');
            const isLocationModified = !overallLocationBtn || !overallLocationBtn.classList.contains('active');
            
            // Check if type filters are modified (not attack selected)
            const attackTypeBtn = document.querySelector('.filter-btn[data-type="attack"]');
            const isTypeModified = !attackTypeBtn || !attackTypeBtn.classList.contains('active');
            
            // Check if rank filters are modified (not none selected)
            const noneRankBtn = document.querySelector('.filter-btn[data-rank="none"]');
            const isRankModified = !noneRankBtn || !noneRankBtn.classList.contains('active');
            
            // Check if stat filters are modified (not goals_scored selected)
            const goalsScoredStatBtn = document.querySelector('.filter-btn[data-stat="goals_scored"]');
            const isStatModified = !goalsScoredStatBtn || !goalsScoredStatBtn.classList.contains('active');
            
            // Check if toggles are modified (per90 is now part of display filter)
            const isToggleModified = false; // No separate toggles anymore
            
            // Determine if any filter is modified
            const isModified = gameweekStartPlayers !== '1' || 
                              gameweekEndPlayers !== '5' || 
                              gameweekStartTeams !== '1' || 
                              gameweekEndTeams !== '5' || 
                              searchInput !== '' || 
                              isPositionModified || 
                              isLocationModified || 
                              isTypeModified || 
                              isRankModified || 
                              isStatModified || 
                              isToggleModified ||
                              (statFilter && statFilter.value !== 'total_points');
            
            // Show/hide reset button only if there's an actual change from the previous state
            const resetBtn = document.getElementById('reset-btn');
            if (resetBtn) {
                if (isModified && !filtersModified) {
                    // Filters just became modified - show the button
                    resetBtn.style.display = 'inline-block';
                } else if (!isModified && filtersModified) {
                    // Filters just became unmodified - hide the button
                    resetBtn.style.display = 'none';
                } else if (!isModified && !filtersModified) {
                    // Ensure button is hidden when filters are not modified
                    resetBtn.style.display = 'none';
                }
            }
            
            filtersModified = isModified;
            return isModified;
        }
        
        function resetFilters() {
            // Reset all filters to default values
            document.getElementById('gameweek-start-players').value = '1';
            document.getElementById('gameweek-end-players').value = '5';
            document.getElementById('gameweek-start-teams').value = '1';
            document.getElementById('gameweek-end-teams').value = '5';
            
            // Reset position buttons to ALL
            selectedPositions = [];
            document.querySelectorAll('.filter-btn[data-position]').forEach(btn => btn.classList.remove('active'));
            const allPositionBtn = document.querySelector('.filter-btn[data-position=""]');
            if (allPositionBtn) {
                allPositionBtn.classList.add('active');
            }
            
            // Reset stat filter
            const statFilter = document.getElementById('stat-filter');
            if (statFilter) {
                statFilter.value = 'total_points';
            }
            

            
            // Reset team view filters
            document.querySelectorAll('.filter-btn[data-location]').forEach(btn => btn.classList.remove('active'));
            const overallLocationBtn = document.querySelector('.filter-btn[data-location="overall"]');
            if (overallLocationBtn) {
                overallLocationBtn.classList.add('active');
            }
            
            // Reset type filter - ensure mutual exclusivity
            document.querySelectorAll('.filter-btn[data-type]').forEach(btn => {
                btn.classList.remove('active');
                console.log('Reset: Removed active from type button:', btn.dataset.type);
            });
            const attackTypeBtn = document.querySelector('.filter-btn[data-type="attack"]');
            if (attackTypeBtn) {
                attackTypeBtn.classList.add('active');
                console.log('Reset: Added active to attack button');
            }
            
            // Verify only one type button is active after reset
            const activeTypeButtons = document.querySelectorAll('.filter-btn[data-type].active');
            console.log('Reset: Active type buttons after reset:', activeTypeButtons.length);
            if (activeTypeButtons.length > 1) {
                console.error('Reset: Multiple type buttons active! Fixing...');
            document.querySelectorAll('.filter-btn[data-type]').forEach(btn => btn.classList.remove('active'));
                if (attackTypeBtn) attackTypeBtn.classList.add('active');
            }
            
            document.querySelectorAll('.filter-btn[data-stat]').forEach(btn => btn.classList.remove('active'));
            const goalsScoredStatBtn = document.querySelector('.filter-btn[data-stat="goals_scored"]');
            if (goalsScoredStatBtn) {
                goalsScoredStatBtn.classList.add('active');
            }
            
            // Reset team selection
            selectedTeams = [];
            selectedPlayers = [];
            filteredPlayers = [];
            currentTeamLocation = 'overall';
            currentTeamType = 'attack';
            currentTeamStat = 'goals_scored';
            
            // Reset pagination
            currentPage = 1;
            resultsPerPage = 25;
            const resultsPerPageSelect = document.getElementById('results-per-page');
            if (resultsPerPageSelect) {
                resultsPerPageSelect.value = '25';
            }
            
            // Reset toggles
            showConditionalHighlight = true; // Always on by default
            showPer90 = false;
            showRankMode = false;
            
            // Reset display filter to "None" and hide description
            document.querySelectorAll('.rank-filter-container .filter-btn').forEach(btn => btn.classList.remove('active'));
            const noneBtn = document.querySelector('.rank-filter-container .filter-btn[data-rank="none"]');
            if (noneBtn) {
                noneBtn.classList.add('active');
            }
            const descriptionElement = document.getElementById('display-description');
            if (descriptionElement) {
                descriptionElement.style.display = 'none';
            }
            

            
            // Reset search input
            const searchInput = document.getElementById('search-input');
            if (searchInput) {
                searchInput.value = '';
            }
            searchTerm = '';
            
            // Update the table to reflect the reset gameweek range
            updateGameweeks();
            
            // Hide reset button after resetting and ensure it stays hidden
            const resetBtn = document.getElementById('reset-btn');
            if (resetBtn) {
                resetBtn.style.display = 'none';
            }
            filtersModified = false;
            
            // Force the button to stay hidden for a bit longer to prevent other events from showing it
            setTimeout(() => {
                const resetBtn = document.getElementById('reset-btn');
                if (resetBtn) {
                    resetBtn.style.display = 'none';
                }
                filtersModified = false;
            }, 100);
            
            // Reset sorting to default
            currentSort = { field: 'total_points', direction: 'desc' };
            
            // Clear all sort indicators from table headers
            document.querySelectorAll('th').forEach(th => {
                th.classList.remove('sorted-asc', 'sorted-desc');
            });
            
            // Reset rank/history filter to "None"
            const rankFilterContainer = document.querySelector('.rank-filter-container');
            if (rankFilterContainer) {
                document.querySelectorAll('.rank-filter-container .filter-btn').forEach(btn => {
                    btn.classList.remove('active');
                    console.log('Reset: Removed active from rank button:', btn.dataset.rank);
                });
                const noneBtn = document.querySelector('.rank-filter-container .filter-btn[data-rank="none"]');
                if (noneBtn) {
                    noneBtn.classList.add('active');
                    console.log('Reset: Added active to none button');
                }
                
                // Verify only one rank button is active after reset
                const activeRankButtons = document.querySelectorAll('.rank-filter-container .filter-btn.active');
                console.log('Reset: Active rank buttons after reset:', activeRankButtons.length);
                if (activeRankButtons.length > 1) {
                    console.error('Reset: Multiple rank buttons active! Fixing...');
                    document.querySelectorAll('.rank-filter-container .filter-btn').forEach(btn => btn.classList.remove('active'));
                    if (noneBtn) noneBtn.classList.add('active');
                }
            } else {
                console.log('No rank filter container found (this is normal for teams view)');
            }
            showRanks = false;
            showHistory = false;
            
            // Update stat column and reload data
            updateStatColumn();
            loadData();
            
            console.log('All filters and sorting reset to default values');
        }
        

        
        async function updateStatColumn() {
            const statFilter = document.getElementById('stat-filter');
            const statHeader = document.getElementById('stat-header');
            const selectedStat = statFilter.value;
            
            // Only update if we're in players view and the header exists
            if (currentView === 'players' && statHeader) {
                // Update header text for players view only
                const statLabels = {
                    'total_points': 'Points',
                    'goals_scored': 'Goals',
                    'assists': 'Assists',
                    'goals_assists': 'G+A',
                    'expected_goals': 'xG',
                    'expected_assists': 'xA',
                    'clean_sheets': 'Clean Sheets',
                    'goals_conceded': 'Goals Conceded',
                    'bonus': 'Bonus',
                    'saves': 'Saves'
                };
                
                statHeader.textContent = statLabels[selectedStat] || 'Points';
                statHeader.dataset.sort = selectedStat;
            }
            
            // Update current sort if it was on the stat column
            if (currentSort.field === 'total_points' || 
                currentSort.field === 'atk_h_rank' ||
                currentSort.field === 'atk_a_rank' ||
                currentSort.field === 'def_h_rank' ||
                currentSort.field === 'def_a_rank' ||
                currentSort.field === 'goals_scored' || 
                currentSort.field === 'assists' || 
                currentSort.field === 'goals_assists' || 
                currentSort.field === 'expected_goals' || 
                currentSort.field === 'expected_assists' ||
                currentSort.field === 'clean_sheets' ||
                currentSort.field === 'goals_conceded' ||
                currentSort.field === 'bonus' ||
                currentSort.field === 'saves') {
                currentSort.field = selectedStat;
            }
            
            // Reload data to update the view
            loadData();
        }
        
        function updateTeamTableHeaders() {
            const tableHeader = document.getElementById('team-table-header');
            const currentTeamType = getSelectedTeamType();
            
            // Remove existing dynamic headers (keep only the Team header)
            const existingHeaders = tableHeader.querySelectorAll('th:not([data-sort="name"])');
            existingHeaders.forEach(th => th.remove());
            
            // Add badge column header (empty header)
            const badgeHeader = document.createElement('th');
            badgeHeader.className = 'badge-header';
            badgeHeader.style.width = '40px';
            badgeHeader.style.padding = '8px 4px';
            tableHeader.insertBefore(badgeHeader, tableHeader.firstChild);
            
            // Add headers based on team type
            if (currentTeamType === 'attack') {
                // Add Goals and xG difference headers
                const goalsHeader = document.createElement('th');
                goalsHeader.className = 'sortable';
                goalsHeader.setAttribute('data-sort', 'goals_scored');
                goalsHeader.textContent = 'G';
                tableHeader.appendChild(goalsHeader);
                
                const xgDiffHeader = document.createElement('th');
                xgDiffHeader.className = 'sortable';
                xgDiffHeader.setAttribute('data-sort', 'xg_diff');
                xgDiffHeader.textContent = 'xG ';
                tableHeader.appendChild(xgDiffHeader);
            } else if (currentTeamType === 'defense') {
                // Add Goals Conceded, xGC difference, and Clean Sheets headers
                const gcHeader = document.createElement('th');
                gcHeader.className = 'sortable';
                gcHeader.setAttribute('data-sort', 'goals_conceded');
                gcHeader.textContent = 'GC';
                tableHeader.appendChild(gcHeader);
                
                const xgcDiffHeader = document.createElement('th');
                xgcDiffHeader.className = 'sortable';
                xgcDiffHeader.setAttribute('data-sort', 'xgc_diff');
                xgcDiffHeader.textContent = 'xGC ';
                tableHeader.appendChild(xgcDiffHeader);
                
                const csHeader = document.createElement('th');
                csHeader.className = 'sortable';
                csHeader.setAttribute('data-sort', 'clean_sheets');
                csHeader.textContent = 'CS';
                tableHeader.appendChild(csHeader);
            } else if (currentTeamType === 'goalie') {
                // Add Saves and Clean Sheets headers for goalie type
                const savesHeader = document.createElement('th');
                savesHeader.className = 'sortable';
                savesHeader.setAttribute('data-sort', 'saves');
                savesHeader.textContent = 'Saves';
                tableHeader.appendChild(savesHeader);
                
                const csHeader = document.createElement('th');
                csHeader.className = 'sortable';
                csHeader.setAttribute('data-sort', 'clean_sheets');
                csHeader.textContent = 'CS';
                tableHeader.appendChild(csHeader);
            }
            
            // Re-add sorting event listeners
            document.querySelectorAll('.sortable').forEach(th => {
                th.removeEventListener('click', th._sortHandler);
                th._sortHandler = () => handleSort(th.dataset.sort);
                th.addEventListener('click', th._sortHandler);
            });
        }
        
        function updatePagination() {
            console.log('updatePagination called');
            console.log('currentView:', currentView);
            console.log('filteredPlayers length:', filteredPlayers.length);
            
            // Only show pagination for players view
            const paginationContainer = document.querySelector('.pagination-container');
            if (currentView === 'teams') {
                paginationContainer.style.display = 'none';
                return;
            } else {
                paginationContainer.style.display = 'flex';
            }
            
            const totalItems = filteredPlayers.length;
            const itemType = 'players';
            const totalPages = resultsPerPage === 'all' ? 1 : Math.ceil(totalItems / resultsPerPage);
            
            // Update pagination info
            const startIndex = resultsPerPage === 'all' ? 1 : (currentPage - 1) * resultsPerPage + 1;
            const endIndex = resultsPerPage === 'all' ? totalItems : Math.min(currentPage * resultsPerPage, totalItems);
            console.log('Pagination info - startIndex:', startIndex, 'endIndex:', endIndex, 'totalItems:', totalItems);
            document.getElementById('pagination-info').textContent = `Showing ${startIndex}-${endIndex} of ${totalItems} ${itemType}`;
            
            // Update page numbers
            const pageNumbersContainer = document.getElementById('page-numbers');
            pageNumbersContainer.innerHTML = '';
            
            if (resultsPerPage !== 'all' && totalPages > 1) {
                const maxVisiblePages = 5;
                let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
                let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);
                
                if (endPage - startPage + 1 < maxVisiblePages) {
                    startPage = Math.max(1, endPage - maxVisiblePages + 1);
                }
                
                for (let i = startPage; i <= endPage; i++) {
                    const pageBtn = document.createElement('span');
                    pageBtn.className = `page-number ${i === currentPage ? 'active' : ''}`;
                    pageBtn.textContent = i;
                    pageBtn.onclick = () => goToPage(i);
                    pageNumbersContainer.appendChild(pageBtn);
                }
            }
            
            // Update navigation buttons
            document.getElementById('prev-btn').disabled = currentPage === 1 || resultsPerPage === 'all';
            document.getElementById('next-btn').disabled = currentPage === totalPages || resultsPerPage === 'all';
        }
        
        async function changePage(direction) {
            console.log('changePage called with direction:', direction);
            console.log('currentPage before:', currentPage);
            console.log('filteredPlayers length:', filteredPlayers.length);
            
            // Only allow pagination for players view
            if (currentView === 'teams') return;
            
            const totalItems = filteredPlayers.length;
            const totalPages = resultsPerPage === 'all' ? 1 : Math.ceil(totalItems / resultsPerPage);
            const newPage = currentPage + direction;
            
            console.log('totalItems:', totalItems, 'totalPages:', totalPages, 'newPage:', newPage);
            
            if (newPage >= 1 && newPage <= totalPages) {
                currentPage = newPage;
                console.log('currentPage after:', currentPage);
                await renderTable();
            } else {
                console.log('Page change rejected - newPage:', newPage, 'valid range: 1 to', totalPages);
            }
        }
        
        async function goToPage(page) {
            console.log('goToPage called with page:', page);
            console.log('currentPage before:', currentPage);
            console.log('filteredPlayers length:', filteredPlayers.length);
            
            // Only allow pagination for players view
            if (currentView === 'teams') return;
            
            const totalItems = filteredPlayers.length;
            const totalPages = resultsPerPage === 'all' ? 1 : Math.ceil(totalItems / resultsPerPage);
            console.log('totalItems:', totalItems, 'totalPages:', totalPages);
            
            if (page >= 1 && page <= totalPages) {
                currentPage = page;
                console.log('currentPage after:', currentPage);
                await renderTable();
            } else {
                console.log('Page change rejected - page:', page, 'valid range: 1 to', totalPages);
            }
        }
        
        async function changeResultsPerPage() {
            // Only allow pagination for players view
            if (currentView === 'teams') return;
            
            const newResultsPerPage = document.getElementById('results-per-page').value;
            resultsPerPage = newResultsPerPage === 'all' ? 'all' : parseInt(newResultsPerPage);
            currentPage = 1; // Reset to first page
            await renderTable();
        }
        
        function closeMatchupModal() {
            const modal = document.getElementById('matchupModal');
            const modalContent = modal.querySelector('.modal-content');
            
            // Clean up resize listener if it exists
            if (modalContent && modalContent._resizeHandler) {
                window.removeEventListener('resize', modalContent._resizeHandler);
                modalContent._resizeHandler = null;
            }
            
            modal.style.display = 'none';
        }

        function toggleFilters() {
            const filtersContainer = document.getElementById('filters-container');
            const customizeBtn = document.getElementById('customize-btn');
            const filterIcon = document.getElementById('filter-icon');
            const filterText = customizeBtn.querySelector('.filter-text');
            const isExpanded = filtersContainer.classList.contains('expanded');
            
            if (isExpanded) {
                filtersContainer.classList.remove('expanded');
                filterIcon.classList.remove('close');
                filterText.textContent = 'Customize';
            } else {
                filtersContainer.classList.add('expanded');
                filterIcon.classList.add('close');
                filterText.textContent = 'Close';
                
                // Show the appropriate filter set based on current view
                const playersFilters = document.getElementById('players-filters');
                const teamsFilters = document.getElementById('teams-filters');
                
                if (currentView === 'teams') {
                    playersFilters.style.display = 'none';
                    teamsFilters.style.display = 'block';
                } else {
                    playersFilters.style.display = 'block';
                    teamsFilters.style.display = 'none';
                }
            }
        }
        
        // Close modal when clicking outside of it
        window.onclick = function(event) {
            const modal = document.getElementById('matchupModal');
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        }

        // Search functionality
        let searchTerm = '';
        
        function handleSearch() {
            const searchInput = document.getElementById('search-input');
            searchTerm = searchInput.value.toLowerCase().trim();
            
            // Re-render the table with search filter
            renderTable();
            checkFiltersModified();
        }
        
        function filterBySearch(data) {
            if (!searchTerm) return data;
            
            return data.filter(item => {
                if (currentView === 'players') {
                    // Search in player name, team name, and team abbreviation
                    const playerName = (item.web_name || '').toLowerCase();
                    const teamName = (teamsData.find(t => t.id === item.team_id)?.name || '').toLowerCase();
                    const teamShort = (teamsData.find(t => t.id === item.team_id)?.short_name || '').toLowerCase();
                    
                    return playerName.includes(searchTerm) || 
                           teamName.includes(searchTerm) || 
                           teamShort.includes(searchTerm);
                } else {
                    // Search in team name and abbreviation
                    const teamName = (item.name || '').toLowerCase();
                    const teamShort = (item.short_name || '').toLowerCase();
                    
                    return teamName.includes(searchTerm) || 
                           teamShort.includes(searchTerm);
                }
            });
        }

                        // Initialize on page load
                document.addEventListener('DOMContentLoaded', () => {
                    initializeApp();
                                    // Ensure reset button is hidden by default
                const resetBtn = document.getElementById('reset-btn');
                if (resetBtn) {
                    resetBtn.style.display = 'none';
                }
                
                // Ensure filter button shows "Customize" by default
                const customizeBtn = document.getElementById('customize-btn');
                if (customizeBtn) {
                    const filterText = customizeBtn.querySelector('.filter-text');
                    if (filterText) {
                        filterText.textContent = 'Customize';
                    }
                }
                
                filtersModified = false;
                });

        // Comparison mode functionality
        let compareMode = false;
        
        function toggleCompareMode() {
            compareMode = !compareMode;
            const compareBtn = document.getElementById('compare-btn');
            if (compareBtn) {
                compareBtn.classList.toggle('active', compareMode);
                compareBtn.textContent = compareMode ? 'Exit Compare' : 'Compare';
            }
            renderTable();
        }
        
        function getPositionSpecificStats(position, availableColumns) {
            const stats = [];
            
            if (currentView === 'teams' || position === 'team') {
                // For teams, use all available stats
                const allTeamStats = ['goals_scored', 'assists', 'expected_goals', 'expected_assists', 'clean_sheets', 'goals_conceded', 'bonus'];
                return allTeamStats.slice(0, availableColumns);
            }
            
            // For players, use position-specific stats
            if (position === 'FWD' || position === 'MID') {
                const fwdMidStats = ['goals_scored', 'expected_goals', 'assists', 'bonus'];
                return fwdMidStats.slice(0, availableColumns);
            } else if (position === 'DEF') {
                const defStats = ['clean_sheets', 'goals_conceded', 'bonus', 'goals_scored', 'expected_goals', 'assists'];
                return defStats.slice(0, availableColumns);
            } else if (position === 'GKP') {
                const gkpStats = ['clean_sheets', 'goals_conceded', 'saves', 'bonus'];
                return gkpStats.slice(0, availableColumns);
            }
            
            return [];
        }
        
        function calculateXGDelta(player) {
            const goals = player.goals_scored || 0;
            const xg = parseFloat(player.expected_goals || 0);
            return goals - xg;
        }
        
        function getStatValue(player, stat) {
            if (stat === 'expected_goals') {
                const delta = calculateXGDelta(player);
                return {
                    value: delta,
                    color: '#000000' // Keep consistent black color
                };
            }
            return {
                value: player[stat] || 0,
                color: '#000000'
            };
        }
        
        function findStatLeader(selectedItems, stat) {
            let leader = null;
            let maxValue = -Infinity;
            
            selectedItems.forEach(item => {
                let statValue;
                
                if (currentView === 'teams') {
                    // For teams, get stats from teamStatsData
                    const teamStats = teamStatsData[currentTeamLocation]?.[item.id];
                    statValue = teamStats ? (teamStats[stat] || 0) : 0;
                } else {
                    // For players, use getStatValue function
                    const statData = getStatValue(item, stat);
                    statValue = statData.value;
                }
                
                if (statValue > maxValue) {
                    maxValue = statValue;
                    leader = item;
                }
            });
            
            return leader;
        }
        
        // Add scroll indicator for mobile
        function addScrollIndicator() {
            if (window.innerWidth <= 768) {
                const tableContainer = document.querySelector('.table-container');
                const table = document.querySelector('.player-table, .team-table');
                
                if (tableContainer && table) {
                    const isScrollable = table.scrollWidth > tableContainer.clientWidth;
                    
                    if (isScrollable) {
                        tableContainer.style.setProperty('--show-scroll-indicator', 'block');
                    } else {
                        tableContainer.style.setProperty('--show-scroll-indicator', 'none');
                    }
                }
            }
        }

        // Check scroll indicator on resize
        window.addEventListener('resize', addScrollIndicator);
        
        // Add global resize handler for responsive popups
        window.addEventListener('resize', handleViewportResize);

        // Global variable to track rank display state
        let showRanks = false;
        let showHistory = false;
        let showConditionalHighlight = true;
        let showPer90 = false;
        let showRankMode = false;

        function handleRankFilter(selectedRank) {
            console.log('handleRankFilter called with:', selectedRank);
            
            // Remove active class from all rank filter buttons
            document.querySelectorAll('.rank-filter-container .filter-btn').forEach(btn => {
                btn.classList.remove('active');
                console.log('Removed active from:', btn.dataset.rank);
            });
            
            // Add active class to the clicked button
            const clickedButton = document.querySelector(`.rank-filter-container .filter-btn[data-rank="${selectedRank}"]`);
            if (clickedButton) {
                clickedButton.classList.add('active');
                console.log('Added active to:', selectedRank);
            }
            
            // Verify only one button is active
            const activeButtons = document.querySelectorAll('.rank-filter-container .filter-btn.active');
            console.log('Active rank filter buttons after click:', activeButtons.length);
            if (activeButtons.length > 1) {
                console.error('Multiple rank filter buttons active! Fixing...');
                document.querySelectorAll('.rank-filter-container .filter-btn').forEach(btn => btn.classList.remove('active'));
                if (clickedButton) clickedButton.classList.add('active');
            }
            
            // Set the appropriate flags based on selection
            if (selectedRank === 'none') {
                showRanks = false;
                showHistory = false;
                showRankMode = false;
                showPer90 = false;
            } else if (selectedRank === 'rank') {
                showRanks = true;
                showHistory = false;
                showRankMode = true; // Convert values to ranks
                showPer90 = false;
            } else if (selectedRank === 'last') {
                showRanks = false;
                showHistory = true;
                showRankMode = false;
                showPer90 = false;
            } else if (selectedRank === 'per90') {
                showRanks = false;
                showHistory = false;
                showRankMode = false;
                showPer90 = true;
            }
            
            // Update display description
            const descriptionElement = document.getElementById('display-description');
            if (descriptionElement) {
                let description = '';
                if (selectedRank === 'rank') {
                    description = 'Converts values to player / team rankings';
                } else if (selectedRank === 'last') {
                    description = 'Shows last season\'s performance vs opponent';
                } else if (selectedRank === 'per90') {
                    description = 'Converts totals to per 90 minute rates';
                }
                
                if (description) {
                    descriptionElement.textContent = description;
                    descriptionElement.style.display = 'block';
                } else {
                    descriptionElement.style.display = 'none';
                }
            }
            
            console.log('Rank filter changed:', selectedRank, 'showRanks:', showRanks, 'showHistory:', showHistory);
            renderTable();
            checkFiltersModified();
        }





        async function loadPlayerHistoricalPoints(playerName, opponent, isHome, gameweek) {
            // Check if opponent is newly promoted (no historical data)
            const newlyPromotedTeams = ['BUR', 'LEE', 'SUN'];
            if (newlyPromotedTeams.includes(opponent)) {
                updateFixtureDisplay(gameweek, 'N/A', playerName);
                return;
            }
            
            try {
                // Find opponent team ID
                const opponentTeam = teamsData.find(t => t.short_name === opponent);
                if (!opponentTeam) {
                    console.log(`No opponent team found for: ${opponent}`);
                    updateFixtureDisplay(gameweek, 'N/A', playerName);
                    return;
                }
                
                console.log(`Fetching historical data for ${playerName} vs ${opponent} (${opponentTeam.id}) - Home: ${isHome}`);
                
                // Fetch historical data using the same endpoint as the matchup popup
                const response = await fetch(`${API_BASE_URL}/api/player-fixture-history?player_name=${encodeURIComponent(playerName)}&opponent_team_id=${opponentTeam.id}`);
                const data = await response.json();
                
                console.log('Historical data response:', data);
                
                if (data.fixtures && data.fixtures.length > 0) {
                    // Find the fixture for the specific location (home/away)
                    const locationFixture = data.fixtures.find(f => f.was_home === isHome);
                    if (locationFixture) {
                        const points = locationFixture.total_points || '0';
                        console.log(`Found fixture for ${playerName} vs ${opponent} (${isHome ? 'Home' : 'Away'}): ${points} points`);
                        updateFixtureDisplay(gameweek, points, playerName);
                    } else {
                        console.log(`No ${isHome ? 'home' : 'away'} fixture found for ${playerName} vs ${opponent}`);
                        updateFixtureDisplay(gameweek, 'N/A', playerName);
                    }
                } else {
                    console.log('No fixtures found in historical data');
                    updateFixtureDisplay(gameweek, 'N/A', playerName);
                }
            } catch (error) {
                console.error('Error fetching historical points:', error);
                updateFixtureDisplay(gameweek, 'N/A', playerName);
            }
        }

        function updateFixtureDisplay(gameweek, points, playerName) {
            // Find the specific cell for this player and gameweek
            const rows = document.querySelectorAll('#player-tbody tr');
            rows.forEach(row => {
                const playerNameCell = row.querySelector('td:first-child strong');
                if (playerNameCell && playerNameCell.textContent === playerName) {
                    const fixtureCell = row.querySelector(`[data-fixture="${gameweek}"]`);
                    if (fixtureCell) {
                        // Find the second div (the one underneath the abbreviation)
                        const resultDiv = fixtureCell.querySelector('div[style*="font-size: 0.7rem"]');
                        if (resultDiv) {
                            resultDiv.textContent = points;
                            console.log(`Updated ${playerName} GW${gameweek} to show: ${points}`);
                        }
                    }
                }
            });
        }

        async function loadTeamHistoricalResults(teamId, opponent, isHome, gameweek) {
            // Check if opponent is newly promoted (no historical data)
            const newlyPromotedTeams = ['BUR', 'LEE', 'SUN'];
            if (newlyPromotedTeams.includes(opponent)) {
                updateTeamFixtureDisplay(gameweek, 'N/A', teamId);
                return;
            }
            
            try {
                // Find opponent team ID
                const opponentTeam = teamsData.find(t => t.short_name === opponent);
                if (!opponentTeam) {
                    console.log(`No opponent team found for: ${opponent}`);
                    updateTeamFixtureDisplay(gameweek, 'N/A', teamId);
                    return;
                }
                
                console.log(`Fetching historical data for team ${teamId} vs ${opponent} (${opponentTeam.id}) - Home: ${isHome}`);
                
                // Fetch historical data
                const response = await fetch(`${API_BASE_URL}/api/team-fixture-history?team_id=${teamId}&opponent_team_id=${opponentTeam.id}&is_home=${isHome}`);
                const data = await response.json();
                
                console.log('Historical data response:', data);
                
                if (data.fixtures && data.fixtures.length > 0) {
                    // Return the match score from the most recent fixture
                    const latestFixture = data.fixtures[data.fixtures.length - 1];
                    
                    // Format the score based on home/away
                    let score;
                    if (isHome) {
                        // Our team is home, so show home_score - away_score
                        const homeScore = latestFixture.home_team_score || 0;
                        const awayScore = latestFixture.away_team_score || 0;
                        score = `${homeScore}-${awayScore}`;
                    } else {
                        // Our team is away, so show away_score - home_score
                        const homeScore = latestFixture.home_team_score || 0;
                        const awayScore = latestFixture.away_team_score || 0;
                        score = `${awayScore}-${homeScore}`;
                    }
                    
                    console.log(`Found ${data.fixtures.length} fixtures, latest score: ${score}`);
                    updateTeamFixtureDisplay(gameweek, score, teamId);
                } else {
                    console.log('No fixtures found in historical data');
                    updateTeamFixtureDisplay(gameweek, 'N/A', teamId);
                }
            } catch (error) {
                console.error('Error fetching historical results:', error);
                updateTeamFixtureDisplay(gameweek, 'N/A', teamId);
            }
        }

        function loadPlayerRankData(playerName, fixture, gameweek) {
            // Extract rank information from debug string
            const debugMatch = fixture.debug.match(/(STR|ATK|DEF)(\d+)vs(STR|ATK|DEF)(\d+)\((-?\d+)\)/);
            if (debugMatch) {
                const [_, playerMetric, playerRank, opponentMetric, opponentRank, advantage] = debugMatch;
                updatePlayerRankDisplay(gameweek, opponentRank, playerName);
            } else {
                updatePlayerRankDisplay(gameweek, 'N/A', playerName);
            }
        }

        function updatePlayerRankDisplay(gameweek, rank, playerName) {
            // Find the specific cell for this player and gameweek
            const rows = document.querySelectorAll('#player-tbody tr');
            rows.forEach(row => {
                const playerNameCell = row.querySelector('td:first-child strong');
                if (playerNameCell && playerNameCell.textContent === playerName) {
                    const fixtureCell = row.querySelector(`[data-fixture="${gameweek}"]`);
                    if (fixtureCell) {
                        // Find the second div (the one underneath the abbreviation)
                        const resultDiv = fixtureCell.querySelector('div[style*="font-size: 0.7rem"]');
                        if (resultDiv) {
                            resultDiv.textContent = rank;
                            console.log(`Updated ${playerName} GW${gameweek} to show rank: ${rank}`);
                        }
                    }
                }
            });
        }

        function loadTeamRankData(teamId, fixture, gameweek) {
            // Get the current team type to determine which rank to show
            const currentTeamType = getSelectedTeamType();
            const opponent = teamsData.find(t => t.short_name === fixture.opponent);
            
            if (opponent) {
                let rank;
                if (currentTeamType === 'attack') {
                    // Show opponent's defense rank (what we're attacking against)
                    rank = fixture.isHome ? 
                        (opponent.def_a_rank || 20) : (opponent.def_h_rank || 20);
                } else {
                    // Show opponent's attack rank (what we're defending against)
                    rank = fixture.isHome ? 
                        (opponent.atk_a_rank || 20) : (opponent.atk_h_rank || 20);
                }
                updateTeamRankDisplay(gameweek, rank.toString(), teamId);
            } else {
                updateTeamRankDisplay(gameweek, 'N/A', teamId);
            }
        }

        function updateTeamRankDisplay(gameweek, rank, teamId) {
            // Find the specific cell for this team and gameweek
            const rows = document.querySelectorAll('#team-tbody tr');
            rows.forEach(row => {
                if (row.getAttribute('data-team-id') === teamId.toString()) {
                    const fixtureCell = row.querySelector(`[data-fixture="${gameweek}"]`);
                    if (fixtureCell) {
                        // Find the second div (the one underneath the abbreviation)
                        const resultDiv = fixtureCell.querySelector('div[style*="font-size: 0.7rem"]');
                        if (resultDiv) {
                            resultDiv.textContent = rank;
                            console.log(`Updated team ${teamId} GW${gameweek} to show rank: ${rank}`);
                        }
                    }
                }
            });
        }

        function updateTeamFixtureDisplay(gameweek, result, teamId) {
            // Find the specific cell for this team and gameweek
            const rows = document.querySelectorAll('#team-tbody tr');
            rows.forEach(row => {
                if (row.getAttribute('data-team-id') === teamId.toString()) {
                    const fixtureCell = row.querySelector(`[data-fixture="${gameweek}"]`);
                    if (fixtureCell) {
                        const resultDiv = fixtureCell.querySelector('div[style*="font-size: 0.7rem"]');
                        if (resultDiv) {
                            resultDiv.textContent = result;
                            console.log(`Updated team ${teamId} GW${gameweek} to show: ${result}`);
                        }
                    }
                }
            });
        }

        async function getHistoricalPoints(teamId, opponent, isHome) {
            // Check if opponent is newly promoted (no historical data)
            const newlyPromotedTeams = ['BUR', 'LEE', 'SUN'];
            if (newlyPromotedTeams.includes(opponent)) {
                return 'N/A';
            }
            
            try {
                // Find opponent team ID
                const opponentTeam = teamsData.find(t => t.short_name === opponent);
                if (!opponentTeam) {
                    console.log(`No opponent team found for: ${opponent}`);
                    return 'N/A';
                }
                
                console.log(`Fetching historical data for team ${teamId} vs ${opponent} (${opponentTeam.id}) - Home: ${isHome}`);
                
                // Fetch historical data
                const response = await fetch(`http://localhost:5001/api/team-fixture-history?team_id=${teamId}&opponent_team_id=${opponentTeam.id}&is_home=${isHome}`);
                const data = await response.json();
                
                console.log('Historical data response:', data);
                
                if (data.fixtures && data.fixtures.length > 0) {
                    // Return the match score from the most recent fixture
                    const latestFixture = data.fixtures[data.fixtures.length - 1];
                    
                    // Format the score based on home/away
                    let score;
                    if (isHome) {
                        // Our team is home, so show home_score - away_score
                        const homeScore = latestFixture.home_team_score || 0;
                        const awayScore = latestFixture.away_team_score || 0;
                        score = `${homeScore}-${awayScore}`;
                    } else {
                        // Our team is away, so show away_score - home_score
                        const homeScore = latestFixture.home_team_score || 0;
                        const awayScore = latestFixture.away_team_score || 0;
                        score = `${awayScore}-${homeScore}`;
                    }
                    
                    console.log(`Found ${data.fixtures.length} fixtures, latest score: ${score}`);
                    return score;
                } else {
                    console.log('No fixtures found in historical data');
                    return 'N/A';
                }
            } catch (error) {
                console.error('Error fetching historical points:', error);
                return 'N/A';
            }
        }

        function toggleDifficultyLegend() {
            console.log('toggleDifficultyLegend called');
            const legend = document.getElementById('difficulty-legend');
            console.log('Legend element:', legend);
            const isVisible = legend.style.display !== 'none';
            console.log('Is visible:', isVisible);
            
            if (isVisible) {
                legend.style.display = 'none';
                console.log('Hiding legend');
                // Remove click outside listener
                document.removeEventListener('click', handleClickOutside);
            } else {
                legend.style.display = 'flex';
                console.log('Showing legend');
                
                // Position the popup to ensure it's fully visible
                positionLegendPopup();
                
                // Add click outside listener and resize listener
                setTimeout(() => {
                    document.addEventListener('click', handleClickOutside);
                    window.addEventListener('resize', handleLegendResize);
                }, 100);
            }
        }

        // Generic function to position any popup with smart boundary detection
        function positionPopupSmart(popupElement, anchorElement, options = {}) {
            if (!popupElement || !anchorElement) return;
            
            const {
                offsetX = 10,
                offsetY = 10,
                preferRight = true,
                preferBelow = true,
                maxWidth = '90vw',
                maxHeight = '80vh'
            } = options;
            
            const viewportWidth = window.innerWidth;
            const viewportHeight = window.innerHeight;
            const scrollY = window.pageYOffset || document.documentElement.scrollTop;
            
            // Get anchor position
            const anchorRect = anchorElement.getBoundingClientRect();
            
            // Set responsive constraints
            popupElement.style.maxWidth = maxWidth;
            popupElement.style.maxHeight = maxHeight;
            
            // Force reflow to get accurate dimensions
            popupElement.offsetHeight;
            
            const popupRect = popupElement.getBoundingClientRect();
            const popupWidth = popupRect.width;
            const popupHeight = popupRect.height;
            
            // Calculate available space
            const spaceRight = viewportWidth - anchorRect.right;
            const spaceLeft = anchorRect.left;
            const spaceBelow = viewportHeight - anchorRect.bottom;
            const spaceAbove = anchorRect.top;
            
            let left, top;
            
            // Determine horizontal position
            if (preferRight && spaceRight >= popupWidth + offsetX) {
                // Prefer right, enough space
                left = anchorRect.right + offsetX;
            } else if (!preferRight && spaceLeft >= popupWidth + offsetX) {
                // Prefer left, enough space
                left = anchorRect.left - popupWidth - offsetX;
            } else if (spaceRight >= popupWidth + offsetX) {
                // Fallback to right
                left = anchorRect.right + offsetX;
            } else if (spaceLeft >= popupWidth + offsetX) {
                // Fallback to left
                left = anchorRect.left - popupWidth - offsetX;
            } else {
                // Center in viewport
                left = Math.max(20, (viewportWidth - popupWidth) / 2);
            }
            
            // Determine vertical position
            if (preferBelow && spaceBelow >= popupHeight + offsetY) {
                // Prefer below, enough space
                top = anchorRect.bottom + offsetY;
            } else if (!preferBelow && spaceAbove >= popupHeight + offsetY) {
                // Prefer above, enough space
                top = anchorRect.top - popupHeight - offsetY;
            } else if (spaceBelow >= popupHeight + offsetY) {
                // Fallback to below
                top = anchorRect.bottom + offsetY;
            } else if (spaceAbove >= popupHeight + offsetY) {
                // Fallback to above
                top = anchorRect.top - popupHeight - offsetY;
            } else {
                // Center in viewport
                top = Math.max(scrollY + 20, scrollY + (viewportHeight - popupHeight) / 2);
            }
            
            // Ensure popup stays within viewport boundaries
            left = Math.max(20, Math.min(viewportWidth - popupWidth - 20, left));
            top = Math.max(scrollY + 20, Math.min(scrollY + viewportHeight - popupHeight - 20, top));
            
            // Apply positioning
            popupElement.style.position = 'fixed';
            popupElement.style.left = left + 'px';
            popupElement.style.top = (top - scrollY) + 'px';
            popupElement.style.transform = 'none';
            popupElement.style.zIndex = '9999';
            
            return { left, top: top - scrollY, popupWidth, popupHeight };
        }
        
        function positionLegendPopup() {
            const legend = document.getElementById('difficulty-legend');
            const infoButton = document.querySelector('.info-button');
            const container = document.querySelector('.info-button-container');
            
            if (!legend || !infoButton || !container) return;
            
            // Reset positioning to default
            legend.style.left = '0';
            legend.style.top = '100%';
            legend.style.transform = 'none';
            legend.style.bottom = 'auto';
            legend.style.right = 'auto';
            
            // Reset arrow positioning
            legend.style.setProperty('--arrow-top', '-8px');
            legend.style.setProperty('--arrow-bottom', 'auto');
            legend.style.setProperty('--arrow-top-after', '-9px');
            legend.style.setProperty('--arrow-bottom-after', 'auto');
            legend.style.setProperty('--arrow-left', '20px');
            legend.style.setProperty('--arrow-right', 'auto');
            
            // For large screens, use absolute positioning relative to container
            const viewportWidth = window.innerWidth;
            const containerRect = container.getBoundingClientRect();
            
            if (viewportWidth > 1200) {
                // Large screen - use absolute positioning
                legend.style.position = 'absolute';
                legend.style.left = '0';
                legend.style.top = '100%';
                legend.style.transform = 'none';
                return;
            }
            
            // Use the generic positioning function for smaller screens
            const result = positionPopupSmart(legend, container, {
                offsetX: 8,
                offsetY: 8,
                preferRight: true,
                preferBelow: true
            });
            
            if (result) {
                // Adjust arrow positioning based on where the popup was placed
                const viewportWidth = window.innerWidth;
                const containerRect = container.getBoundingClientRect();
                
                // Determine if popup is above or below
                const isAbove = result.top < containerRect.top;
                const isBelow = result.top > containerRect.bottom;
                
                if (isAbove) {
                    // Popup is above - adjust arrow
                    legend.style.setProperty('--arrow-top', 'auto');
                    legend.style.setProperty('--arrow-bottom', '-8px');
                    legend.style.setProperty('--arrow-top-after', 'auto');
                    legend.style.setProperty('--arrow-bottom-after', '-9px');
                } else if (isBelow) {
                    // Popup is below - default arrow position
                    legend.style.setProperty('--arrow-top', '-8px');
                    legend.style.setProperty('--arrow-bottom', 'auto');
                    legend.style.setProperty('--arrow-top-after', '-9px');
                    legend.style.setProperty('--arrow-bottom-after', 'auto');
                } else {
                    // Popup is centered - center arrow
                    legend.style.setProperty('--arrow-top', 'auto');
                    legend.style.setProperty('--arrow-bottom', 'auto');
                    legend.style.setProperty('--arrow-top-after', 'auto');
                    legend.style.setProperty('--arrow-bottom-after', 'auto');
                    legend.style.setProperty('--arrow-left', '50%');
                    legend.style.setProperty('--arrow-right', 'auto');
                }
                
                // Determine if popup is left or right of container
                const isRight = result.left > containerRect.right;
                const isLeft = result.left < containerRect.left;
                
                if (isRight) {
                    // Popup is to the right - align arrow to left
                    legend.style.setProperty('--arrow-left', '20px');
                    legend.style.setProperty('--arrow-right', 'auto');
                } else if (isLeft) {
                    // Popup is to the left - align arrow to right
                    legend.style.setProperty('--arrow-left', 'auto');
                    legend.style.setProperty('--arrow-right', '20px');
                } else {
                    // Popup is centered - center arrow
                    legend.style.setProperty('--arrow-left', '50%');
                    legend.style.setProperty('--arrow-right', 'auto');
                }
            }
        }

        function handleClickOutside(event) {
            const legend = document.getElementById('difficulty-legend');
            const infoButton = document.querySelector('.info-button');
            
            if (legend && !legend.contains(event.target) && !infoButton.contains(event.target)) {
                legend.style.display = 'none';
                document.removeEventListener('click', handleClickOutside);
                window.removeEventListener('resize', handleLegendResize);
            }
        }
        


        function handleLegendResize() {
            const legend = document.getElementById('difficulty-legend');
            if (legend && legend.style.display !== 'none') {
                positionLegendPopup();
            }
        }
        
        // Global resize handler for all modals and popups
        function handleViewportResize() {
            // Reposition any visible modals
            const visibleModals = document.querySelectorAll('.modal[style*="display: block"], .modal[style*="display: flex"]');
            visibleModals.forEach(modal => {
                if (modal.id === 'matchupModal') {
                    // For matchup modal, we need to reposition it
                    const event = { clientX: window.innerWidth / 2, clientY: window.innerHeight / 2 };
                    positionModalNearClick(modal, event);
                }
            });
            
            // Reposition difficulty legend if visible
            const legend = document.getElementById('difficulty-legend');
            if (legend && legend.style.display !== 'none') {
                positionLegendPopup();
            }
        }



        // Global variable to track selected positions
        let selectedPositions = [];
        
        // Global variable to track if filters have been modified
        let filtersModified = false;
        
        // Simple function to ALWAYS center the modal
        function positionModalNearClick(modalContent, event) {
            if (!modalContent) return;
            
            const viewportWidth = window.innerWidth;
            const viewportHeight = window.innerHeight;
            const scrollY = window.pageYOffset || document.documentElement.scrollTop;
            
            // Set responsive constraints first
            modalContent.style.maxWidth = '90vw';
            modalContent.style.maxWidth = 'min(90vw, 800px)';
            
            // Force reflow to get accurate dimensions
            modalContent.offsetHeight;
            
            // Get modal dimensions after constraints are applied
            const modalWidth = modalContent.offsetWidth || 600;
            const modalHeight = modalContent.offsetHeight || 400;
            
            // ALWAYS center the modal - no complex logic
            let left = Math.max(20, (viewportWidth - modalWidth) / 2);
            let top = Math.max(scrollY + 20, scrollY + (viewportHeight - modalHeight) / 2);
            

            
            // Ensure modal stays within viewport boundaries with improved constraints
            left = Math.max(20, Math.min(viewportWidth - modalWidth - 20, left));
            top = Math.max(scrollY + 20, Math.min(scrollY + viewportHeight - modalHeight - 20, top));
            
            // Additional safety check: if modal is still outside viewport, center it
            if (left < 20 || left > viewportWidth - modalWidth - 20) {
                left = Math.max(20, (viewportWidth - modalWidth) / 2);
            }
            if (top < scrollY + 20 || top > scrollY + viewportHeight - modalHeight - 20) {
                top = Math.max(scrollY + 20, scrollY + (viewportHeight - modalHeight) / 2);
            }
            
            // Apply positioning
            modalContent.style.position = 'fixed';
            modalContent.style.left = left + 'px';
            modalContent.style.top = (top - scrollY) + 'px';
            modalContent.style.transform = 'none';
            modalContent.style.zIndex = '9999';
            
            console.log('Modal positioned at:', { 
                left, 
                top: top - scrollY, 
                modalWidth, 
                modalHeight, 
                viewportWidth, 
                viewportHeight
            });
            
            // Safety check: ensure modal is visible after positioning
            setTimeout(() => {
                const rect = modalContent.getBoundingClientRect();
                const isVisible = rect.top >= 0 && rect.left >= 0 && 
                                rect.bottom <= viewportHeight && rect.right <= viewportWidth;
                
                if (!isVisible) {
                    console.log('Modal not visible, centering it');
                    modalContent.style.left = '50%';
                    modalContent.style.top = '50%';
                    modalContent.style.transform = 'translate(-50%, -50%)';
                }
            }, 10);
            
            // Add resize listener to ensure overlay covers full viewport
            const handleResize = () => {
                const modal = modalContent.closest('.modal');
                if (modal) {
                    // Ensure overlay covers the entire viewport
                    modal.style.width = '100vw';
                    modal.style.height = '100vh';
                    modal.style.left = '0';
                    modal.style.top = '0';
                }
            };
            
            window.addEventListener('resize', handleResize);
            
            // Store the handler for cleanup
            modalContent._resizeHandler = handleResize;
            

        }
        
        // Global variable to track selected location
        let selectedLocation = '';
        
        // Global variable to track team stats view
        let currentTeamStats = 'attack'; // 'attack' or 'defense'



        function getSelectedPositions() {
            const result = selectedPositions.length === 0 ? '' : selectedPositions.join(',');
            console.log('getSelectedPositions called:', { selectedPositions: [...selectedPositions], result });
            return result;
        }

        function getSelectedTeamType() {
            const activeButton = document.querySelector('.filter-btn[data-type].active');
            return activeButton ? activeButton.dataset.type : 'attack';
        }

        function getTeamBadgeUrl(teamName) {
            // Map team names to badge file names (matching exact database names)
                const teamBadgeMap = {
        'Arsenal': 'team-badges/Arsenal_badge.svg',
        'Aston Villa': 'team-badges/Aston Villa_badge.svg',
        'Bournemouth': 'team-badges/Bournemouth_badge.svg',
        'Brentford': 'team-badges/Brentford_badge.svg',
        'Brighton': 'team-badges/Brighton_badge.svg',
        'Burnley': 'team-badges/Burnley_badge.svg',
        'Chelsea': 'team-badges/Chelsea_badge.svg',
        'Crystal Palace': 'team-badges/Crystal Palace_badge.svg',
        'Everton': 'team-badges/Everton_badge.svg',
        'Fulham': 'team-badges/Fulham_badge.svg',
        'Leeds': 'team-badges/Leeds_badge.svg',
        'Liverpool': 'team-badges/Liverpool_badge.svg',
        'Man City': 'team-badges/Man City_badge.svg',
        'Man Utd': 'team-badges/Man Utd_badge.svg',
        'Newcastle': 'team-badges/Newcastle_badge.svg',
        'Nott\'m Forest': 'team-badges/Nott\'m Forest_badge.svg',
        'Spurs': 'team-badges/Spurs_badge.svg',
        'Sunderland': 'team-badges/Sunderland_badge.svg',
        'West Ham': 'team-badges/West Ham_badge.svg',
        'Wolves': 'team-badges/Wolves_badge.svg'
    };
            
            return teamBadgeMap[teamName] || null;
        }



        function getRankColorClass(rank) {
            // Convert rank (1-20) to color class (1-7)
            // Lower rank = easier (green), Higher rank = harder (red)
            if (rank <= 3) return 'difficulty-1';      // Top 3: Very Easy
            else if (rank <= 6) return 'difficulty-2';  // 4-6: Easy
            else if (rank <= 9) return 'difficulty-3';  // 7-9: Easy+
            else if (rank <= 12) return 'difficulty-4'; // 10-12: Neutral
            else if (rank <= 15) return 'difficulty-5'; // 13-15: Hard+
            else if (rank <= 18) return 'difficulty-6'; // 16-18: Hard
            else return 'difficulty-7';                 // 19-20: Very Hard
        }

        function toggleLocationFilter(button, location) {
            // Remove active class from all location buttons
            document.querySelectorAll('.location-btn').forEach(btn => btn.classList.remove('active'));
            
            // Add active class to clicked button
            button.classList.add('active');
            
            // Update selected location
            selectedLocation = location;
            
            // Reload data with new location filter
            loadData();
        }

        function getSelectedLocation() {
            return selectedLocation;
        }


    </script>
    

</body>
</html> 