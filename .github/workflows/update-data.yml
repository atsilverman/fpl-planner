name: Update FPL Data

on:
  schedule:
    - cron: '0 6 * * *'  # Daily at 6 AM UTC
  workflow_dispatch:  # Manual trigger
  push:
    branches: [main]
    paths: ['scripts/**', 'sync_fpl_data*.py']

jobs:
  update-data:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
          
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install psycopg2-binary
          
      - name: Set up PostgreSQL
        uses: Harmon758/postgresql-action@v1.0.0
        with:
          postgresql version: '14'
          postgresql db: 'postgres'
          postgresql user: 'silverman'
          postgresql password: 'password'
          
      - name: Wait for PostgreSQL
        run: |
          until pg_isready -h localhost -p 5432 -U silverman; do
            echo "Waiting for PostgreSQL..."
            sleep 2
          done
          
      - name: Create database tables
        run: |
          python create_team_stats_tables.py
          
      - name: Import CSV data
        run: |
          python import_custom_csv.py
          
      - name: Sync FPL data
        run: |
          python sync_fpl_data_simple.py
          
      - name: Export to JSON
        run: |
          python export_to_json.py
          
      - name: Check for changes
        id: check-changes
        run: |
          if git diff --quiet data/; then
            echo "no-changes=true" >> $GITHUB_OUTPUT
          else
            echo "no-changes=false" >> $GITHUB_OUTPUT
          fi
          
      - name: Commit and push changes
        if: steps.check-changes.outputs.no-changes == 'false'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add data/*.json
          git commit -m "Auto-update FPL data $(date -u +'%Y-%m-%d %H:%M UTC')"
          git push
          
      - name: Show data status
        run: |
          echo "ðŸ“Š Data export summary:"
          ls -la data/
          echo ""
          echo "ðŸ“ˆ File sizes:"
          for file in data/*.json; do
            if [ -f "$file" ]; then
              size=$(wc -c < "$file")
              echo "$(basename "$file"): ${size} bytes"
            fi
          done 